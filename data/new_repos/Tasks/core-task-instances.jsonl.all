{"repo": "home-assistant/core", "pull_number": 136998, "instance_id": "home-assistant__core-136998", "issue_numbers": ["136988", "136988"], "base_commit": "c7041a97be79def58ffc771e2e3b2702f4c8b9cd", "patch": "diff --git a/homeassistant/components/swiss_public_transport/strings.json b/homeassistant/components/swiss_public_transport/strings.json\nindex 270cb097e0a3a6..64817f89f426ea 100644\n--- a/homeassistant/components/swiss_public_transport/strings.json\n+++ b/homeassistant/components/swiss_public_transport/strings.json\n@@ -28,7 +28,7 @@\n           \"time_station\": \"Usually the departure time of a connection when it leaves the start station is tracked. Alternatively, track the time when the connection arrives at its end station.\",\n           \"time_mode\": \"Time mode lets you change the departure timing and fix it to a specific time (e.g. 7:12:00 AM every morning) or add a moving offset (e.g. +00:05:00 taking into account the time to walk to the station).\"\n         },\n-        \"description\": \"Provide start and end station for your connection,\\nand optionally up to 5 via stations.\\n\\nCheck the [stationboard]({stationboard_url}) for valid stations.\",\n+        \"description\": \"Provide start and end station for your connection,\\nand optionally up to 5 via stations.\\n\\nConsult the stationboard linked above.\",\n         \"title\": \"Swiss Public Transport\"\n       },\n       \"time_fixed\": {\n", "test_patch": "", "problem_statement": "Swiss Public Transport: Stationboard URL in error message not clickable\n### The problem\n\nWhen you provide some invalid station names in Swiss Public Transport this error banner comes up:\n\n![Image](https://github.com/user-attachments/assets/5e43c862-5850-453f-952b-4efeeb0d6051)\n\n\"Stationboard\" is supposed to be a clickable link here just like in the description right above it, but here the markup is rendered as plain text instead.\n\nThe simplest fix here might be to simply write \"Check at stationboard above \u2026\" instead as the link is already there.\n\n### What version of Home Assistant Core has the issue?\n\ncore-2025.2.0b2\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nSwiss Public Transport\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/swiss_public_transport\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n```yaml\n\n```\n\n### Anything in the logs that might be useful for us?\n\n```txt\n\n```\n\n### Additional information\n\n_No response_\nSwiss Public Transport: Stationboard URL in error message not clickable\n### The problem\n\nWhen you provide some invalid station names in Swiss Public Transport this error banner comes up:\n\n![Image](https://github.com/user-attachments/assets/5e43c862-5850-453f-952b-4efeeb0d6051)\n\n\"Stationboard\" is supposed to be a clickable link here just like in the description right above it, but here the markup is rendered as plain text instead.\n\nThe simplest fix here might be to simply write \"Check at stationboard above \u2026\" instead as the link is already there.\n\n### What version of Home Assistant Core has the issue?\n\ncore-2025.2.0b2\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nSwiss Public Transport\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/swiss_public_transport\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n```yaml\n\n```\n\n### Anything in the logs that might be useful for us?\n\n```txt\n\n```\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @fabaff, @miaucl, mind taking a look at this issue as it has been labeled with an integration (`swiss_public_transport`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1471) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `swiss_public_transport` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign swiss_public_transport` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[swiss_public_transport documentation](https://www.home-assistant.io/integrations/swiss_public_transport)\n[swiss_public_transport source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/swiss_public_transport)\n<sub><sup>(message by IssueLinks)</sup></sub>\n\nHey there @fabaff, @miaucl, mind taking a look at this issue as it has been labeled with an integration (`swiss_public_transport`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1471) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `swiss_public_transport` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign swiss_public_transport` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[swiss_public_transport documentation](https://www.home-assistant.io/integrations/swiss_public_transport)\n[swiss_public_transport source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/swiss_public_transport)\n<sub><sup>(message by IssueLinks)</sup></sub>", "created_at": "2025-01-31T12:06:46Z"}
{"repo": "home-assistant/core", "pull_number": 136982, "instance_id": "home-assistant__core-136982", "issue_numbers": ["136978", "136978"], "base_commit": "fc979cd564ee2d5fd27e05b32fa6f11b343ee4d5", "patch": "diff --git a/homeassistant/components/swiss_public_transport/icons.json b/homeassistant/components/swiss_public_transport/icons.json\nindex 06a640a06b2705..45cf4713705e63 100644\n--- a/homeassistant/components/swiss_public_transport/icons.json\n+++ b/homeassistant/components/swiss_public_transport/icons.json\n@@ -10,7 +10,7 @@\n       \"departure2\": {\n         \"default\": \"mdi:bus-clock\"\n       },\n-      \"duration\": {\n+      \"trip_duration\": {\n         \"default\": \"mdi:timeline-clock\"\n       },\n       \"transfers\": {\ndiff --git a/homeassistant/components/swiss_public_transport/sensor.py b/homeassistant/components/swiss_public_transport/sensor.py\nindex a0131938a37f9f..c8075a6746cbab 100644\n--- a/homeassistant/components/swiss_public_transport/sensor.py\n+++ b/homeassistant/components/swiss_public_transport/sensor.py\n@@ -56,8 +56,10 @@ class SwissPublicTransportSensorEntityDescription(SensorEntityDescription):\n     ],\n     SwissPublicTransportSensorEntityDescription(\n         key=\"duration\",\n+        translation_key=\"trip_duration\",\n         device_class=SensorDeviceClass.DURATION,\n         native_unit_of_measurement=UnitOfTime.SECONDS,\n+        suggested_unit_of_measurement=UnitOfTime.HOURS,\n         value_fn=lambda data_connection: data_connection[\"duration\"],\n     ),\n     SwissPublicTransportSensorEntityDescription(\ndiff --git a/homeassistant/components/swiss_public_transport/strings.json b/homeassistant/components/swiss_public_transport/strings.json\nindex ef8cc5595e3eff..270cb097e0a3a6 100644\n--- a/homeassistant/components/swiss_public_transport/strings.json\n+++ b/homeassistant/components/swiss_public_transport/strings.json\n@@ -64,8 +64,8 @@\n       \"departure2\": {\n         \"name\": \"Departure +2\"\n       },\n-      \"duration\": {\n-        \"name\": \"Duration\"\n+      \"trip_duration\": {\n+        \"name\": \"Trip duration\"\n       },\n       \"transfers\": {\n         \"name\": \"Transfers\"\n", "test_patch": "diff --git a/tests/components/swiss_public_transport/snapshots/test_sensor.ambr b/tests/components/swiss_public_transport/snapshots/test_sensor.ambr\nindex dbd689fc8f6ce3..b8ad82c7b79951 100644\n--- a/tests/components/swiss_public_transport/snapshots/test_sensor.ambr\n+++ b/tests/components/swiss_public_transport/snapshots/test_sensor.ambr\n@@ -192,7 +192,7 @@\n     'state': '2024-01-06T17:05:00+00:00',\n   })\n # ---\n-# name: test_all_entities[sensor.zurich_bern_duration-entry]\n+# name: test_all_entities[sensor.zurich_bern_line-entry]\n   EntityRegistryEntrySnapshot({\n     'aliases': set({\n     }),\n@@ -204,7 +204,7 @@\n     'disabled_by': None,\n     'domain': 'sensor',\n     'entity_category': None,\n-    'entity_id': 'sensor.zurich_bern_duration',\n+    'entity_id': 'sensor.zurich_bern_line',\n     'has_entity_name': True,\n     'hidden_by': None,\n     'icon': None,\n@@ -214,34 +214,32 @@\n     'name': None,\n     'options': dict({\n     }),\n-    'original_device_class': <SensorDeviceClass.DURATION: 'duration'>,\n+    'original_device_class': None,\n     'original_icon': None,\n-    'original_name': 'Duration',\n+    'original_name': 'Line',\n     'platform': 'swiss_public_transport',\n     'previous_unique_id': None,\n     'supported_features': 0,\n-    'translation_key': None,\n-    'unique_id': 'Z\u00fcrich Bern_duration',\n-    'unit_of_measurement': <UnitOfTime.SECONDS: 's'>,\n+    'translation_key': 'line',\n+    'unique_id': 'Z\u00fcrich Bern_line',\n+    'unit_of_measurement': None,\n   })\n # ---\n-# name: test_all_entities[sensor.zurich_bern_duration-state]\n+# name: test_all_entities[sensor.zurich_bern_line-state]\n   StateSnapshot({\n     'attributes': ReadOnlyDict({\n       'attribution': 'Data provided by transport.opendata.ch',\n-      'device_class': 'duration',\n-      'friendly_name': 'Z\u00fcrich Bern Duration',\n-      'unit_of_measurement': <UnitOfTime.SECONDS: 's'>,\n+      'friendly_name': 'Z\u00fcrich Bern Line',\n     }),\n     'context': <ANY>,\n-    'entity_id': 'sensor.zurich_bern_duration',\n+    'entity_id': 'sensor.zurich_bern_line',\n     'last_changed': <ANY>,\n     'last_reported': <ANY>,\n     'last_updated': <ANY>,\n-    'state': '10',\n+    'state': 'T10',\n   })\n # ---\n-# name: test_all_entities[sensor.zurich_bern_line-entry]\n+# name: test_all_entities[sensor.zurich_bern_platform-entry]\n   EntityRegistryEntrySnapshot({\n     'aliases': set({\n     }),\n@@ -253,7 +251,7 @@\n     'disabled_by': None,\n     'domain': 'sensor',\n     'entity_category': None,\n-    'entity_id': 'sensor.zurich_bern_line',\n+    'entity_id': 'sensor.zurich_bern_platform',\n     'has_entity_name': True,\n     'hidden_by': None,\n     'icon': None,\n@@ -265,30 +263,30 @@\n     }),\n     'original_device_class': None,\n     'original_icon': None,\n-    'original_name': 'Line',\n+    'original_name': 'Platform',\n     'platform': 'swiss_public_transport',\n     'previous_unique_id': None,\n     'supported_features': 0,\n-    'translation_key': 'line',\n-    'unique_id': 'Z\u00fcrich Bern_line',\n+    'translation_key': 'platform',\n+    'unique_id': 'Z\u00fcrich Bern_platform',\n     'unit_of_measurement': None,\n   })\n # ---\n-# name: test_all_entities[sensor.zurich_bern_line-state]\n+# name: test_all_entities[sensor.zurich_bern_platform-state]\n   StateSnapshot({\n     'attributes': ReadOnlyDict({\n       'attribution': 'Data provided by transport.opendata.ch',\n-      'friendly_name': 'Z\u00fcrich Bern Line',\n+      'friendly_name': 'Z\u00fcrich Bern Platform',\n     }),\n     'context': <ANY>,\n-    'entity_id': 'sensor.zurich_bern_line',\n+    'entity_id': 'sensor.zurich_bern_platform',\n     'last_changed': <ANY>,\n     'last_reported': <ANY>,\n     'last_updated': <ANY>,\n-    'state': 'T10',\n+    'state': '0',\n   })\n # ---\n-# name: test_all_entities[sensor.zurich_bern_platform-entry]\n+# name: test_all_entities[sensor.zurich_bern_transfers-entry]\n   EntityRegistryEntrySnapshot({\n     'aliases': set({\n     }),\n@@ -300,7 +298,7 @@\n     'disabled_by': None,\n     'domain': 'sensor',\n     'entity_category': None,\n-    'entity_id': 'sensor.zurich_bern_platform',\n+    'entity_id': 'sensor.zurich_bern_transfers',\n     'has_entity_name': True,\n     'hidden_by': None,\n     'icon': None,\n@@ -312,30 +310,30 @@\n     }),\n     'original_device_class': None,\n     'original_icon': None,\n-    'original_name': 'Platform',\n+    'original_name': 'Transfers',\n     'platform': 'swiss_public_transport',\n     'previous_unique_id': None,\n     'supported_features': 0,\n-    'translation_key': 'platform',\n-    'unique_id': 'Z\u00fcrich Bern_platform',\n+    'translation_key': 'transfers',\n+    'unique_id': 'Z\u00fcrich Bern_transfers',\n     'unit_of_measurement': None,\n   })\n # ---\n-# name: test_all_entities[sensor.zurich_bern_platform-state]\n+# name: test_all_entities[sensor.zurich_bern_transfers-state]\n   StateSnapshot({\n     'attributes': ReadOnlyDict({\n       'attribution': 'Data provided by transport.opendata.ch',\n-      'friendly_name': 'Z\u00fcrich Bern Platform',\n+      'friendly_name': 'Z\u00fcrich Bern Transfers',\n     }),\n     'context': <ANY>,\n-    'entity_id': 'sensor.zurich_bern_platform',\n+    'entity_id': 'sensor.zurich_bern_transfers',\n     'last_changed': <ANY>,\n     'last_reported': <ANY>,\n     'last_updated': <ANY>,\n     'state': '0',\n   })\n # ---\n-# name: test_all_entities[sensor.zurich_bern_transfers-entry]\n+# name: test_all_entities[sensor.zurich_bern_trip_duration-entry]\n   EntityRegistryEntrySnapshot({\n     'aliases': set({\n     }),\n@@ -347,7 +345,7 @@\n     'disabled_by': None,\n     'domain': 'sensor',\n     'entity_category': None,\n-    'entity_id': 'sensor.zurich_bern_transfers',\n+    'entity_id': 'sensor.zurich_bern_trip_duration',\n     'has_entity_name': True,\n     'hidden_by': None,\n     'icon': None,\n@@ -356,29 +354,34 @@\n     }),\n     'name': None,\n     'options': dict({\n+      'sensor.private': dict({\n+        'suggested_unit_of_measurement': <UnitOfTime.HOURS: 'h'>,\n+      }),\n     }),\n-    'original_device_class': None,\n+    'original_device_class': <SensorDeviceClass.DURATION: 'duration'>,\n     'original_icon': None,\n-    'original_name': 'Transfers',\n+    'original_name': 'Trip duration',\n     'platform': 'swiss_public_transport',\n     'previous_unique_id': None,\n     'supported_features': 0,\n-    'translation_key': 'transfers',\n-    'unique_id': 'Z\u00fcrich Bern_transfers',\n-    'unit_of_measurement': None,\n+    'translation_key': 'trip_duration',\n+    'unique_id': 'Z\u00fcrich Bern_duration',\n+    'unit_of_measurement': <UnitOfTime.HOURS: 'h'>,\n   })\n # ---\n-# name: test_all_entities[sensor.zurich_bern_transfers-state]\n+# name: test_all_entities[sensor.zurich_bern_trip_duration-state]\n   StateSnapshot({\n     'attributes': ReadOnlyDict({\n       'attribution': 'Data provided by transport.opendata.ch',\n-      'friendly_name': 'Z\u00fcrich Bern Transfers',\n+      'device_class': 'duration',\n+      'friendly_name': 'Z\u00fcrich Bern Trip duration',\n+      'unit_of_measurement': <UnitOfTime.HOURS: 'h'>,\n     }),\n     'context': <ANY>,\n-    'entity_id': 'sensor.zurich_bern_transfers',\n+    'entity_id': 'sensor.zurich_bern_trip_duration',\n     'last_changed': <ANY>,\n     'last_reported': <ANY>,\n     'last_updated': <ANY>,\n-    'state': '0',\n+    'state': '0.003',\n   })\n # ---\ndiff --git a/tests/components/swiss_public_transport/test_sensor.py b/tests/components/swiss_public_transport/test_sensor.py\nindex 4afdd88c9de2f8..6e8327282773e7 100644\n--- a/tests/components/swiss_public_transport/test_sensor.py\n+++ b/tests/components/swiss_public_transport/test_sensor.py\n@@ -83,7 +83,7 @@ async def test_fetching_data(\n         hass.states.get(\"sensor.zurich_bern_departure_2\").state\n         == \"2024-01-06T17:05:00+00:00\"\n     )\n-    assert hass.states.get(\"sensor.zurich_bern_duration\").state == \"10\"\n+    assert hass.states.get(\"sensor.zurich_bern_trip_duration\").state == \"0.003\"\n     assert hass.states.get(\"sensor.zurich_bern_platform\").state == \"0\"\n     assert hass.states.get(\"sensor.zurich_bern_transfers\").state == \"0\"\n     assert hass.states.get(\"sensor.zurich_bern_delay\").state == \"0\"\n", "problem_statement": "Swiss Public Transport: Duration field uses generic name and seconds as default unit\n### The problem\n\nThe entity \"Duration\" has a translatable friendly name defined in the strings.json of the Swiss Public Transport integration:\n\nhttps://github.com/home-assistant/core/blob/fc979cd564ee2d5fd27e05b32fa6f11b343ee4d5/homeassistant/components/swiss_public_transport/strings.json#L67-L68\n\nBut that field does not seem to get used for that name but some generic \"Duration\" field instead. \n\nIn German I have translated this field as \"Fahrzeit\" in Lokalise\n\n![Image](https://github.com/user-attachments/assets/ff44215c-2550-4386-a39a-3681ac47c9a9)\n\nbut I still see \"Dauer\" in the UI:\n\n![Image](https://github.com/user-attachments/assets/9d3c3ca8-1a91-4490-8223-261ed8307709)\n\nAll other sensors have picked up their localized names as they should.\n\n\nIn addtion it would be cool if that field used hours as the unit by default.\nAs a user I can make this change in the entity settings and it's much more useful then:\n\n![Image](https://github.com/user-attachments/assets/8f9da90b-8032-4539-b724-b531c2feda12)\n\n### What version of Home Assistant Core has the issue?\n\ncore-2025.2.0b2\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nSwiss Public Transport\n\n### Link to integration documentation on our website\n\nhttps://rc.home-assistant.io/integrations/swiss_public_transport\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n```yaml\n\n```\n\n### Anything in the logs that might be useful for us?\n\n```txt\n\n```\n\n### Additional information\n\n_No response_\nSwiss Public Transport: Duration field uses generic name and seconds as default unit\n### The problem\n\nThe entity \"Duration\" has a translatable friendly name defined in the strings.json of the Swiss Public Transport integration:\n\nhttps://github.com/home-assistant/core/blob/fc979cd564ee2d5fd27e05b32fa6f11b343ee4d5/homeassistant/components/swiss_public_transport/strings.json#L67-L68\n\nBut that field does not seem to get used for that name but some generic \"Duration\" field instead. \n\nIn German I have translated this field as \"Fahrzeit\" in Lokalise\n\n![Image](https://github.com/user-attachments/assets/ff44215c-2550-4386-a39a-3681ac47c9a9)\n\nbut I still see \"Dauer\" in the UI:\n\n![Image](https://github.com/user-attachments/assets/9d3c3ca8-1a91-4490-8223-261ed8307709)\n\nAll other sensors have picked up their localized names as they should.\n\n\nIn addtion it would be cool if that field used hours as the unit by default.\nAs a user I can make this change in the entity settings and it's much more useful then:\n\n![Image](https://github.com/user-attachments/assets/8f9da90b-8032-4539-b724-b531c2feda12)\n\n### What version of Home Assistant Core has the issue?\n\ncore-2025.2.0b2\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nSwiss Public Transport\n\n### Link to integration documentation on our website\n\nhttps://rc.home-assistant.io/integrations/swiss_public_transport\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n```yaml\n\n```\n\n### Anything in the logs that might be useful for us?\n\n```txt\n\n```\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @fabaff, @miaucl, mind taking a look at this issue as it has been labeled with an integration (`swiss_public_transport`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1471) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `swiss_public_transport` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign swiss_public_transport` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[swiss_public_transport documentation](https://www.home-assistant.io/integrations/swiss_public_transport)\n[swiss_public_transport source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/swiss_public_transport)\n<sub><sup>(message by IssueLinks)</sup></sub>\n@NoRi2909 Good spot, the translation key was missing for `Duration`. But regarding the duration measurement unit, The raw data arriving is in seconds and I do not want to opinionate and convert in home assistant, this is usually up to the user.\n\nHey there @fabaff, @miaucl, mind taking a look at this issue as it has been labeled with an integration (`swiss_public_transport`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1471) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `swiss_public_transport` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign swiss_public_transport` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[swiss_public_transport documentation](https://www.home-assistant.io/integrations/swiss_public_transport)\n[swiss_public_transport source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/swiss_public_transport)\n<sub><sup>(message by IssueLinks)</sup></sub>\n@NoRi2909 Good spot, the translation key was missing for `Duration`. But regarding the duration measurement unit, The raw data arriving is in seconds and I do not want to opinionate and convert in home assistant, this is usually up to the user.", "created_at": "2025-01-31T09:07:10Z"}
{"repo": "home-assistant/core", "pull_number": 136980, "instance_id": "home-assistant__core-136980", "issue_numbers": ["136959"], "base_commit": "fc979cd564ee2d5fd27e05b32fa6f11b343ee4d5", "patch": "diff --git a/homeassistant/components/onedrive/backup.py b/homeassistant/components/onedrive/backup.py\nindex 94d60bc6398125..7f4bd5a07383cc 100644\n--- a/homeassistant/components/onedrive/backup.py\n+++ b/homeassistant/components/onedrive/backup.py\n@@ -2,6 +2,7 @@\n \n from __future__ import annotations\n \n+import asyncio\n from collections.abc import AsyncIterator, Callable, Coroutine\n from functools import wraps\n import html\n@@ -9,7 +10,7 @@\n import logging\n from typing import Any, Concatenate, cast\n \n-from httpx import Response\n+from httpx import Response, TimeoutException\n from kiota_abstractions.api_error import APIError\n from kiota_abstractions.authentication import AnonymousAuthenticationProvider\n from kiota_abstractions.headers_collection import HeadersCollection\n@@ -42,6 +43,7 @@\n \n _LOGGER = logging.getLogger(__name__)\n UPLOAD_CHUNK_SIZE = 16 * 320 * 1024  # 5.2MB\n+MAX_RETRIES = 5\n \n \n async def async_get_backup_agents(\n@@ -96,7 +98,7 @@ async def wrapper(\n             )\n             _LOGGER.debug(\"Full error: %s\", err, exc_info=True)\n             raise BackupAgentError(\"Backup operation failed\") from err\n-        except TimeoutError as err:\n+        except TimeoutException as err:\n             _LOGGER.error(\n                 \"Error during backup in %s: Timeout\",\n                 func.__name__,\n@@ -268,6 +270,7 @@ async def async_upload(\n         start = 0\n         buffer: list[bytes] = []\n         buffer_size = 0\n+        retries = 0\n \n         async for chunk in stream:\n             buffer.append(chunk)\n@@ -279,11 +282,28 @@ async def async_upload(\n                     buffer_size > UPLOAD_CHUNK_SIZE\n                 ):  # Loop in case the buffer is >= UPLOAD_CHUNK_SIZE * 2\n                     slice_start = uploaded_chunks * UPLOAD_CHUNK_SIZE\n-                    await async_upload(\n-                        start,\n-                        start + UPLOAD_CHUNK_SIZE - 1,\n-                        chunk_data[slice_start : slice_start + UPLOAD_CHUNK_SIZE],\n-                    )\n+                    try:\n+                        await async_upload(\n+                            start,\n+                            start + UPLOAD_CHUNK_SIZE - 1,\n+                            chunk_data[slice_start : slice_start + UPLOAD_CHUNK_SIZE],\n+                        )\n+                    except APIError as err:\n+                        if (\n+                            err.response_status_code and err.response_status_code < 500\n+                        ):  # no retry on 4xx errors\n+                            raise\n+                        if retries < MAX_RETRIES:\n+                            await asyncio.sleep(2**retries)\n+                            retries += 1\n+                            continue\n+                        raise\n+                    except TimeoutException:\n+                        if retries < MAX_RETRIES:\n+                            retries += 1\n+                            continue\n+                        raise\n+                    retries = 0\n                     start += UPLOAD_CHUNK_SIZE\n                     uploaded_chunks += 1\n                     buffer_size -= UPLOAD_CHUNK_SIZE\n", "test_patch": "diff --git a/tests/components/onedrive/conftest.py b/tests/components/onedrive/conftest.py\nindex 65142217017431..649966a7828978 100644\n--- a/tests/components/onedrive/conftest.py\n+++ b/tests/components/onedrive/conftest.py\n@@ -176,3 +176,10 @@ def mock_instance_id() -> Generator[AsyncMock]:\n         return_value=\"9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0\",\n     ):\n         yield\n+\n+\n+@pytest.fixture(autouse=True)\n+def mock_asyncio_sleep() -> Generator[AsyncMock]:\n+    \"\"\"Mock asyncio.sleep.\"\"\"\n+    with patch(\"homeassistant.components.onedrive.backup.asyncio.sleep\", AsyncMock()):\n+        yield\ndiff --git a/tests/components/onedrive/test_backup.py b/tests/components/onedrive/test_backup.py\nindex 3492202d3feb08..162ecb7d92ae74 100644\n--- a/tests/components/onedrive/test_backup.py\n+++ b/tests/components/onedrive/test_backup.py\n@@ -8,8 +8,10 @@\n from json import dumps\n from unittest.mock import Mock, patch\n \n+from httpx import TimeoutException\n from kiota_abstractions.api_error import APIError\n from msgraph.generated.models.drive_item import DriveItem\n+from msgraph_core.models import LargeFileUploadSession\n import pytest\n \n from homeassistant.components.backup import DOMAIN as BACKUP_DOMAIN, AgentBackup\n@@ -255,6 +257,140 @@ async def test_broken_upload_session(\n     assert \"Failed to start backup upload\" in caplog.text\n \n \n+@pytest.mark.parametrize(\n+    \"side_effect\",\n+    [\n+        APIError(response_status_code=500),\n+        TimeoutException(\"Timeout\"),\n+    ],\n+)\n+async def test_agents_upload_errors_retried(\n+    hass_client: ClientSessionGenerator,\n+    caplog: pytest.LogCaptureFixture,\n+    mock_drive_items: MagicMock,\n+    mock_config_entry: MockConfigEntry,\n+    mock_adapter: MagicMock,\n+    side_effect: Exception,\n+) -> None:\n+    \"\"\"Test agent upload backup.\"\"\"\n+    client = await hass_client()\n+    test_backup = AgentBackup.from_dict(BACKUP_METADATA)\n+\n+    mock_adapter.send_async.side_effect = [\n+        side_effect,\n+        LargeFileUploadSession(next_expected_ranges=[\"2-\"]),\n+        LargeFileUploadSession(next_expected_ranges=[\"2-\"]),\n+    ]\n+\n+    with (\n+        patch(\n+            \"homeassistant.components.backup.manager.BackupManager.async_get_backup\",\n+        ) as fetch_backup,\n+        patch(\n+            \"homeassistant.components.backup.manager.read_backup\",\n+            return_value=test_backup,\n+        ),\n+        patch(\"pathlib.Path.open\") as mocked_open,\n+        patch(\"homeassistant.components.onedrive.backup.UPLOAD_CHUNK_SIZE\", 3),\n+    ):\n+        mocked_open.return_value.read = Mock(side_effect=[b\"test\", b\"\"])\n+        fetch_backup.return_value = test_backup\n+        resp = await client.post(\n+            f\"/api/backup/upload?agent_id={DOMAIN}.{mock_config_entry.unique_id}\",\n+            data={\"file\": StringIO(\"test\")},\n+        )\n+\n+    assert resp.status == 201\n+    assert mock_adapter.send_async.call_count == 3\n+    assert f\"Uploading backup {test_backup.backup_id}\" in caplog.text\n+    mock_drive_items.patch.assert_called_once()\n+\n+\n+async def test_agents_upload_4xx_errors_not_retried(\n+    hass_client: ClientSessionGenerator,\n+    caplog: pytest.LogCaptureFixture,\n+    mock_drive_items: MagicMock,\n+    mock_config_entry: MockConfigEntry,\n+    mock_adapter: MagicMock,\n+) -> None:\n+    \"\"\"Test agent upload backup.\"\"\"\n+    client = await hass_client()\n+    test_backup = AgentBackup.from_dict(BACKUP_METADATA)\n+\n+    mock_adapter.send_async.side_effect = APIError(response_status_code=404)\n+\n+    with (\n+        patch(\n+            \"homeassistant.components.backup.manager.BackupManager.async_get_backup\",\n+        ) as fetch_backup,\n+        patch(\n+            \"homeassistant.components.backup.manager.read_backup\",\n+            return_value=test_backup,\n+        ),\n+        patch(\"pathlib.Path.open\") as mocked_open,\n+        patch(\"homeassistant.components.onedrive.backup.UPLOAD_CHUNK_SIZE\", 3),\n+    ):\n+        mocked_open.return_value.read = Mock(side_effect=[b\"test\", b\"\"])\n+        fetch_backup.return_value = test_backup\n+        resp = await client.post(\n+            f\"/api/backup/upload?agent_id={DOMAIN}.{mock_config_entry.unique_id}\",\n+            data={\"file\": StringIO(\"test\")},\n+        )\n+\n+    assert resp.status == 201\n+    assert mock_adapter.send_async.call_count == 1\n+    assert f\"Uploading backup {test_backup.backup_id}\" in caplog.text\n+    assert mock_drive_items.patch.call_count == 0\n+    assert \"Backup operation failed\" in caplog.text\n+\n+\n+@pytest.mark.parametrize(\n+    (\"side_effect\", \"error\"),\n+    [\n+        (APIError(response_status_code=500), \"Backup operation failed\"),\n+        (TimeoutException(\"Timeout\"), \"Backup operation timed out\"),\n+    ],\n+)\n+async def test_agents_upload_fails_after_max_retries(\n+    hass_client: ClientSessionGenerator,\n+    caplog: pytest.LogCaptureFixture,\n+    mock_drive_items: MagicMock,\n+    mock_config_entry: MockConfigEntry,\n+    mock_adapter: MagicMock,\n+    side_effect: Exception,\n+    error: str,\n+) -> None:\n+    \"\"\"Test agent upload backup.\"\"\"\n+    client = await hass_client()\n+    test_backup = AgentBackup.from_dict(BACKUP_METADATA)\n+\n+    mock_adapter.send_async.side_effect = side_effect\n+\n+    with (\n+        patch(\n+            \"homeassistant.components.backup.manager.BackupManager.async_get_backup\",\n+        ) as fetch_backup,\n+        patch(\n+            \"homeassistant.components.backup.manager.read_backup\",\n+            return_value=test_backup,\n+        ),\n+        patch(\"pathlib.Path.open\") as mocked_open,\n+        patch(\"homeassistant.components.onedrive.backup.UPLOAD_CHUNK_SIZE\", 3),\n+    ):\n+        mocked_open.return_value.read = Mock(side_effect=[b\"test\", b\"\"])\n+        fetch_backup.return_value = test_backup\n+        resp = await client.post(\n+            f\"/api/backup/upload?agent_id={DOMAIN}.{mock_config_entry.unique_id}\",\n+            data={\"file\": StringIO(\"test\")},\n+        )\n+\n+    assert resp.status == 201\n+    assert mock_adapter.send_async.call_count == 6\n+    assert f\"Uploading backup {test_backup.backup_id}\" in caplog.text\n+    assert mock_drive_items.patch.call_count == 0\n+    assert error in caplog.text\n+\n+\n async def test_agents_download(\n     hass_client: ClientSessionGenerator,\n     mock_drive_items: MagicMock,\n@@ -282,7 +418,7 @@ async def test_agents_download(\n             APIError(response_status_code=500),\n             \"Backup operation failed\",\n         ),\n-        (TimeoutError(), \"Backup operation timed out\"),\n+        (TimeoutException(\"Timeout\"), \"Backup operation timed out\"),\n     ],\n )\n async def test_delete_error(\n", "problem_statement": "2025.2.0b2 One Drive Automatic backup fails\n### The problem\n\nInitiated an automatic backup One Drive failed.  Local, local network and Google Drive succeeded \nRepeated 10 minutes later same failure. I'm able to access One Drive directly on my PC  \n\n![Image](https://github.com/user-attachments/assets/2e9ccd95-ded7-4f8b-b10d-ba14c2032184)\n\n### What version of Home Assistant Core has the issue?\n\n2025.2.0b2\n\n### What was the last working version of Home Assistant Core?\n\n2025.2.0b1\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nBackup\n\n### Link to integration documentation on our website\n\n_No response_\n\n### Diagnostics information\n\n```\nLogger: homeassistant.components.backup\nSource: components/backup/manager.py:512\nintegration: Backup ([documentation](https://rc.home-assistant.io/integrations/backup), [issues](https://github.com/home-assistant/core/issues?q=is%3Aissue+is%3Aopen+label%3A%22integration%3A+backup%22))\nFirst occurred: 2:32:18 PM (1 occurrences)\nLast logged: 2:32:18 PM\n\nUnexpected error for onedrive.D378A3F5743D8717:\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.13/site-packages/httpx/_transports/default.py\", line 101, in map_httpcore_exceptions\n    yield\n  File \"/usr/local/lib/python3.13/site-packages/httpx/_transports/default.py\", line 394, in handle_async_request\n    resp = await self._pool.handle_async_request(req)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.13/site-packages/httpcore/_async/connection_pool.py\", line 256, in handle_async_request\n    raise exc from None\n  File \"/usr/local/lib/python3.13/site-packages/httpcore/_async/connection_pool.py\", line 236, in handle_async_request\n    response = await connection.handle_async_request(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        pool_request.request\n        ^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/usr/local/lib/python3.13/site-packages/httpcore/_async/connection.py\", line 103, in handle_async_request\n    return await self._connection.handle_async_request(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.13/site-packages/httpcore/_async/http11.py\", line 136, in handle_async_request\n    raise exc\n  File \"/usr/local/lib/python3.13/site-packages/httpcore/_async/http11.py\", line 106, in handle_async_request\n    ) = await self._receive_response_headers(**kwargs)\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.13/site-packages/httpcore/_async/http11.py\", line 177, in _receive_response_headers\n    event = await self._receive_event(timeout=timeout)\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.13/site-packages/httpcore/_async/http11.py\", line 217, in _receive_event\n    data = await self._network_stream.read(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        self.READ_NUM_BYTES, timeout=timeout\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/usr/local/lib/python3.13/site-packages/httpcore/_backends/anyio.py\", line 32, in read\n    with map_exceptions(exc_map):\n         ~~~~~~~~~~~~~~^^^^^^^^^\n  File \"/usr/local/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/usr/local/lib/python3.13/site-packages/httpcore/_exceptions.py\", line 14, in map_exceptions\n    raise to_exc(exc) from exc\nhttpcore.ReadTimeout\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/usr/src/homeassistant/homeassistant/components/backup/manager.py\", line 512, in upload_backup_to_agent\n    await self.backup_agents[agent_id].async_upload_backup(\n    ...<2 lines>...\n    )\n  File \"/usr/src/homeassistant/homeassistant/components/onedrive/backup.py\", line 87, in wrapper\n    return await func(self, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/src/homeassistant/homeassistant/components/onedrive/backup.py\", line 172, in async_upload_backup\n    await self._upload_file(\n        upload_session.upload_url, await open_stream(), backup.size\n    )\n  File \"/usr/src/homeassistant/homeassistant/components/onedrive/backup.py\", line 282, in _upload_file\n    await async_upload(\n    ...<3 lines>...\n    )\n  File \"/usr/src/homeassistant/homeassistant/components/onedrive/backup.py\", line 264, in async_upload\n    result = await adapter.send_async(info, LargeFileUploadSession, {})\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.13/site-packages/kiota_http/httpx_request_adapter.py\", line 186, in send_async\n    response = await self.get_http_response_message(request_info, parent_span)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.13/site-packages/kiota_http/httpx_request_adapter.py\", line 602, in get_http_response_message\n    resp = await self._http_client.send(request)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.13/site-packages/httpx/_client.py\", line 1629, in send\n    response = await self._send_handling_auth(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<4 lines>...\n    )\n    ^\n  File \"/usr/local/lib/python3.13/site-packages/httpx/_client.py\", line 1657, in _send_handling_auth\n    response = await self._send_handling_redirects(\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ...<3 lines>...\n    )\n    ^\n  File \"/usr/local/lib/python3.13/site-packages/httpx/_client.py\", line 1694, in _send_handling_redirects\n    response = await self._send_single_request(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.13/site-packages/httpx/_client.py\", line 1730, in _send_single_request\n    response = await transport.handle_async_request(request)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.13/site-packages/httpx/_transports/default.py\", line 393, in handle_async_request\n    with map_httpcore_exceptions():\n         ~~~~~~~~~~~~~~~~~~~~~~~^^\n  File \"/usr/local/lib/python3.13/contextlib.py\", line 162, in __exit__\n    self.gen.throw(value)\n    ~~~~~~~~~~~~~~^^^^^^^\n  File \"/usr/local/lib/python3.13/site-packages/httpx/_transports/default.py\", line 118, in map_httpcore_exceptions\n    raise mapped_exc(message) from exc\nhttpx.ReadTimeout\n```\n\n\n### Example YAML snippet\n\n```yaml\n\n```\n\n### Anything in the logs that might be useful for us?\n\n```txt\n\n```\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @home-assistant/core, mind taking a look at this issue as it has been labeled with an integration (`backup`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L183) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `backup` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign backup` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[backup documentation](https://www.home-assistant.io/integrations/backup)\n[backup source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/backup)\n<sub><sup>(message by IssueLinks)</sup></sub>\nJust want to chime in that I get the same error. With 2025.2.0b1 I could not connect to OneDrive. With b2 it is possible to link it.\n\n```\nLogger: homeassistant.components.onedrive.backup\nSource: components/onedrive/backup.py:91\nintegration: OneDrive (documentation, issues)\nFirst occurred: 22:08:57 (1 occurrences)\nLast logged: 22:08:57\n\nError during backup in async_upload_backup: Status 400, message None\n```\n\nAnd\n```\nLogger: homeassistant.components.backup\nSource: components/backup/manager.py:531\nintegration: Backup (documentation, issues)\nFirst occurred: 22:08:57 (1 occurrences)\nLast logged: 22:08:57\n\nUpload failed for onedrive.ea093e654287a17c: Backup operation failed\n```\n\nHmm, just checked my OneDrive and the Folders /Apps/Home Assistant/backups_slug/ are created and I even see a .tar file in the folder.\n\nThe state inside Home Assistant still says the upload failed though.\n\nTried an encrypted and unencrypted OneDrive backup. Both give the same error, and both upload the file just fine.\nJust tried the same thing again; Initiated an automated backup and the upload to One Drive succeeded. \nAppears to be an intermittent problem\n\nHey there @zweckj, mind taking a look at this issue as it has been labeled with an integration (`onedrive`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1076) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `onedrive` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign onedrive` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[onedrive documentation](https://www.home-assistant.io/integrations/onedrive)\n[onedrive source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/onedrive)\n<sub><sup>(message by IssueLinks)</sup></sub>", "created_at": "2025-01-31T08:31:24Z"}
{"repo": "home-assistant/core", "pull_number": 136949, "instance_id": "home-assistant__core-136949", "issue_numbers": ["134861"], "base_commit": "b12598d9633e16af9d2330b40db304dec13b2874", "patch": "diff --git a/homeassistant/components/home_connect/coordinator.py b/homeassistant/components/home_connect/coordinator.py\nindex 2c70d74150e35d..29bd961220ec74 100644\n--- a/homeassistant/components/home_connect/coordinator.py\n+++ b/homeassistant/components/home_connect/coordinator.py\n@@ -25,7 +25,7 @@\n     HomeConnectError,\n     HomeConnectRequestError,\n )\n-from aiohomeconnect.model.program import EnumerateAvailableProgram\n+from aiohomeconnect.model.program import EnumerateProgram\n from propcache.api import cached_property\n \n from homeassistant.config_entries import ConfigEntry\n@@ -48,7 +48,7 @@ class HomeConnectApplianceData:\n \n     events: dict[EventKey, Event] = field(default_factory=dict)\n     info: HomeAppliance\n-    programs: list[EnumerateAvailableProgram] = field(default_factory=list)\n+    programs: list[EnumerateProgram] = field(default_factory=list)\n     settings: dict[SettingKey, GetSetting]\n     status: dict[StatusKey, Status]\n \n@@ -243,9 +243,7 @@ async def _async_update_data(self) -> dict[str, HomeConnectApplianceData]:\n             ):\n                 try:\n                     appliance_data.programs.extend(\n-                        (\n-                            await self.client.get_available_programs(appliance.ha_id)\n-                        ).programs\n+                        (await self.client.get_all_programs(appliance.ha_id)).programs\n                     )\n                 except HomeConnectError as error:\n                     _LOGGER.debug(\ndiff --git a/homeassistant/components/home_connect/switch.py b/homeassistant/components/home_connect/switch.py\nindex c3a0858e0bb1b2..521252ccc2fa00 100644\n--- a/homeassistant/components/home_connect/switch.py\n+++ b/homeassistant/components/home_connect/switch.py\n@@ -5,7 +5,7 @@\n \n from aiohomeconnect.model import EventKey, ProgramKey, SettingKey\n from aiohomeconnect.model.error import HomeConnectError\n-from aiohomeconnect.model.program import EnumerateAvailableProgram\n+from aiohomeconnect.model.program import EnumerateProgram\n \n from homeassistant.components.automation import automations_with_entity\n from homeassistant.components.script import scripts_with_entity\n@@ -184,7 +184,7 @@ def __init__(\n         self,\n         coordinator: HomeConnectCoordinator,\n         appliance: HomeConnectApplianceData,\n-        program: EnumerateAvailableProgram,\n+        program: EnumerateProgram,\n     ) -> None:\n         \"\"\"Initialize the entity.\"\"\"\n         desc = \" \".join([\"Program\", program.key.split(\".\")[-1]])\n", "test_patch": "diff --git a/tests/components/home_connect/conftest.py b/tests/components/home_connect/conftest.py\nindex af039f04c03175..ae98c69d242931 100644\n--- a/tests/components/home_connect/conftest.py\n+++ b/tests/components/home_connect/conftest.py\n@@ -9,9 +9,9 @@\n \n from aiohomeconnect.client import Client as HomeConnectClient\n from aiohomeconnect.model import (\n-    ArrayOfAvailablePrograms,\n     ArrayOfEvents,\n     ArrayOfHomeAppliances,\n+    ArrayOfPrograms,\n     ArrayOfSettings,\n     ArrayOfStatus,\n     Event,\n@@ -37,9 +37,7 @@\n MOCK_APPLIANCES = ArrayOfHomeAppliances.from_dict(\n     load_json_object_fixture(\"home_connect/appliances.json\")[\"data\"]\n )\n-MOCK_PROGRAMS: dict[str, Any] = load_json_object_fixture(\n-    \"home_connect/programs-available.json\"\n-)\n+MOCK_PROGRAMS: dict[str, Any] = load_json_object_fixture(\"home_connect/programs.json\")\n MOCK_SETTINGS: dict[str, Any] = load_json_object_fixture(\"home_connect/settings.json\")\n MOCK_STATUS = ArrayOfStatus.from_dict(\n     load_json_object_fixture(\"home_connect/status.json\")[\"data\"]\n@@ -219,8 +217,8 @@ async def set_key_value_side_effect(ha_id: str, *_, **kwargs) -> None:\n     return set_key_value_side_effect\n \n \n-async def _get_available_programs_side_effect(ha_id: str) -> ArrayOfAvailablePrograms:\n-    \"\"\"Get available programs.\"\"\"\n+async def _get_all_programs_side_effect(ha_id: str) -> ArrayOfPrograms:\n+    \"\"\"Get all programs.\"\"\"\n     appliance_type = next(\n         appliance\n         for appliance in MOCK_APPLIANCES.homeappliances\n@@ -229,7 +227,7 @@ async def _get_available_programs_side_effect(ha_id: str) -> ArrayOfAvailablePro\n     if appliance_type not in MOCK_PROGRAMS:\n         raise HomeConnectApiError(\"error.key\", \"error description\")\n \n-    return ArrayOfAvailablePrograms.from_dict(MOCK_PROGRAMS[appliance_type][\"data\"])\n+    return ArrayOfPrograms.from_dict(MOCK_PROGRAMS[appliance_type][\"data\"])\n \n \n async def _get_settings_side_effect(ha_id: str) -> ArrayOfSettings:\n@@ -290,9 +288,7 @@ async def stream_all_events() -> AsyncGenerator[EventMessage]:\n     )\n     mock.get_settings = AsyncMock(side_effect=_get_settings_side_effect)\n     mock.get_status = AsyncMock(return_value=copy.deepcopy(MOCK_STATUS))\n-    mock.get_available_programs = AsyncMock(\n-        side_effect=_get_available_programs_side_effect\n-    )\n+    mock.get_all_programs = AsyncMock(side_effect=_get_all_programs_side_effect)\n     mock.put_command = AsyncMock()\n \n     mock.side_effect = mock\n@@ -323,7 +319,6 @@ async def stream_all_events() -> AsyncGenerator[EventMessage]:\n \n     mock.start_program = AsyncMock(side_effect=exception)\n     mock.stop_program = AsyncMock(side_effect=exception)\n-    mock.get_available_programs = AsyncMock(side_effect=exception)\n     mock.set_selected_program = AsyncMock(side_effect=exception)\n     mock.set_active_program_option = AsyncMock(side_effect=exception)\n     mock.set_selected_program_option = AsyncMock(side_effect=exception)\n@@ -331,7 +326,7 @@ async def stream_all_events() -> AsyncGenerator[EventMessage]:\n     mock.get_settings = AsyncMock(side_effect=exception)\n     mock.get_setting = AsyncMock(side_effect=exception)\n     mock.get_status = AsyncMock(side_effect=exception)\n-    mock.get_available_programs = AsyncMock(side_effect=exception)\n+    mock.get_all_programs = AsyncMock(side_effect=exception)\n     mock.put_command = AsyncMock(side_effect=exception)\n \n     return mock\ndiff --git a/tests/components/home_connect/fixtures/programs-available.json b/tests/components/home_connect/fixtures/programs.json\nsimilarity index 100%\nrename from tests/components/home_connect/fixtures/programs-available.json\nrename to tests/components/home_connect/fixtures/programs.json\ndiff --git a/tests/components/home_connect/test_select.py b/tests/components/home_connect/test_select.py\nindex 6ebd37266cd4ef..a0cdd15bf318db 100644\n--- a/tests/components/home_connect/test_select.py\n+++ b/tests/components/home_connect/test_select.py\n@@ -4,8 +4,8 @@\n from unittest.mock import MagicMock\n \n from aiohomeconnect.model import (\n-    ArrayOfAvailablePrograms,\n     ArrayOfEvents,\n+    ArrayOfPrograms,\n     Event,\n     EventKey,\n     EventMessage,\n@@ -13,7 +13,7 @@\n     ProgramKey,\n )\n from aiohomeconnect.model.error import HomeConnectError\n-from aiohomeconnect.model.program import EnumerateAvailableProgram\n+from aiohomeconnect.model.program import EnumerateProgram\n import pytest\n \n from homeassistant.components.select import (\n@@ -61,14 +61,14 @@ async def test_filter_unknown_programs(\n     entity_registry: er.EntityRegistry,\n ) -> None:\n     \"\"\"Test select that only known programs are shown.\"\"\"\n-    client.get_available_programs.side_effect = None\n-    client.get_available_programs.return_value = ArrayOfAvailablePrograms(\n+    client.get_all_programs.side_effect = None\n+    client.get_all_programs.return_value = ArrayOfPrograms(\n         [\n-            EnumerateAvailableProgram(\n+            EnumerateProgram(\n                 key=ProgramKey.DISHCARE_DISHWASHER_ECO_50,\n                 raw_key=ProgramKey.DISHCARE_DISHWASHER_ECO_50.value,\n             ),\n-            EnumerateAvailableProgram(\n+            EnumerateProgram(\n                 key=ProgramKey.UNKNOWN,\n                 raw_key=\"an unknown program\",\n             ),\n@@ -202,16 +202,14 @@ async def test_select_exception_handling(\n     client_with_exception: MagicMock,\n ) -> None:\n     \"\"\"Test exception handling.\"\"\"\n-    client_with_exception.get_available_programs.side_effect = None\n-    client_with_exception.get_available_programs.return_value = (\n-        ArrayOfAvailablePrograms(\n-            [\n-                EnumerateAvailableProgram(\n-                    key=ProgramKey.DISHCARE_DISHWASHER_ECO_50,\n-                    raw_key=ProgramKey.DISHCARE_DISHWASHER_ECO_50.value,\n-                )\n-            ]\n-        )\n+    client_with_exception.get_all_programs.side_effect = None\n+    client_with_exception.get_all_programs.return_value = ArrayOfPrograms(\n+        [\n+            EnumerateProgram(\n+                key=ProgramKey.DISHCARE_DISHWASHER_ECO_50,\n+                raw_key=ProgramKey.DISHCARE_DISHWASHER_ECO_50.value,\n+            )\n+        ]\n     )\n \n     assert config_entry.state is ConfigEntryState.NOT_LOADED\ndiff --git a/tests/components/home_connect/test_switch.py b/tests/components/home_connect/test_switch.py\nindex 10d393423be831..4d6b59eddd9983 100644\n--- a/tests/components/home_connect/test_switch.py\n+++ b/tests/components/home_connect/test_switch.py\n@@ -15,10 +15,7 @@\n )\n from aiohomeconnect.model.error import HomeConnectError\n from aiohomeconnect.model.event import ArrayOfEvents, EventType\n-from aiohomeconnect.model.program import (\n-    ArrayOfAvailablePrograms,\n-    EnumerateAvailableProgram,\n-)\n+from aiohomeconnect.model.program import ArrayOfPrograms, EnumerateProgram\n from aiohomeconnect.model.setting import SettingConstraints\n import pytest\n \n@@ -250,16 +247,14 @@ async def test_switch_exception_handling(\n     client_with_exception: MagicMock,\n ) -> None:\n     \"\"\"Test exception handling.\"\"\"\n-    client_with_exception.get_available_programs.side_effect = None\n-    client_with_exception.get_available_programs.return_value = (\n-        ArrayOfAvailablePrograms(\n-            [\n-                EnumerateAvailableProgram(\n-                    key=ProgramKey.DISHCARE_DISHWASHER_ECO_50,\n-                    raw_key=ProgramKey.DISHCARE_DISHWASHER_ECO_50.value,\n-                )\n-            ]\n-        )\n+    client_with_exception.get_all_programs.side_effect = None\n+    client_with_exception.get_all_programs.return_value = ArrayOfPrograms(\n+        [\n+            EnumerateProgram(\n+                key=ProgramKey.DISHCARE_DISHWASHER_ECO_50,\n+                raw_key=ProgramKey.DISHCARE_DISHWASHER_ECO_50.value,\n+            )\n+        ]\n     )\n     client_with_exception.get_settings.side_effect = None\n     client_with_exception.get_settings.return_value = ArrayOfSettings(\n", "problem_statement": "If the integration is reloaded while running a program, the running program is the only program available at select entities\n### The problem\n\nAfter the upgrade to 2025.1 at first I could see the program selected on the dishwasher in \"selected program\"\r\nI did some test where I selected pre_rinse at the dishwasher and copied the value of the \"selected program\" to \"Active program\" in an automation. Pre rinse on the machine started.\r\nSince then only pre_rinse is available in home connect. It doesn't show the program selected on the dishwasher anymore.\r\nExecuting the automation:\r\n\r\n\r\naction: select.select_option\r\ndata:\r\n  option: dishcare_dishwasher_program_auto3\r\ntarget:\r\n  entity_id: select.dishwasher_active_program\r\n\r\ngives:\r\n\r\n> Error running action\r\n\r\nOption dishcare_dishwasher_program_auto3 is not valid for entity select.dishwasher_active_program, valid options are: dishcare_dishwasher_program_pre_rinse\n\n### What version of Home Assistant Core has the issue?\n\ncore-2025.1.0\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nHome Connect\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/home_connect/\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n```yaml\naction: select.select_option\r\ndata:\r\n  option: dishcare_dishwasher_program_auto3\r\ntarget:\r\n  entity_id: select.dishwasher_active_program\n```\n\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @davidmstraub, @diegorro98, mind taking a look at this issue as it has been labeled with an integration (`home_connect`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L626) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `home_connect` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign home_connect` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[home_connect documentation](https://www.home-assistant.io/integrations/home_connect)\n[home_connect source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/home_connect)\n<sub><sup>(message by IssueLinks)</sup></sub>\nHi!\r\nIf I understand correctly, your problem is that after starting the \"pre-rinse\" program, then only \"pre-rinse\" is available, right?\r\nDo you know if the integration was reloaded or Home Assistant was restarted while the dishwasher was running the program?\nYes, pre-rinse was started by copying from  \"selected program\" to \"active program\".\r\nI can't recall if home-assistant was restarted while running the program. I didn't let the program finish though.\r\nIt was restarted a few times later.\r\nStrange just did a restart and it sees all the programs.\r\nCan it be that when home assistant is restarted with the dishwasher powered, but not on home assistant only knows the last program.\r\nSo for home assistant to see all programs the dishwasher needs be switched on when home assistant is restarted.\r\n\nSome more testing.\r\nThe dishwasher defaults to eco. That is not visible in \"selected programs\". It seems selected programs is only filled when I change from the default value when switching on the dishwasher. So switching to auto3 is visible. When switching back to eco also is visible. So making eco work I have to select another program and than eco.\nOkey, so these are to dev-known problems:\r\n\r\n- If the appliance (in your case, the diswasher) is running a program while Home Assistant is restarting or the integration is being reload, the only program available is the program that is currently running.\r\n  Why does this happen? API does return that, maybe it does make sense because we ask to the API what are the available programs, and it is kind of logical that the only program available while the program is running is the program that is currently running\r\n  I would like to fix that once we have changed the library we depend-on right now, which is in the current works\r\n\r\n- Currently we don't fetch which program is selected at the start, we let the API notify us about that. We can ask that to the API at the start, sure, but after the library change\n@home-assistant rename If the integration is reloaded while running a program, the running program is the only program available at select entities", "created_at": "2025-01-30T19:46:06Z"}
{"repo": "home-assistant/core", "pull_number": 136942, "instance_id": "home-assistant__core-136942", "issue_numbers": ["136864"], "base_commit": "cf737356fd33bd25bb286b54cb8284eb7f0c9759", "patch": "diff --git a/homeassistant/package_constraints.txt b/homeassistant/package_constraints.txt\nindex a15e1bb61be8e7..891d91e134bedc 100644\n--- a/homeassistant/package_constraints.txt\n+++ b/homeassistant/package_constraints.txt\n@@ -4,7 +4,7 @@ aiodhcpwatcher==1.0.2\n aiodiscover==2.1.0\n aiodns==3.2.0\n aiohasupervisor==0.2.2b6\n-aiohttp-asyncmdnsresolver==0.0.1\n+aiohttp-asyncmdnsresolver==0.0.2\n aiohttp-fast-zlib==0.2.0\n aiohttp==3.11.11\n aiohttp_cors==0.7.0\ndiff --git a/pyproject.toml b/pyproject.toml\nindex edc039286d7192..74e3d51a222fe7 100644\n--- a/pyproject.toml\n+++ b/pyproject.toml\n@@ -31,7 +31,7 @@ dependencies    = [\n     \"aiohttp==3.11.11\",\n     \"aiohttp_cors==0.7.0\",\n     \"aiohttp-fast-zlib==0.2.0\",\n-    \"aiohttp-asyncmdnsresolver==0.0.1\",\n+    \"aiohttp-asyncmdnsresolver==0.0.2\",\n     \"aiozoneinfo==0.2.1\",\n     \"astral==2.2\",\n     \"async-interrupt==1.2.0\",\ndiff --git a/requirements.txt b/requirements.txt\nindex 412252a08462e2..77fd3887db4143 100644\n--- a/requirements.txt\n+++ b/requirements.txt\n@@ -8,7 +8,7 @@ aiohasupervisor==0.2.2b6\n aiohttp==3.11.11\n aiohttp_cors==0.7.0\n aiohttp-fast-zlib==0.2.0\n-aiohttp-asyncmdnsresolver==0.0.1\n+aiohttp-asyncmdnsresolver==0.0.2\n aiozoneinfo==0.2.1\n astral==2.2\n async-interrupt==1.2.0\n", "test_patch": "", "problem_statement": "Connection failed: MDNS lookup failed: SMLight\n### The problem\n\nhello!\n\nUpon updating to 2025.2.0b0, i noticed thes logs and my SMLite integration entities are unavailable.\n\nZ2M and directly connecting to the adapter are working normally, just the integration is failing. Rebooting the adapter, restores the entities, but after a few minutes, they go back to being unavailable.\n\n~~might be related to [this](https://github.com/home-assistant/core/issues/135870).~~\n\nthanks\n\nSLZB-06 by SMLIGHT\nFirmware: core: v2.7.1 / zigbee: 20240710\n\n```\nLogger: homeassistant.components.smlight\nSource: helpers/update_coordinator.py:405\nintegration: SMLIGHT SLZB (documentation, issues)\nFirst occurred: 11:10:47 AM (2 occurrences)\nLast logged: 11:24:53 AM\n\nError fetching smlight_SLZB-06.local data: Connection failed\n```\n\n```\nLogger: homeassistant.components.smlight\nSource: helpers/update_coordinator.py:312\nintegration: SMLIGHT SLZB (documentation, issues)\nFirst occurred: 11:15:30 AM (6 occurrences)\nLast logged: 11:18:32 AM\n\nUnexpected error fetching smlight_SLZB-06.local data\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/connector.py\", line 1351, in _create_direct_connection\n    hosts = await self._resolve_host(host, port, traces=traces)\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/connector.py\", line 995, in _resolve_host\n    return await asyncio.shield(resolved_host_task)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/connector.py\", line 1026, in _resolve_host_with_throttle\n    addrs = await self._resolver.resolve(host, port, family=self._family)\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp_asyncmdnsresolver/_impl.py\", line 94, in resolve\n    return await self._resolve_mdns(host, port, family)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp_asyncmdnsresolver/_impl.py\", line 116, in _resolve_mdns\n    raise OSError(None, \"MDNS lookup failed\")\nOSError: [Errno None] MDNS lookup failed\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.13/site-packages/pysmlight/web.py\", line 55, in check_auth_needed\n    async with self.session.get(self.url, auth=auth, params=params) as response:\n               ~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/client.py\", line 1425, in __aenter__\n    self._resp: _RetType = await self._coro\n                           ^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/client.py\", line 703, in _request\n    conn = await self._connector.connect(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        req, traces=traces, timeout=real_timeout\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/connector.py\", line 548, in connect\n    proto = await self._create_connection(req, traces, timeout)\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/connector.py\", line 1056, in _create_connection\n    _, proto = await self._create_direct_connection(req, traces, timeout)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/connector.py\", line 1357, in _create_direct_connection\n    raise ClientConnectorDNSError(req.connection_key, exc) from exc\naiohttp.client_exceptions.ClientConnectorDNSError: Cannot connect to host slzb-06.local:80 ssl:default [MDNS lookup failed]\n\nDuring handling of the above exception, another exception occurred:\n\nTraceback (most recent call last):\n  File \"/usr/src/homeassistant/homeassistant/helpers/update_coordinator.py\", line 312, in __wrap_async_setup\n    await self._async_setup()\n  File \"/usr/src/homeassistant/homeassistant/components/smlight/coordinator.py\", line 65, in _async_setup\n    if await self.client.check_auth_needed():\n       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.13/site-packages/pysmlight/web.py\", line 62, in check_auth_needed\n    raise SmlightConnectionError(\"Connection failed\")\npysmlight.exceptions.SmlightConnectionError: Connection failed\n```\n\n### What version of Home Assistant Core has the issue?\n\n2025.2.0b0\n\n### What was the last working version of Home Assistant Core?\n\n2025.1.x\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nSMLight\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/smlight/\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n```yaml\n\n```\n\n### Anything in the logs that might be useful for us?\n\n```txt\n\n```\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @tl-sl, mind taking a look at this issue as it has been labeled with an integration (`smlight`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1402) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `smlight` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign smlight` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[smlight documentation](https://www.home-assistant.io/integrations/smlight)\n[smlight source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/smlight)\n<sub><sup>(message by IssueLinks)</sup></sub>\nCertainly! Let\u2019s go into more detail on each step to help you fully troubleshoot and resolve the issue with the SMLIGHT SLZB integration in Home Assistant.\n\n---\n\n## 1. **Check Network Configuration**\n   - **Why This Matters**: MDNS (Multicast DNS) relies on devices being on the same network and subnet to resolve `.local` hostnames. If the devices are on different networks or VLANs, MDNS will fail.\n   - **Steps**:\n     1. Verify that both your Home Assistant instance and the SLZB-06 device are connected to the same Wi-Fi or Ethernet network.\n     2. If you are using VLANs or a segmented network, ensure that MDNS traffic is allowed between these segments. You may need to enable \"MDNS forwarding\" or \"Bonjour forwarding\" in your router or network configuration.\n     3. Test connectivity by pinging `slzb-06.local` from a computer or device on the same network. If the ping fails, it confirms an MDNS resolution issue.\n\n---\n\n## 2. **Use Static IP**\n   - **Why This Matters**: Relying on `.local` hostnames can be unreliable in some network setups, especially if MDNS is not properly supported by your router or network configuration.\n   - **Steps**:\n     1. Assign a static IP address to the SLZB-06 device via your router\u2019s DHCP settings.\n        - Log in to your router's admin interface.\n        - Locate the SLZB-06 device in the list of connected devices.\n        - Assign a reserved/static IP address (e.g., `192.168.1.100`).\n     2. Update the Home Assistant configuration for the SMLIGHT integration:\n        - Open Home Assistant and navigate to **Settings > Devices & Services > SMLIGHT SLZB**.\n        - Edit the configuration to replace `slzb-06.local` with the static IP address you assigned (e.g., `http://192.168.1.100`).\n     3. Restart Home Assistant to apply changes.\n\n---\n\n## 3. **Update Firmware**\n   - **Why This Matters**: The SLZB-06 device might have bugs in its firmware that are causing connection issues, especially if it\u2019s running an older version.\n   - **Steps**:\n     1. Access the SLZB-06 web interface:\n        - Open a browser and navigate to `http://slzb-06.local` (or use its IP address if `.local` doesn\u2019t work).\n     2. Log in using the device credentials (check the manual for default credentials if you haven\u2019t changed them).\n     3. Check for firmware updates:\n        - Look for an option like \"Firmware Update\" or \"Check for Updates.\"\n        - If an update is available, follow the instructions to install it.\n     4. After updating, restart both the SLZB-06 device and Home Assistant.\n\n---\n\n## 4. **Firewall Rules**\n   - **Why This Matters**: Firewalls can block communication between devices or prevent necessary traffic for MDNS or other protocols from passing through.\n   - **Steps**:\n     1. Check your firewall settings on your router or any software firewalls running on your network.\n     2. Ensure that ports required by MDNS (UDP port 5353) are open and not being blocked.\n     3. If you\u2019re using advanced firewall rules, allow traffic between Home Assistant and the SLZB-06 device explicitly.\n     4. If you\u2019re behind a corporate firewall or restrictive ISP settings, ensure that external communication is allowed for firmware updates or other cloud-based services.\n\n---\n\n## 5. **Switch to Alternative Zigbee Integrations**\n   - **Why This Matters**: While SMLIGHT provides its own integration, alternatives like Zigbee2MQTT or ZHA (Zigbee Home Automation) are often more stable, feature-rich, and better supported by the community.\n   - **Steps for Zigbee2MQTT**:\n     1. Install Zigbee2MQTT on your Home Assistant instance (you may need an MQTT broker like Mosquitto).\n     2. Pair your Zigbee devices with Zigbee2MQTT instead of relying on SMLIGHT\u2019s native integration.\n     3. Follow documentation for setting up Zigbee2MQTT with your specific Zigbee coordinator hardware.\n   - **Steps for ZHA**:\n     1. Check if your SLZB-06 device is supported by ZHA.\n     2. Remove the SMLIGHT integration from Home Assistant.\n     3. Add ZHA via **Settings > Devices & Services > Add Integration**, and follow pairing instructions.\n\n---\n\n## 6. **Enable Debugging**\n   - **Why This Matters**: Debug logs can provide more detailed information about what\u2019s causing connectivity issues, helping you pinpoint specific problems with MDNS resolution or communication failures.\n   - **Steps**:\n     1. Add debug logging for `homeassistant.components.smlight` in your `configuration.yaml` file:\n        ```yaml\n        logger:\n          default: warning\n          logs:\n            homeassistant.components.smlight: debug\n            pysmlight.web: debug\n        ```\n     2. Restart Home Assistant to apply changes.\n     3. Monitor logs via **Settings > System > Logs**, or check `home-assistant.log` in your file system.\n     4. Look for additional clues about why MDNS is failing or why connections are timing out.\n\n---\n\n## Additional Notes\nIf none of these steps resolve your issue, consider reaching out to:\n1. The [SMLIGHT GitHub repository](https://github.com/smlight) to report a bug or ask for help from developers and other users.\n2. The [Home Assistant Community Forums](https://community.home-assistant.io/) for advice from other users who may have encountered similar issues.\n\nBy following these steps carefully, you should be able to resolve connectivity issues with your SMLIGHT SLZB integration in Home Assistant! \nthanks, ok. Here's what I have for you:\n\nStep 1: all good here, I can acess the adapter via local LAN to `slzb-06.local` and it loads up no problem\nStep 2: It set to static\nStep 3: All up to date\nStep 4: No changes to firewall, just HA core updated to 2025.2.0b0 from 2025.1.4 \nStep 5: Using Z2M\n\nWill get you logs on Step 6 on my next post. But here is another log I missed in the HA Core logs (Different from above):\n\n```\nLogger: homeassistant.helpers.entity\nSource: helpers/entity.py:960\nFirst occurred: 11:34:54 AM (2 occurrences)\nLast logged: 11:49:54 AM\n\nUpdate for binary_sensor.slzb_06_internet fails\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/connector.py\", line 1351, in _create_direct_connection\n    hosts = await self._resolve_host(host, port, traces=traces)\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/connector.py\", line 995, in _resolve_host\n    return await asyncio.shield(resolved_host_task)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/connector.py\", line 1026, in _resolve_host_with_throttle\n    addrs = await self._resolver.resolve(host, port, family=self._family)\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp_asyncmdnsresolver/_impl.py\", line 94, in resolve\n    return await self._resolve_mdns(host, port, family)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp_asyncmdnsresolver/_impl.py\", line 116, in _resolve_mdns\n    raise OSError(None, \"MDNS lookup failed\")\nOSError: [Errno None] MDNS lookup failed\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.13/site-packages/pysmlight/web.py\", line 73, in get\n    async with self.session.get(\n               ~~~~~~~~~~~~~~~~^\n        url, headers=self.headers, params=params, auth=self.auth\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ) as response:\n    ^\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/client.py\", line 1425, in __aenter__\n    self._resp: _RetType = await self._coro\n                           ^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/client.py\", line 703, in _request\n    conn = await self._connector.connect(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        req, traces=traces, timeout=real_timeout\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/connector.py\", line 548, in connect\n    proto = await self._create_connection(req, traces, timeout)\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/connector.py\", line 1056, in _create_connection\n    _, proto = await self._create_direct_connection(req, traces, timeout)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/connector.py\", line 1357, in _create_direct_connection\n    raise ClientConnectorDNSError(req.connection_key, exc) from exc\naiohttp.client_exceptions.ClientConnectorDNSError: Cannot connect to host slzb-06.local:80 ssl:default [MDNS lookup failed]\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 960, in async_update_ha_state\n    await self.async_device_update()\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 1318, in async_device_update\n    await self.async_update()\n  File \"/usr/src/homeassistant/homeassistant/components/smlight/binary_sensor.py\", line 141, in async_update\n    await self.coordinator.client.get_param(\"inetState\")\n  File \"/usr/local/lib/python3.13/site-packages/pysmlight/web.py\", line 228, in get_param\n    return await self.get(params)\n           ^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.13/site-packages/pysmlight/web.py\", line 89, in get\n    raise SmlightConnectionError(\"Connection failed\") from err\npysmlight.exceptions.SmlightConnectionError: Connection failed\n```\nRegarding Step 6, after adding this to my configuration.yaml\n\n```\nlogger:\n  default: warning\n  logs:\n    homeassistant.components.smlight: debug\n    pysmlight.web: debug\n```\n\nand rebooting Home Assistant, the adapter and integration are working well, but after a few minutes, it fails and goes unavaiable. The are the logs associated with SMLite during this time.\n\n```\n2025-01-29 12:13:23.074 DEBUG (MainThread) [homeassistant.components.smlight] Finished fetching smlight_SLZB-06.local data in 0.246 seconds (success: True)\n2025-01-29 12:13:24.586 DEBUG (MainThread) [homeassistant.components.smlight] Finished fetching smlight_SLZB-06.local data in 1.417 seconds (success: True)\n2025-01-29 12:18:31.713 ERROR (MainThread) [homeassistant.components.smlight] Error fetching smlight_SLZB-06.local data: Connection failed\n2025-01-29 12:18:31.713 DEBUG (MainThread) [homeassistant.components.smlight] Finished fetching smlight_SLZB-06.local data in 5.001 seconds (success: False)\n2025-01-29 12:23:36.713 DEBUG (MainThread) [homeassistant.components.smlight] Finished fetching smlight_SLZB-06.local data in 5.000 seconds (success: False)\n2025-01-29 12:28:31.807 ERROR (MainThread) [homeassistant.helpers.entity] Update for binary_sensor.slzb_06_internet fails\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/connector.py\", line 1351, in _create_direct_connection\n    hosts = await self._resolve_host(host, port, traces=traces)\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/connector.py\", line 995, in _resolve_host\n    return await asyncio.shield(resolved_host_task)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/connector.py\", line 1026, in _resolve_host_with_throttle\n    addrs = await self._resolver.resolve(host, port, family=self._family)\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp_asyncmdnsresolver/_impl.py\", line 94, in resolve\n    return await self._resolve_mdns(host, port, family)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp_asyncmdnsresolver/_impl.py\", line 116, in _resolve_mdns\n    raise OSError(None, \"MDNS lookup failed\")\nOSError: [Errno None] MDNS lookup failed\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/usr/local/lib/python3.13/site-packages/pysmlight/web.py\", line 73, in get\n    async with self.session.get(\n               ~~~~~~~~~~~~~~~~^\n        url, headers=self.headers, params=params, auth=self.auth\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    ) as response:\n    ^\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/client.py\", line 1425, in __aenter__\n    self._resp: _RetType = await self._coro\n                           ^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/client.py\", line 703, in _request\n    conn = await self._connector.connect(\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        req, traces=traces, timeout=real_timeout\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/connector.py\", line 548, in connect\n    proto = await self._create_connection(req, traces, timeout)\n            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/connector.py\", line 1056, in _create_connection\n    _, proto = await self._create_direct_connection(req, traces, timeout)\n               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.13/site-packages/aiohttp/connector.py\", line 1357, in _create_direct_connection\n    raise ClientConnectorDNSError(req.connection_key, exc) from exc\naiohttp.client_exceptions.ClientConnectorDNSError: Cannot connect to host slzb-06.local:80 ssl:default [MDNS lookup failed]\n\nThe above exception was the direct cause of the following exception:\n\nTraceback (most recent call last):\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 960, in async_update_ha_state\n    await self.async_device_update()\n  File \"/usr/src/homeassistant/homeassistant/helpers/entity.py\", line 1318, in async_device_update\n    await self.async_update()\n  File \"/usr/src/homeassistant/homeassistant/components/smlight/binary_sensor.py\", line 141, in async_update\n    await self.coordinator.client.get_param(\"inetState\")\n  File \"/usr/local/lib/python3.13/site-packages/pysmlight/web.py\", line 228, in get_param\n    return await self.get(params)\n           ^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/local/lib/python3.13/site-packages/pysmlight/web.py\", line 89, in get\n    raise SmlightConnectionError(\"Connection failed\") from err\npysmlight.exceptions.SmlightConnectionError: Connection failed\n2025-01-29 12:28:41.714 DEBUG (MainThread) [homeassistant.components.smlight] Finished fetching smlight_SLZB-06.local data in 5.001 seconds (success: False)\n```\n\nDuring this time, i can easily login to the adapter via chrome broswer to `slzb-06.local`\n\nAlso, it does work for the first minutes from rebooting HA.\nthanks\nCan confirm this. When removing and re-adding the config entry it works for some time. @bdraco can this relate to the changes made to mDNS caching?\nIt does look like it. \n\nGoing to need debug logs for `zeroconf` to see why it can't lookup the name.\nAlso strange in the log its `smlight_SLZB-06.local` but above `slzb-06.local:80`\n\nWhich one is the correct name, and which one is it actually trying to connect to ?\nService call to turn on `zeroconf` logging\n\n```yaml\naction: logger.set_level\ndata:\n  zeroconf: debug\n```\nThe `smlight_` comes from the coordinator name:\n\nhttps://github.com/home-assistant/core/blob/aca9607e2fb7b35d62c1179ce79a3d484a6a0437/homeassistant/components/smlight/coordinator.py#L52-L56\n\nWill turn on `zeroconf` debug log\nAfter seeing the `Ignoring duplicate message with no unicast questions received from` for `slzb-06.local` the integration stopped working.  \n\n[home-assistant.zeroconf.log](https://github.com/user-attachments/files/18594220/home-assistant.zeroconf.log)\n```\n2025-01-29 22:20:20.018 DEBUG (MainThread) [zeroconf] Sending to (224.0.0.251, 5353) via [socket 15 (('10.12.0.8', 5353))] (49 bytes #1) <DNSOutgoing:multicast=True, flags=0, questions=[srv[question,QM,in,slzb-06.local.], txt[question,QM,in,slzb-06.local.], a[question,QM,in,slzb-06.local.], quada[question,QM,in,slzb-06.local.]], answers=[], authorities=[], additionals=[]> as b'\\x00\\x00\\x00\\x00\\x00\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x07slzb-06\\x05local\\x00\\x00!\\x00\\x01\\xc0\\x0c\\x00\\x10\\x00\\x01\\xc0\\x0c\\x00\\x01\\x00\\x01\\xc0\\x0c\\x00\\x1c\\x00\\x01'...\n2025-01-29 22:20:20.019 DEBUG (MainThread) [zeroconf] Sending to (224.0.0.251, 5353) via [socket 17 (('10.12.2.3', 5353))] (49 bytes #1) <DNSOutgoing:multicast=True, flags=0, questions=[srv[question,QM,in,slzb-06.local.], txt[question,QM,in,slzb-06.local.], a[question,QM,in,slzb-06.local.], quada[question,QM,in,slzb-06.local.]], answers=[], authorities=[], additionals=[]> as b'\\x00\\x00\\x00\\x00\\x00\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x07slzb-06\\x05local\\x00\\x00!\\x00\\x01\\xc0\\x0c\\x00\\x10\\x00\\x01\\xc0\\x0c\\x00\\x01\\x00\\x01\\xc0\\x0c\\x00\\x1c\\x00\\x01'...\n2025-01-29 22:20:20.020 DEBUG (MainThread) [zeroconf] Sending to (ff02::fb, 5353) via [socket 19 (('fd64:5c16:1a1a:0:a699:a615:972:6e24', 5353, 0, 0))] (49 bytes #1) <DNSOutgoing:multicast=True, flags=0, questions=[srv[question,QM,in,slzb-06.local.], txt[question,QM,in,slzb-06.local.], a[question,QM,in,slzb-06.local.], quada[question,QM,in,slzb-06.local.]], answers=[], authorities=[], additionals=[]> as b'\\x00\\x00\\x00\\x00\\x00\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x07slzb-06\\x05local\\x00\\x00!\\x00\\x01\\xc0\\x0c\\x00\\x10\\x00\\x01\\xc0\\x0c\\x00\\x01\\x00\\x01\\xc0\\x0c\\x00\\x1c\\x00\\x01'...\n2025-01-29 22:20:20.021 DEBUG (MainThread) [zeroconf] Sending to (ff02::fb, 5353) via [socket 20 (('fd64:5c16:1a1a:2:afd6:ee5f:30cb:1e13', 5353, 0, 0))] (49 bytes #1) <DNSOutgoing:multicast=True, flags=0, questions=[srv[question,QM,in,slzb-06.local.], txt[question,QM,in,slzb-06.local.], a[question,QM,in,slzb-06.local.], quada[question,QM,in,slzb-06.local.]], answers=[], authorities=[], additionals=[]> as b'\\x00\\x00\\x00\\x00\\x00\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x07slzb-06\\x05local\\x00\\x00!\\x00\\x01\\xc0\\x0c\\x00\\x10\\x00\\x01\\xc0\\x0c\\x00\\x01\\x00\\x01\\xc0\\x0c\\x00\\x1c\\x00\\x01'...\n2025-01-29 22:20:20.021 DEBUG (MainThread) [zeroconf] IPv6 scope_id 0 associated to the receiving interface\n2025-01-29 22:20:20.021 DEBUG (MainThread) [zeroconf] Received from '::ffff:10.12.0.8':5353 [socket 12 (('::', 5353, 0, 0))]: <DNSIncoming:id=0, flags=0, truncated=False, n_q=4, n_ans=0, n_auth=0, n_add=0, questions=[srv[question,QM,in,slzb-06.local.], txt[question,QM,in,slzb-06.local.], a[question,QM,in,slzb-06.local.], quada[question,QM,in,slzb-06.local.]], answers=[]> (49 bytes) as [b'\\x00\\x00\\x00\\x00\\x00\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x07slzb-06\\x05local\\x00\\x00!\\x00\\x01\\xc0\\x0c\\x00\\x10\\x00\\x01\\xc0\\x0c\\x00\\x01\\x00\\x01\\xc0\\x0c\\x00\\x1c\\x00\\x01']\n2025-01-29 22:20:20.021 DEBUG (MainThread) [zeroconf] Ignoring duplicate message with no unicast questions received from ('::ffff:10.12.2.3', 5353, 0, 0) [socket 12 (('::', 5353, 0, 0))] (49 bytes) as [b'\\x00\\x00\\x00\\x00\\x00\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x07slzb-06\\x05local\\x00\\x00!\\x00\\x01\\xc0\\x0c\\x00\\x10\\x00\\x01\\xc0\\x0c\\x00\\x01\\x00\\x01\\xc0\\x0c\\x00\\x1c\\x00\\x01']\n2025-01-29 22:20:20.021 DEBUG (MainThread) [zeroconf] Ignoring duplicate message with no unicast questions received from ('fd64:5c16:1a1a:0:a699:a615:972:6e24', 5353, 0, 0) [socket 12 (('::', 5353, 0, 0))] (49 bytes) as [b'\\x00\\x00\\x00\\x00\\x00\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x07slzb-06\\x05local\\x00\\x00!\\x00\\x01\\xc0\\x0c\\x00\\x10\\x00\\x01\\xc0\\x0c\\x00\\x01\\x00\\x01\\xc0\\x0c\\x00\\x1c\\x00\\x01']\n2025-01-29 22:20:20.022 DEBUG (MainThread) [zeroconf] Ignoring duplicate message with no unicast questions received from ('fd64:5c16:1a1a:2:afd6:ee5f:30cb:1e13', 5353, 0, 0) [socket 12 (('::', 5353, 0, 0))] (49 bytes) as [b'\\x00\\x00\\x00\\x00\\x00\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x07slzb-06\\x05local\\x00\\x00!\\x00\\x01\\xc0\\x0c\\x00\\x10\\x00\\x01\\xc0\\x0c\\x00\\x01\\x00\\x01\\xc0\\x0c\\x00\\x1c\\x00\\x01']\n2025-01-29 22:20:20.637 DEBUG (MainThread) [zeroconf] IPv6 scope_id 0 associated to the receiving interface\n```\n\nThe ignoring is fine as its the question it just asked being reflected back to itself. However it seems like its never getting an answer.\n\n```\n% python3\nPython 3.13.0 (main, Oct  7 2024, 05:02:14) [Clang 16.0.0 (clang-1600.0.26.4)] on darwin\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\n>>> import dns.message\n>>> str(dns.message.from_wire(b'\\x00\\x00\\x00\\x00\\x00\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x07slzb-06\\x05local\\x00\\x00!\\x00\\x01\\xc0\\x0c\\x00\\x10\\x00\\x01\\xc0\\x0c\\x00\\x01\\x00\\x01\\xc0\\x0c\\x00\\x1c\\x00\\x01'))\n'id 0\\nopcode QUERY\\nrcode NOERROR\\nflags \\n;QUESTION\\nslzb-06.local. IN SRV\\nslzb-06.local. IN TXT\\nslzb-06.local. IN A\\nslzb-06.local. IN AAAA\\n;ANSWER\\n;AUTHORITY\\n;ADDITIONAL'\n>>> \n\n```\nIt sure looks like we ask the right question, but the device never responds back to us\n```\n>>> str(dns.message.from_wire(b'\\x00\\x00\\x00\\x00\\x00\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x07slzb-06\\x05local\\x00\\x00!\\x00\\x01\\xc0\\x0c\\x00\\x10\\x00\\x01\\xc0\\x0c\\x00\\x01\\x00\\x01\\xc0\\x0c\\x00\\x1c\\x00\\x01'))\n'id 0\\nopcode QUERY\\nrcode NOERROR\\nflags \\n;QUESTION\\nslzb-06.local. IN SRV\\nslzb-06.local. IN TXT\\nslzb-06.local. IN A\\nslzb-06.local. IN AAAA\\n;ANSWER\\n;AUTHORITY\\n;ADDITIONAL'\n```\n```\n>>> print(str(dns.message.from_wire(b'\\x00\\x00\\x00\\x00\\x00\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x07slzb-06\\x05local\\x00\\x00!\\x00\\x01\\xc0\\x0c\\x00\\x10\\x00\\x01\\xc0\\x0c\\x00\\x01\\x00\\x01\\xc0\\x0c\\x00\\x1c\\x00\\x01')))\nid 0\nopcode QUERY\nrcode NOERROR\nflags \n;QUESTION\nslzb-06.local. IN SRV\nslzb-06.local. IN TXT\nslzb-06.local. IN A\nslzb-06.local. IN AAAA\n;ANSWER\n;AUTHORITY\n;ADDITIONAL\n```\nWhen discovery happens earlier, the A record gets populated as an when it asks for `SLZB-06._slzb-06._tcp.local.`.... it should have be in the `additionals` because its not the question that was asked (we ask `a[question,QU,in,SLZB-06._slzb-06._tcp.local.]` but we get back in `answers` `record[a,in-unique,SLZB-06.local.]=120.0/119,10.12.2.8`\n```\n2025-01-29 22:15:12.302 DEBUG (MainThread) [zeroconf] Sending to (224.0.0.251, 5353) via [socket 15 (('10.12.0.8', 5353))] (57 bytes #1) <DNSOutgoing:multicast=True, flags=0, questions=[srv[question,QU,in,SLZB-06._slzb-06._tcp.local.], a[question,QU,in,SLZB-06._slzb-06._tcp.local.], quada[question,QU,in,SLZB-06._slzb-06._tcp.local.]], answers=[], authorities=[], additionals=[]> as b'\\x00\\x00\\x00\\x00\\x00\\x03\\x00\\x00\\x00\\x00\\x00\\x00\\x07SLZB-06\\x08_slzb-06\\x04_tcp\\x05local\\x00\\x00!\\x80\\x01\\xc0\\x0c\\x00\\x01\\x80\\x01\\xc0\\x0c\\x00\\x1c\\x80\\x01'...\n2025-01-29 22:15:12.303 DEBUG (MainThread) [zeroconf] Sending to (224.0.0.251, 5353) via [socket 17 (('10.12.2.3', 5353))] (57 bytes #1) <DNSOutgoing:multicast=True, flags=0, questions=[srv[question,QU,in,SLZB-06._slzb-06._tcp.local.], a[question,QU,in,SLZB-06._slzb-06._tcp.local.], quada[question,QU,in,SLZB-06._slzb-06._tcp.local.]], answers=[], authorities=[], additionals=[]> as b'\\x00\\x00\\x00\\x00\\x00\\x03\\x00\\x00\\x00\\x00\\x00\\x00\\x07SLZB-06\\x08_slzb-06\\x04_tcp\\x05local\\x00\\x00!\\x80\\x01\\xc0\\x0c\\x00\\x01\\x80\\x01\\xc0\\x0c\\x00\\x1c\\x80\\x01'...\n2025-01-29 22:15:12.304 DEBUG (MainThread) [zeroconf] Sending to (ff02::fb, 5353) via [socket 19 (('fd64:5c16:1a1a:0:a699:a615:972:6e24', 5353, 0, 0))] (57 bytes #1) <DNSOutgoing:multicast=True, flags=0, questions=[srv[question,QU,in,SLZB-06._slzb-06._tcp.local.], a[question,QU,in,SLZB-06._slzb-06._tcp.local.], quada[question,QU,in,SLZB-06._slzb-06._tcp.local.]], answers=[], authorities=[], additionals=[]> as b'\\x00\\x00\\x00\\x00\\x00\\x03\\x00\\x00\\x00\\x00\\x00\\x00\\x07SLZB-06\\x08_slzb-06\\x04_tcp\\x05local\\x00\\x00!\\x80\\x01\\xc0\\x0c\\x00\\x01\\x80\\x01\\xc0\\x0c\\x00\\x1c\\x80\\x01'...\n2025-01-29 22:15:12.305 DEBUG (MainThread) [zeroconf] Sending to (ff02::fb, 5353) via [socket 20 (('fd64:5c16:1a1a:2:afd6:ee5f:30cb:1e13', 5353, 0, 0))] (57 bytes #1) <DNSOutgoing:multicast=True, flags=0, questions=[srv[question,QU,in,SLZB-06._slzb-06._tcp.local.], a[question,QU,in,SLZB-06._slzb-06._tcp.local.], quada[question,QU,in,SLZB-06._slzb-06._tcp.local.]], answers=[], authorities=[], additionals=[]> as b'\\x00\\x00\\x00\\x00\\x00\\x03\\x00\\x00\\x00\\x00\\x00\\x00\\x07SLZB-06\\x08_slzb-06\\x04_tcp\\x05local\\x00\\x00!\\x80\\x01\\xc0\\x0c\\x00\\x01\\x80\\x01\\xc0\\x0c\\x00\\x1c\\x80\\x01'...\n2025-01-29 22:15:12.351 DEBUG (MainThread) [zeroconf] IPv6 scope_id 0 associated to the receiving interface\n2025-01-29 22:15:12.351 DEBUG (MainThread) [zeroconf] Received from '::ffff:10.12.0.8':5353 [socket 12 (('::', 5353, 0, 0))]: <DNSIncoming:id=0, flags=0, truncated=False, n_q=3, n_ans=0, n_auth=0, n_add=0, questions=[srv[question,QU,in,SLZB-06._slzb-06._tcp.local.], a[question,QU,in,SLZB-06._slzb-06._tcp.local.], quada[question,QU,in,SLZB-06._slzb-06._tcp.local.]], answers=[]> (57 bytes) as [b'\\x00\\x00\\x00\\x00\\x00\\x03\\x00\\x00\\x00\\x00\\x00\\x00\\x07SLZB-06\\x08_slzb-06\\x04_tcp\\x05local\\x00\\x00!\\x80\\x01\\xc0\\x0c\\x00\\x01\\x80\\x01\\xc0\\x0c\\x00\\x1c\\x80\\x01']\n2025-01-29 22:15:12.352 DEBUG (MainThread) [zeroconf] IPv6 scope_id 0 associated to the receiving interface\n2025-01-29 22:15:12.352 DEBUG (MainThread) [zeroconf] Received from '::ffff:10.12.2.3':5353 [socket 12 (('::', 5353, 0, 0))]: <DNSIncoming:id=0, flags=0, truncated=False, n_q=3, n_ans=0, n_auth=0, n_add=0, questions=[srv[question,QU,in,SLZB-06._slzb-06._tcp.local.], a[question,QU,in,SLZB-06._slzb-06._tcp.local.], quada[question,QU,in,SLZB-06._slzb-06._tcp.local.]], answers=[]> (57 bytes) as [b'\\x00\\x00\\x00\\x00\\x00\\x03\\x00\\x00\\x00\\x00\\x00\\x00\\x07SLZB-06\\x08_slzb-06\\x04_tcp\\x05local\\x00\\x00!\\x80\\x01\\xc0\\x0c\\x00\\x01\\x80\\x01\\xc0\\x0c\\x00\\x1c\\x80\\x01']\n2025-01-29 22:15:12.352 DEBUG (MainThread) [zeroconf] IPv6 scope_id 0 associated to the receiving interface\n2025-01-29 22:15:12.352 DEBUG (MainThread) [zeroconf] Received from 'fd64:5c16:1a1a:0:a699:a615:972:6e24':5353 [socket 12 (('::', 5353, 0, 0))]: <DNSIncoming:id=0, flags=0, truncated=False, n_q=3, n_ans=0, n_auth=0, n_add=0, questions=[srv[question,QU,in,SLZB-06._slzb-06._tcp.local.], a[question,QU,in,SLZB-06._slzb-06._tcp.local.], quada[question,QU,in,SLZB-06._slzb-06._tcp.local.]], answers=[]> (57 bytes) as [b'\\x00\\x00\\x00\\x00\\x00\\x03\\x00\\x00\\x00\\x00\\x00\\x00\\x07SLZB-06\\x08_slzb-06\\x04_tcp\\x05local\\x00\\x00!\\x80\\x01\\xc0\\x0c\\x00\\x01\\x80\\x01\\xc0\\x0c\\x00\\x1c\\x80\\x01']\n2025-01-29 22:15:12.352 DEBUG (MainThread) [zeroconf] IPv6 scope_id 0 associated to the receiving interface\n2025-01-29 22:15:12.352 DEBUG (MainThread) [zeroconf] Received from 'fd64:5c16:1a1a:2:afd6:ee5f:30cb:1e13':5353 [socket 12 (('::', 5353, 0, 0))]: <DNSIncoming:id=0, flags=0, truncated=False, n_q=3, n_ans=0, n_auth=0, n_add=0, questions=[srv[question,QU,in,SLZB-06._slzb-06._tcp.local.], a[question,QU,in,SLZB-06._slzb-06._tcp.local.], quada[question,QU,in,SLZB-06._slzb-06._tcp.local.]], answers=[]> (57 bytes) as [b'\\x00\\x00\\x00\\x00\\x00\\x03\\x00\\x00\\x00\\x00\\x00\\x00\\x07SLZB-06\\x08_slzb-06\\x04_tcp\\x05local\\x00\\x00!\\x80\\x01\\xc0\\x0c\\x00\\x01\\x80\\x01\\xc0\\x0c\\x00\\x1c\\x80\\x01']\n2025-01-29 22:15:12.408 DEBUG (MainThread) [zeroconf] IPv6 scope_id 0 associated to the receiving interface\n2025-01-29 22:15:12.408 DEBUG (MainThread) [zeroconf] Received from 'fd64:5c16:1a1a:2:fee8:c0ff:fef8:60e7':5353 [socket 20 (('fd64:5c16:1a1a:2:afd6:ee5f:30cb:1e13', 5353, 0, 0))]: <DNSIncoming:id=0, flags=33792, truncated=False, n_q=0, n_ans=1, n_auth=0, n_add=4, questions=[], answers=[record[srv,in-unique,SLZB-06._slzb-06._tcp.local.]=120.0/119,SLZB-06.local.:6638, record[a,in-unique,SLZB-06.local.]=120.0/119,10.12.2.8, record[quada,in-unique,SLZB-06.local.]=120.0/119,fe80::fee8:c0ff:fef8:60e7, record[quada,in-unique,SLZB-06.local.]=120.0/119,fd64:5c16:1a1a:2:fee8:c0ff:fef8:60e7, record[quada,in-unique,SLZB-06.local.]=120.0/119,2a00:6020:4e00:202:fee8:c0ff:fef8:60e7]> (167 bytes) as [b'\\x00\\x00\\x84\\x00\\x00\\x00\\x00\\x01\\x00\\x00\\x00\\x04\\x07SLZB-06\\x08_slzb-06\\x04_tcp\\x05local\\x00\\x00!\\x80\\x01\\x00\\x00\\x00x\\x00\\x10\\x00\\x00\\x00\\x00\\x19\\xee\\x07SLZB-06\\xc0\"\\xc09\\x00\\x01\\x80\\x01\\x00\\x00\\x00x\\x00\\x04\\n\\x0c\\x02\\x08\\xc09\\x00\\x1c\\x80\\x01\\x00\\x00\\x00x\\x00\\x10\\xfe\\x80\\x00\\x00\\x00\\x00\\x00\\x00\\xfe\\xe8\\xc0\\xff\\xfe\\xf8`\\xe7\\xc09\\x00\\x1c\\x80\\x01\\x00\\x00\\x00x\\x00\\x10\\xfdd\\\\\\x16\\x1a\\x1a\\x00\\x02\\xfe\\xe8\\xc0\\xff\\xfe\\xf8`\\xe7\\xc09\\x00\\x1c\\x80\\x01\\x00\\x00\\x00x\\x00\\x10*\\x00` N\\x00\\x02\\x02\\xfe\\xe8\\xc0\\xff\\xfe\\xf8`\\xe7']\n```\n> Also strange in the log its `smlight_SLZB-06.local` but above `slzb-06.local:80`\n> \n> Which one is the correct name, and which one is it actually trying to connect to ?\n\nwhen on my home network, i use `http://slzb-06.local/` on my Chrome broswer, and brings me to the UI of the device.\nSo its likely that the mDNS stack on the device is not very compliant, and whatever Chrome is using to do the query is sending it in an order that it happens to work, and when `zeroconf` sends it, its never responding to it.\n\nIt could be any of the following:\n- The device only responds to PTR queries\n- The device requires a case sensitive A query ie `SLZB-06.local`\n- The device wants an `ANY` query and zeroconf is asking for specific records.\n- The device's mDNS stack might not implement [name compression (which is required)](https://datatracker.ietf.org/doc/html/rfc6762#section-18.14) and it is relying on the A record query happening first in the question\n- Some other spec violation\n\nIt sure looks like a bug in the mDNS stack of the device.\nIts pretty clear from the logs that the device isn't responding to the A record query, and `zeroconf` is trying a `QU` query first, and than falling back to a `QM` one... and it just never responds\n\n```\n2025-01-29 22:20:15.184 DEBUG (MainThread) [zeroconf] now offsets = questions=4, answers=0, authorities=0, additionals=0\n2025-01-29 22:20:15.185 DEBUG (MainThread) [zeroconf] Sending to (224.0.0.251, 5353) via [socket 15 (('10.12.0.8', 5353))] (49 bytes #1) <DNSOutgoing:multicast=True, flags=0, questions=[srv[question,QU,in,slzb-06.local.], txt[question,QU,in,slzb-06.local.], a[question,QU,in,slzb-06.local.], quada[question,QU,in,slzb-06.local.]], answers=[], authorities=[], additionals=[]> as b'\\x00\\x00\\x00\\x00\\x00\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x07slzb-06\\x05local\\x00\\x00!\\x80\\x01\\xc0\\x0c\\x00\\x10\\x80\\x01\\xc0\\x0c\\x00\\x01\\x80\\x01\\xc0\\x0c\\x00\\x1c\\x80\\x01'...\n2025-01-29 22:20:15.185 DEBUG (MainThread) [zeroconf] Sending to (224.0.0.251, 5353) via [socket 17 (('10.12.2.3', 5353))] (49 bytes #1) <DNSOutgoing:multicast=True, flags=0, questions=[srv[question,QU,in,slzb-06.local.], txt[question,QU,in,slzb-06.local.], a[question,QU,in,slzb-06.local.], quada[question,QU,in,slzb-06.local.]], answers=[], authorities=[], additionals=[]> as b'\\x00\\x00\\x00\\x00\\x00\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x07slzb-06\\x05local\\x00\\x00!\\x80\\x01\\xc0\\x0c\\x00\\x10\\x80\\x01\\xc0\\x0c\\x00\\x01\\x80\\x01\\xc0\\x0c\\x00\\x1c\\x80\\x01'...\n2025-01-29 22:20:15.185 DEBUG (MainThread) [zeroconf] Sending to (ff02::fb, 5353) via [socket 19 (('fd64:5c16:1a1a:0:a699:a615:972:6e24', 5353, 0, 0))] (49 bytes #1) <DNSOutgoing:multicast=True, flags=0, questions=[srv[question,QU,in,slzb-06.local.], txt[question,QU,in,slzb-06.local.], a[question,QU,in,slzb-06.local.], quada[question,QU,in,slzb-06.local.]], answers=[], authorities=[], additionals=[]> as b'\\x00\\x00\\x00\\x00\\x00\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x07slzb-06\\x05local\\x00\\x00!\\x80\\x01\\xc0\\x0c\\x00\\x10\\x80\\x01\\xc0\\x0c\\x00\\x01\\x80\\x01\\xc0\\x0c\\x00\\x1c\\x80\\x01'...\n2025-01-29 22:20:15.186 DEBUG (MainThread) [zeroconf] Sending to (ff02::fb, 5353) via [socket 20 (('fd64:5c16:1a1a:2:afd6:ee5f:30cb:1e13', 5353, 0, 0))] (49 bytes #1) <DNSOutgoing:multicast=True, flags=0, questions=[srv[question,QU,in,slzb-06.local.], txt[question,QU,in,slzb-06.local.], a[question,QU,in,slzb-06.local.], quada[question,QU,in,slzb-06.local.]], answers=[], authorities=[], additionals=[]> as b'\\x00\\x00\\x00\\x00\\x00\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x07slzb-06\\x05local\\x00\\x00!\\x80\\x01\\xc0\\x0c\\x00\\x10\\x80\\x01\\xc0\\x0c\\x00\\x01\\x80\\x01\\xc0\\x0c\\x00\\x1c\\x80\\x01'...\n2025-01-29 22:20:15.187 DEBUG (MainThread) [zeroconf] IPv6 scope_id 0 associated to the receiving interface\n2025-01-29 22:20:15.187 DEBUG (MainThread) [zeroconf] Received from '::ffff:10.12.0.8':5353 [socket 12 (('::', 5353, 0, 0))]: <DNSIncoming:id=0, flags=0, truncated=False, n_q=4, n_ans=0, n_auth=0, n_add=0, questions=[srv[question,QU,in,slzb-06.local.], txt[question,QU,in,slzb-06.local.], a[question,QU,in,slzb-06.local.], quada[question,QU,in,slzb-06.local.]], answers=[]> (49 bytes) as [b'\\x00\\x00\\x00\\x00\\x00\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x07slzb-06\\x05local\\x00\\x00!\\x80\\x01\\xc0\\x0c\\x00\\x10\\x80\\x01\\xc0\\x0c\\x00\\x01\\x80\\x01\\xc0\\x0c\\x00\\x1c\\x80\\x01']\n2025-01-29 22:20:15.187 DEBUG (MainThread) [zeroconf] IPv6 scope_id 0 associated to the receiving interface\n2025-01-29 22:20:15.187 DEBUG (MainThread) [zeroconf] Received from '::ffff:10.12.2.3':5353 [socket 12 (('::', 5353, 0, 0))]: <DNSIncoming:id=0, flags=0, truncated=False, n_q=4, n_ans=0, n_auth=0, n_add=0, questions=[srv[question,QU,in,slzb-06.local.], txt[question,QU,in,slzb-06.local.], a[question,QU,in,slzb-06.local.], quada[question,QU,in,slzb-06.local.]], answers=[]> (49 bytes) as [b'\\x00\\x00\\x00\\x00\\x00\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x07slzb-06\\x05local\\x00\\x00!\\x80\\x01\\xc0\\x0c\\x00\\x10\\x80\\x01\\xc0\\x0c\\x00\\x01\\x80\\x01\\xc0\\x0c\\x00\\x1c\\x80\\x01']\n2025-01-29 22:20:15.187 DEBUG (MainThread) [zeroconf] IPv6 scope_id 0 associated to the receiving interface\n2025-01-29 22:20:15.187 DEBUG (MainThread) [zeroconf] Received from 'fd64:5c16:1a1a:0:a699:a615:972:6e24':5353 [socket 12 (('::', 5353, 0, 0))]: <DNSIncoming:id=0, flags=0, truncated=False, n_q=4, n_ans=0, n_auth=0, n_add=0, questions=[srv[question,QU,in,slzb-06.local.], txt[question,QU,in,slzb-06.local.], a[question,QU,in,slzb-06.local.], quada[question,QU,in,slzb-06.local.]], answers=[]> (49 bytes) as [b'\\x00\\x00\\x00\\x00\\x00\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x07slzb-06\\x05local\\x00\\x00!\\x80\\x01\\xc0\\x0c\\x00\\x10\\x80\\x01\\xc0\\x0c\\x00\\x01\\x80\\x01\\xc0\\x0c\\x00\\x1c\\x80\\x01']\n2025-01-29 22:20:15.188 DEBUG (MainThread) [zeroconf] IPv6 scope_id 0 associated to the receiving interface\n2025-01-29 22:20:15.188 DEBUG (MainThread) [zeroconf] Received from 'fd64:5c16:1a1a:2:afd6:ee5f:30cb:1e13':5353 [socket 12 (('::', 5353, 0, 0))]: <DNSIncoming:id=0, flags=0, truncated=False, n_q=4, n_ans=0, n_auth=0, n_add=0, questions=[srv[question,QU,in,slzb-06.local.], txt[question,QU,in,slzb-06.local.], a[question,QU,in,slzb-06.local.], quada[question,QU,in,slzb-06.local.]], answers=[]> (49 bytes) as [b'\\x00\\x00\\x00\\x00\\x00\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x07slzb-06\\x05local\\x00\\x00!\\x80\\x01\\xc0\\x0c\\x00\\x10\\x80\\x01\\xc0\\x0c\\x00\\x01\\x80\\x01\\xc0\\x0c\\x00\\x1c\\x80\\x01']\n2025-01-29 22:20:15.477 DEBUG (MainThread) [zeroconf] offsets = questions=0, answers=0, authorities=0, additionals=0\n2025-01-29 22:20:15.477 DEBUG (MainThread) [zeroconf] lengths = questions=4, answers=0, authorities=0, additionals=0\n2025-01-29 22:20:15.477 DEBUG (MainThread) [zeroconf] now offsets = questions=4, answers=0, authorities=0, additionals=0\n2025-01-29 22:20:15.477 DEBUG (MainThread) [zeroconf] Sending to (224.0.0.251, 5353) via [socket 15 (('10.12.0.8', 5353))] (49 bytes #1) <DNSOutgoing:multicast=True, flags=0, questions=[srv[question,QM,in,slzb-06.local.], txt[question,QM,in,slzb-06.local.], a[question,QM,in,slzb-06.local.], quada[question,QM,in,slzb-06.local.]], answers=[], authorities=[], additionals=[]> as b'\\x00\\x00\\x00\\x00\\x00\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x07slzb-06\\x05local\\x00\\x00!\\x00\\x01\\xc0\\x0c\\x00\\x10\\x00\\x01\\xc0\\x0c\\x00\\x01\\x00\\x01\\xc0\\x0c\\x00\\x1c\\x00\\x01'...\n2025-01-29 22:20:15.478 DEBUG (MainThread) [zeroconf] Sending to (224.0.0.251, 5353) via [socket 17 (('10.12.2.3', 5353))] (49 bytes #1) <DNSOutgoing:multicast=True, flags=0, questions=[srv[question,QM,in,slzb-06.local.], txt[question,QM,in,slzb-06.local.], a[question,QM,in,slzb-06.local.], quada[question,QM,in,slzb-06.local.]], answers=[], authorities=[], additionals=[]> as b'\\x00\\x00\\x00\\x00\\x00\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x07slzb-06\\x05local\\x00\\x00!\\x00\\x01\\xc0\\x0c\\x00\\x10\\x00\\x01\\xc0\\x0c\\x00\\x01\\x00\\x01\\xc0\\x0c\\x00\\x1c\\x00\\x01'...\n2025-01-29 22:20:15.478 DEBUG (MainThread) [zeroconf] Sending to (ff02::fb, 5353) via [socket 19 (('fd64:5c16:1a1a:0:a699:a615:972:6e24', 5353, 0, 0))] (49 bytes #1) <DNSOutgoing:multicast=True, flags=0, questions=[srv[question,QM,in,slzb-06.local.], txt[question,QM,in,slzb-06.local.], a[question,QM,in,slzb-06.local.], quada[question,QM,in,slzb-06.local.]], answers=[], authorities=[], additionals=[]> as b'\\x00\\x00\\x00\\x00\\x00\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x07slzb-06\\x05local\\x00\\x00!\\x00\\x01\\xc0\\x0c\\x00\\x10\\x00\\x01\\xc0\\x0c\\x00\\x01\\x00\\x01\\xc0\\x0c\\x00\\x1c\\x00\\x01'...\n2025-01-29 22:20:15.478 DEBUG (MainThread) [zeroconf] Sending to (ff02::fb, 5353) via [socket 20 (('fd64:5c16:1a1a:2:afd6:ee5f:30cb:1e13', 5353, 0, 0))] (49 bytes #1) <DNSOutgoing:multicast=True, flags=0, questions=[srv[question,QM,in,slzb-06.local.], txt[question,QM,in,slzb-06.local.], a[question,QM,in,slzb-06.local.], quada[question,QM,in,slzb-06.local.]], answers=[], authorities=[], additionals=[]> as b'\\x00\\x00\\x00\\x00\\x00\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x07slzb-06\\x05local\\x00\\x00!\\x00\\x01\\xc0\\x0c\\x00\\x10\\x00\\x01\\xc0\\x0c\\x00\\x01\\x00\\x01\\xc0\\x0c\\x00\\x1c\\x00\\x01'...\n2025-01-29 22:20:15.479 DEBUG (MainThread) [zeroconf] IPv6 scope_id 0 associated to the receiving interface\n2025-01-29 22:20:15.479 DEBUG (MainThread) [zeroconf] Received from '::ffff:10.12.0.8':5353 [socket 12 (('::', 5353, 0, 0))]: <DNSIncoming:id=0, flags=0, truncated=False, n_q=4, n_ans=0, n_auth=0, n_add=0, questions=[srv[question,QM,in,slzb-06.local.], txt[question,QM,in,slzb-06.local.], a[question,QM,in,slzb-06.local.], quada[question,QM,in,slzb-06.local.]], answers=[]> (49 bytes) as [b'\\x00\\x00\\x00\\x00\\x00\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x07slzb-06\\x05local\\x00\\x00!\\x00\\x01\\xc0\\x0c\\x00\\x10\\x00\\x01\\xc0\\x0c\\x00\\x01\\x00\\x01\\xc0\\x0c\\x00\\x1c\\x00\\x01']\n2025-01-29 22:20:15.479 DEBUG (MainThread) [zeroconf] Ignoring duplicate message with no unicast questions received from ('::ffff:10.12.2.3', 5353, 0, 0) [socket 12 (('::', 5353, 0, 0))] (49 bytes) as [b'\\x00\\x00\\x00\\x00\\x00\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x07slzb-06\\x05local\\x00\\x00!\\x00\\x01\\xc0\\x0c\\x00\\x10\\x00\\x01\\xc0\\x0c\\x00\\x01\\x00\\x01\\xc0\\x0c\\x00\\x1c\\x00\\x01']\n2025-01-29 22:20:15.479 DEBUG (MainThread) [zeroconf] Ignoring duplicate message with no unicast questions received from ('fd64:5c16:1a1a:0:a699:a615:972:6e24', 5353, 0, 0) [socket 12 (('::', 5353, 0, 0))] (49 bytes) as [b'\\x00\\x00\\x00\\x00\\x00\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x07slzb-06\\x05local\\x00\\x00!\\x00\\x01\\xc0\\x0c\\x00\\x10\\x00\\x01\\xc0\\x0c\\x00\\x01\\x00\\x01\\xc0\\x0c\\x00\\x1c\\x00\\x01']\n2025-01-29 22:20:15.479 DEBUG (MainThread) [zeroconf] Ignoring duplicate message with no unicast questions received from ('fd64:5c16:1a1a:2:afd6:ee5f:30cb:1e13', 5353, 0, 0) [socket 12 (('::', 5353, 0, 0))] (49 bytes) as [b'\\x00\\x00\\x00\\x00\\x00\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x07slzb-06\\x05local\\x00\\x00!\\x00\\x01\\xc0\\x0c\\x00\\x10\\x00\\x01\\xc0\\x0c\\x00\\x01\\x00\\x01\\xc0\\x0c\\x00\\x1c\\x00\\x01']\n2025-01-29 22:20:16.747 DEBUG (MainThread) [zeroconf] offsets = questions=0, answers=0, authorities=0, additionals=0\n2025-01-29 22:20:16.747 DEBUG (MainThread) [zeroconf] lengths = questions=4, answers=0, authorities=0, additionals=0\n2025-01-29 22:20:16.747 DEBUG (MainThread) [zeroconf] now offsets = questions=4, answers=0, authorities=0, additionals=0\n2025-01-29 22:20:16.748 DEBUG (MainThread) [zeroconf] Sending to (224.0.0.251, 5353) via [socket 15 (('10.12.0.8', 5353))] (49 bytes #1) <DNSOutgoing:multicast=True, flags=0, questions=[srv[question,QM,in,slzb-06.local.], txt[question,QM,in,slzb-06.local.], a[question,QM,in,slzb-06.local.], quada[question,QM,in,slzb-06.local.]], answers=[], authorities=[], additionals=[]> as b'\\x00\\x00\\x00\\x00\\x00\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x07slzb-06\\x05local\\x00\\x00!\\x00\\x01\\xc0\\x0c\\x00\\x10\\x00\\x01\\xc0\\x0c\\x00\\x01\\x00\\x01\\xc0\\x0c\\x00\\x1c\\x00\\x01'...\n2025-01-29 22:20:16.748 DEBUG (MainThread) [zeroconf] Sending to (224.0.0.251, 5353) via [socket 17 (('10.12.2.3', 5353))] (49 bytes #1) <DNSOutgoing:multicast=True, flags=0, questions=[srv[question,QM,in,slzb-06.local.], txt[question,QM,in,slzb-06.local.], a[question,QM,in,slzb-06.local.], quada[question,QM,in,slzb-06.local.]], answers=[], authorities=[], additionals=[]> as b'\\x00\\x00\\x00\\x00\\x00\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x07slzb-06\\x05local\\x00\\x00!\\x00\\x01\\xc0\\x0c\\x00\\x10\\x00\\x01\\xc0\\x0c\\x00\\x01\\x00\\x01\\xc0\\x0c\\x00\\x1c\\x00\\x01'...\n2025-01-29 22:20:16.748 DEBUG (MainThread) [zeroconf] Sending to (ff02::fb, 5353) via [socket 19 (('fd64:5c16:1a1a:0:a699:a615:972:6e24', 5353, 0, 0))] (49 bytes #1) <DNSOutgoing:multicast=True, flags=0, questions=[srv[question,QM,in,slzb-06.local.], txt[question,QM,in,slzb-06.local.], a[question,QM,in,slzb-06.local.], quada[question,QM,in,slzb-06.local.]], answers=[], authorities=[], additionals=[]> as b'\\x00\\x00\\x00\\x00\\x00\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x07slzb-06\\x05local\\x00\\x00!\\x00\\x01\\xc0\\x0c\\x00\\x10\\x00\\x01\\xc0\\x0c\\x00\\x01\\x00\\x01\\xc0\\x0c\\x00\\x1c\\x00\\x01'...\n2025-01-29 22:20:16.748 DEBUG (MainThread) [zeroconf] Sending to (ff02::fb, 5353) via [socket 20 (('fd64:5c16:1a1a:2:afd6:ee5f:30cb:1e13', 5353, 0, 0))] (49 bytes #1) <DNSOutgoing:multicast=True, flags=0, questions=[srv[question,QM,in,slzb-06.local.], txt[question,QM,in,slzb-06.local.], a[question,QM,in,slzb-06.local.], quada[question,QM,in,slzb-06.local.]], answers=[], authorities=[], additionals=[]> as b'\\x00\\x00\\x00\\x00\\x00\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x07slzb-06\\x05local\\x00\\x00!\\x00\\x01\\xc0\\x0c\\x00\\x10\\x00\\x01\\xc0\\x0c\\x00\\x01\\x00\\x01\\xc0\\x0c\\x00\\x1c\\x00\\x01'...\n2025-01-29 22:20:16.748 DEBUG (MainThread) [zeroconf] IPv6 scope_id 0 associated to the receiving interface\n2025-01-29 22:20:16.749 DEBUG (MainThread) [zeroconf] Received from '::ffff:10.12.0.8':5353 [socket 12 (('::', 5353, 0, 0))]: <DNSIncoming:id=0, flags=0, truncated=False, n_q=4, n_ans=0, n_auth=0, n_add=0, questions=[srv[question,QM,in,slzb-06.local.], txt[question,QM,in,slzb-06.local.], a[question,QM,in,slzb-06.local.], quada[question,QM,in,slzb-06.local.]], answers=[]> (49 bytes) as [b'\\x00\\x00\\x00\\x00\\x00\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x07slzb-06\\x05local\\x00\\x00!\\x00\\x01\\xc0\\x0c\\x00\\x10\\x00\\x01\\xc0\\x0c\\x00\\x01\\x00\\x01\\xc0\\x0c\\x00\\x1c\\x00\\x01']\n2025-01-29 22:20:16.749 DEBUG (MainThread) [zeroconf] Ignoring duplicate message with no unicast questions received from ('::ffff:10.12.2.3', 5353, 0, 0) [socket 12 (('::', 5353, 0, 0))] (49 bytes) as [b'\\x00\\x00\\x00\\x00\\x00\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x07slzb-06\\x05local\\x00\\x00!\\x00\\x01\\xc0\\x0c\\x00\\x10\\x00\\x01\\xc0\\x0c\\x00\\x01\\x00\\x01\\xc0\\x0c\\x00\\x1c\\x00\\x01']\n2025-01-29 22:20:16.749 DEBUG (MainThread) [zeroconf] Ignoring duplicate message with no unicast questions received from ('fd64:5c16:1a1a:0:a699:a615:972:6e24', 5353, 0, 0) [socket 12 (('::', 5353, 0, 0))] (49 bytes) as [b'\\x00\\x00\\x00\\x00\\x00\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x07slzb-06\\x05local\\x00\\x00!\\x00\\x01\\xc0\\x0c\\x00\\x10\\x00\\x01\\xc0\\x0c\\x00\\x01\\x00\\x01\\xc0\\x0c\\x00\\x1c\\x00\\x01']\n2025-01-29 22:20:16.750 DEBUG (MainThread) [zeroconf] Ignoring duplicate message with no unicast questions received from ('fd64:5c16:1a1a:2:afd6:ee5f:30cb:1e13', 5353, 0, 0) [socket 12 (('::', 5353, 0, 0))] (49 bytes) as [b'\\x00\\x00\\x00\\x00\\x00\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x07slzb-06\\x05local\\x00\\x00!\\x00\\x01\\xc0\\x0c\\x00\\x10\\x00\\x01\\xc0\\x0c\\x00\\x01\\x00\\x01\\xc0\\x0c\\x00\\x1c\\x00\\x01']\n2025-01-29 22:20:17.849 DEBUG (MainThread) [zeroconf] offsets = questions=0, answers=0, authorities=0, additionals=0\n2025-01-29 22:20:17.849 DEBUG (MainThread) [zeroconf] lengths = questions=4, answers=0, authorities=0, additionals=0\n2025-01-29 22:20:17.849 DEBUG (MainThread) [zeroconf] now offsets = questions=4, answers=0, authorities=0, additionals=0\n2025-01-29 22:20:17.849 DEBUG (MainThread) [zeroconf] Sending to (224.0.0.251, 5353) via [socket 15 (('10.12.0.8', 5353))] (49 bytes #1) <DNSOutgoing:multicast=True, flags=0, questions=[srv[question,QM,in,slzb-06.local.], txt[question,QM,in,slzb-06.local.], a[question,QM,in,slzb-06.local.], quada[question,QM,in,slzb-06.local.]], answers=[], authorities=[], additionals=[]> as b'\\x00\\x00\\x00\\x00\\x00\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x07slzb-06\\x05local\\x00\\x00!\\x00\\x01\\xc0\\x0c\\x00\\x10\\x00\\x01\\xc0\\x0c\\x00\\x01\\x00\\x01\\xc0\\x0c\\x00\\x1c\\x00\\x01'...\n2025-01-29 22:20:17.850 DEBUG (MainThread) [zeroconf] Sending to (224.0.0.251, 5353) via [socket 17 (('10.12.2.3', 5353))] (49 bytes #1) <DNSOutgoing:multicast=True, flags=0, questions=[srv[question,QM,in,slzb-06.local.], txt[question,QM,in,slzb-06.local.], a[question,QM,in,slzb-06.local.], quada[question,QM,in,slzb-06.local.]], answers=[], authorities=[], additionals=[]> as b'\\x00\\x00\\x00\\x00\\x00\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x07slzb-06\\x05local\\x00\\x00!\\x00\\x01\\xc0\\x0c\\x00\\x10\\x00\\x01\\xc0\\x0c\\x00\\x01\\x00\\x01\\xc0\\x0c\\x00\\x1c\\x00\\x01'...\n2025-01-29 22:20:17.850 DEBUG (MainThread) [zeroconf] Sending to (ff02::fb, 5353) via [socket 19 (('fd64:5c16:1a1a:0:a699:a615:972:6e24', 5353, 0, 0))] (49 bytes #1) <DNSOutgoing:multicast=True, flags=0, questions=[srv[question,QM,in,slzb-06.local.], txt[question,QM,in,slzb-06.local.], a[question,QM,in,slzb-06.local.], quada[question,QM,in,slzb-06.local.]], answers=[], authorities=[], additionals=[]> as b'\\x00\\x00\\x00\\x00\\x00\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x07slzb-06\\x05local\\x00\\x00!\\x00\\x01\\xc0\\x0c\\x00\\x10\\x00\\x01\\xc0\\x0c\\x00\\x01\\x00\\x01\\xc0\\x0c\\x00\\x1c\\x00\\x01'...\n2025-01-29 22:20:17.850 DEBUG (MainThread) [zeroconf] Sending to (ff02::fb, 5353) via [socket 20 (('fd64:5c16:1a1a:2:afd6:ee5f:30cb:1e13', 5353, 0, 0))] (49 bytes #1) <DNSOutgoing:multicast=True, flags=0, questions=[srv[question,QM,in,slzb-06.local.], txt[question,QM,in,slzb-06.local.], a[question,QM,in,slzb-06.local.], quada[question,QM,in,slzb-06.local.]], answers=[], authorities=[], additionals=[]> as b'\\x00\\x00\\x00\\x00\\x00\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x07slzb-06\\x05local\\x00\\x00!\\x00\\x01\\xc0\\x0c\\x00\\x10\\x00\\x01\\xc0\\x0c\\x00\\x01\\x00\\x01\\xc0\\x0c\\x00\\x1c\\x00\\x01'...\n2025-01-29 22:20:17.850 DEBUG (MainThread) [zeroconf] IPv6 scope_id 0 associated to the receiving interface\n2025-01-29 22:20:17.850 DEBUG (MainThread) [zeroconf] Received from '::ffff:10.12.0.8':5353 [socket 12 (('::', 5353, 0, 0))]: <DNSIncoming:id=0, flags=0, truncated=False, n_q=4, n_ans=0, n_auth=0, n_add=0, questions=[srv[question,QM,in,slzb-06.local.], txt[question,QM,in,slzb-06.local.], a[question,QM,in,slzb-06.local.], quada[question,QM,in,slzb-06.local.]], answers=[]> (49 bytes) as [b'\\x00\\x00\\x00\\x00\\x00\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x07slzb-06\\x05local\\x00\\x00!\\x00\\x01\\xc0\\x0c\\x00\\x10\\x00\\x01\\xc0\\x0c\\x00\\x01\\x00\\x01\\xc0\\x0c\\x00\\x1c\\x00\\x01']\n2025-01-29 22:20:17.851 DEBUG (MainThread) [zeroconf] Ignoring duplicate message with no unicast questions received from ('::ffff:10.12.2.3', 5353, 0, 0) [socket 12 (('::', 5353, 0, 0))] (49 bytes) as [b'\\x00\\x00\\x00\\x00\\x00\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x07slzb-06\\x05local\\x00\\x00!\\x00\\x01\\xc0\\x0c\\x00\\x10\\x00\\x01\\xc0\\x0c\\x00\\x01\\x00\\x01\\xc0\\x0c\\x00\\x1c\\x00\\x01']\n2025-01-29 22:20:17.851 DEBUG (MainThread) [zeroconf] Ignoring duplicate message with no unicast questions received from ('fd64:5c16:1a1a:0:a699:a615:972:6e24', 5353, 0, 0) [socket 12 (('::', 5353, 0, 0))] (49 bytes) as [b'\\x00\\x00\\x00\\x00\\x00\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x07slzb-06\\x05local\\x00\\x00!\\x00\\x01\\xc0\\x0c\\x00\\x10\\x00\\x01\\xc0\\x0c\\x00\\x01\\x00\\x01\\xc0\\x0c\\x00\\x1c\\x00\\x01']\n2025-01-29 22:20:17.851 DEBUG (MainThread) [zeroconf] Ignoring duplicate message with no unicast questions received from ('fd64:5c16:1a1a:2:afd6:ee5f:30cb:1e13', 5353, 0, 0) [socket 12 (('::', 5353, 0, 0))] (49 bytes) as [b'\\x00\\x00\\x00\\x00\\x00\\x04\\x00\\x00\\x00\\x00\\x00\\x00\\x07slzb-06\\x05local\\x00\\x00!\\x00\\x01\\xc0\\x0c\\x00\\x10\\x00\\x01\\xc0\\x0c\\x00\\x01\\x00\\x01\\xc0\\x0c\\x00\\x1c\\x00\\x01']\n2025-01-29 22:20:18.163 DEBUG (MainThread) [zeroconf] IPv6 scope_id 5 associated to the receiving interface\n2025-01-29 22:20:18.164 DEBUG (MainThread) [zeroconf] Received from 'fe80::42:d8ff:fe35:8443':5353 [socket 12 (('::', 5353, 0, 0))]: <DNSIncoming:id=0, flags=0, truncated=False, n_q=2, n_ans=0, n_auth=0, n_add=0, questions=[quada[question,QM,in,homeassistant.local.], a[question,QM,in,homeassistant.local.]], answers=[]> (43 bytes) as [b'\\x00\\x00\\x00\\x00\\x00\\x02\\x00\\x00\\x00\\x00\\x00\\x00\\rhomeassistant\\x05local\\x00\\x00\\x1c\\x00\\x01\\xc0\\x0c\\x00\\x01\\x00\\x01']\n```\n\n\nIt does respond to the `PTR` query from discovery which is what allows it to work for a bit right away since it sends the unsolicited `A` record (in the wrong field) as a result of the `PTR` query which sticks around for 120 seconds.... and than it never responds to a the `A` queries again and we end up in the failure state.\nI ordered one to see if I can come up with a workaround, but the vendor should fix the device so it responds to `A` queries.\nMaybe could make a new class with `_generate_request_query` that does the `A` record query first and the `AAAA` record query second so if its is a problem with the device not understanding name compression the uncompressed name would be used for the first record.\n\nTo make that work we would need to reimplement https://github.com/aio-libs/aiohttp-asyncmdnsresolver/blob/7bce43593a21050d46a9cdd5f39be6d36ef67fa3/src/aiohttp_asyncmdnsresolver/_impl.py#L13 https://github.com/aio-libs/aiohttp-asyncmdnsresolver/blob/7bce43593a21050d46a9cdd5f39be6d36ef67fa3/src/aiohttp_asyncmdnsresolver/_impl.py#L22 https://github.com/aio-libs/aiohttp-asyncmdnsresolver/blob/7bce43593a21050d46a9cdd5f39be6d36ef67fa3/src/aiohttp_asyncmdnsresolver/_impl.py#L31 in `zeroconf` itself.\n\n... thats assuming its not a UPPERcase lowercase bug in the device's stack.... really hard to guess what magic is needed to make the device happy without it in hand.\nWow thanks a lot @bdraco for your extensive debugging. Is there a way how I can verify (mostly the first 3 cases) this:\n\n> It could be any of the following:\n>\n> - The device only responds to PTR queries\n> - The device requires a case sensitive A query ie SLZB-06.local\n> - The device wants an ANY query and zeroconf is asking for specific records.\n> - The device's mDNS stack might not implement [name compression (which is required)](https://datatracker.ietf.org/doc/html/rfc6762#section-18.14) and it is relying on the A record query happening first in the question\n> - Some other spec violation\nThe best way would be to manually construct and send some `DNSOutgoing` objects based on the 3 cases and see what the device replies with\nI'll see if I can come up with some sample test scripts \n> I'll see if I can come up with some sample test scripts\n\nThat would be awesome. Otherwise, I would have a look for myself tomorrow.\nAnd thanks again for your work \u2764\n```python\nimport asyncio\nimport logging\n\nfrom zeroconf import (\n    DNSOutgoing,\n    DNSQuestion,\n)\nfrom zeroconf.asyncio import AsyncZeroconf\nfrom zeroconf.const import _CLASS_IN, _FLAGS_QR_QUERY, _TYPE_A, _TYPE_AAAA, _TYPE_ANY\n\nlogging.basicConfig(level=logging.DEBUG)\nlogging.getLogger(\"zeroconf\").setLevel(logging.DEBUG)\nname = \"SLZB-06.local.\"\nlower_name = name.lower()\n\n\nasync def test_send_a_query_lowercase_a():\n    \"\"\"Send a query with the A record type with the lowercase name.\"\"\"\n    aiozc = AsyncZeroconf()\n    await aiozc.zeroconf.async_wait_for_start()\n    question = DNSQuestion(lower_name, _TYPE_A, _CLASS_IN)\n    outgoing = DNSOutgoing(_FLAGS_QR_QUERY)\n    outgoing.add_question(question)\n    aiozc.zeroconf.async_send(outgoing)\n    await asyncio.sleep(3)\n\n\nasync def test_send_a_query_lowercase_aaaa_and_a():\n    \"\"\"Send a query with the AAAA and A record types first.\n\n    The A record will have name compression because\n    it is the same as the AAAA record.\n    \"\"\"\n    aiozc = AsyncZeroconf()\n    await aiozc.zeroconf.async_wait_for_start()\n    question_a = DNSQuestion(lower_name, _TYPE_A, _CLASS_IN)\n    question_aaaa = DNSQuestion(lower_name, _TYPE_AAAA, _CLASS_IN)\n    outgoing = DNSOutgoing(_FLAGS_QR_QUERY)\n    outgoing.add_question(question_aaaa)\n    outgoing.add_question(question_a)\n    aiozc.zeroconf.async_send(outgoing)\n    await asyncio.sleep(3)\n\n\nasync def test_send_a_query_lowercase_any():\n    \"\"\"Send a query with the ANY record type with the lowercase name.\"\"\"\n    aiozc = AsyncZeroconf()\n    await aiozc.zeroconf.async_wait_for_start()\n    question = DNSQuestion(lower_name, _TYPE_ANY, _CLASS_IN)\n    outgoing = DNSOutgoing(_FLAGS_QR_QUERY)\n    outgoing.add_question(question)\n    aiozc.zeroconf.async_send(outgoing)\n    await asyncio.sleep(3)\n\n\nasync def test_send_a_query_uppercase_a():\n    \"\"\"Send a query with the A record type with the uppercase name.\"\"\"\n    aiozc = AsyncZeroconf()\n    await aiozc.zeroconf.async_wait_for_start()\n    question = DNSQuestion(name, _TYPE_A, _CLASS_IN)\n    outgoing = DNSOutgoing(_FLAGS_QR_QUERY)\n    outgoing.add_question(question)\n    aiozc.zeroconf.async_send(outgoing)\n    await asyncio.sleep(3)\n\n\nprint(\"Running tests\")\nprint(\"==============\")\nprint(\"test_send_a_query_lowercase_a\")\nprint(\"==============\")\nasyncio.run(test_send_a_query_lowercase_a())\nprint(\"==============\")\nprint (\"\\n\" * 10)\n\nprint(\"test_send_a_query_lowercase_aaaa_and_a\")\nprint(\"==============\")\nasyncio.run(test_send_a_query_lowercase_aaaa_and_a())\nprint(\"==============\")\nprint (\"\\n\" * 10)\n\nprint(\"test_send_a_query_lowercase_any\")\nprint(\"==============\")\nasyncio.run(test_send_a_query_lowercase_any())\nprint(\"==============\")\nprint (\"\\n\" * 10)\n\nprint(\"test_send_a_query_uppercase_a\")\nprint(\"==============\")\nasyncio.run(test_send_a_query_uppercase_a())\nprint(\"==============\")\nprint (\"\\n\" * 10)\n\nprint(\"Done\")\n\n```\n\nYou'll need to capture the stdout and stderr\n\nie\n\n`python3 debug_136864.py > debug_136864.log 2>&1`\n@Anto79-ops just sent me his logs. Confirms the device is ignoring the questions for `slzb-06.local` as well in the same way\n> might be related to [this](https://github.com/home-assistant/core/issues/135870).\n\nthis issue should be fixed in 2025.02.0b0\n\n\n\n> vendor should fix the device so it responds to `A` queries.\n\nI will look into this, but seemingly can't reproduce here yet.\n\n\n> > might be related to [this](https://github.com/home-assistant/core/issues/135870).\n> \n> this issue should be fixed in 2025.02.0b0\n> \n\n@tl-sl thanks! Please ignore my comment about #135870. I don't see that issue anymore. \n\nThe mdns is the new issue. You may wish to wait maybe 5 minutes after HA startup, then the integration goes offline but the adapter itself works perfectly well.\n\n\n\n\nAnother random thought is everyone with the issue using unifi with multicast enhancement turned on?\n> You may wish to wait maybe 5 minutes after HA startup\n\nStill waiting, its been about 2hrs without errors...\n> Another random thought is everyone with the issue using unifi with multicast enhancement turned on?>\n\n\njust checked my settings:\n\n![Image](https://github.com/user-attachments/assets/a35f2305-b734-4640-8035-74e58c64db31)\nHere's something you may want to see it seems to come back briefly and then go offline. For example, the history of one of the buttons:\n\n![Screenshot_20250129_201232_Home Assistant.jpg](https://github.com/user-attachments/assets/bfee2f45-319d-43c7-afb3-f6ed35073e27)\n\n\n> Another random thought is everyone with the issue using unifi with multicast enhancement turned on?\n\nNo Unifi at all here.\n\nSee the attached debug log from the script. As @Anto79-ops already said, from time to time the device comes accessible but I can't figure out why.\n\n[debug_136864.log](https://github.com/user-attachments/files/18598448/debug_136864.log)\n> See the attached debug log from the script. As [<img alt=\"\" width=\"16\" height=\"16\" src=\"https://avatars.githubusercontent.com/u/79593761?v=4&amp;size=80\">@Anto79-ops](https://github.com/Anto79-ops) already said, from time to time the device comes accessible but I can't figure out why.\n> \n> [debug_136864.log](https://github.com/user-attachments/files/18598448/debug_136864.log)\n\nIn your debug log you get answers right away, and everything responds as expected.\n\nI'm starting to think the device doesn't like PTR and SRV records queries in the same request\n@jpbede Can you try this version with the other record types?\n\n```\nimport asyncio\nimport logging\n\nfrom zeroconf import (\n    DNSOutgoing,\n    DNSQuestion,\n)\nfrom zeroconf.asyncio import AsyncZeroconf\nfrom zeroconf.const import (\n    _CLASS_IN,\n    _FLAGS_QR_QUERY,\n    _TYPE_A,\n    _TYPE_AAAA,\n    _TYPE_ANY,\n    _TYPE_TXT,\n    _TYPE_SRV,\n)\n\nlogging.basicConfig(level=logging.DEBUG)\nlogging.getLogger(\"zeroconf\").setLevel(logging.DEBUG)\nname = \"SLZB-06.local.\"\nlower_name = name.lower()\n\n\nasync def test_send_a_aaaa_query_lowercase_a_with_srv_txt():\n    \"\"\"Send a query with the A record type with the lowercase name.\"\"\"\n    aiozc = AsyncZeroconf()\n    await aiozc.zeroconf.async_wait_for_start()\n    outgoing = DNSOutgoing(_FLAGS_QR_QUERY)\n    outgoing.add_question(DNSQuestion(lower_name, _TYPE_SRV, _CLASS_IN))\n    outgoing.add_question(DNSQuestion(lower_name, _TYPE_TXT, _CLASS_IN))\n    outgoing.add_question(DNSQuestion(lower_name, _TYPE_A, _CLASS_IN))\n    outgoing.add_question(DNSQuestion(lower_name, _TYPE_AAAA, _CLASS_IN))\n    aiozc.zeroconf.async_send(outgoing)\n    await asyncio.sleep(3)\n\n\nprint(\"Running tests\")\nprint(\"==============\")\nprint(\"test_send_a_aaaa_query_lowercase_a_with_srv_txt\")\nprint(\"==============\")\nasyncio.run(test_send_a_aaaa_query_lowercase_a_with_srv_txt())\nprint(\"==============\")\nprint(\"\\n\" * 10)\n\n\nprint(\"Done\")\n```\n> @jpbede Can you try this version with the other record types?\n\nSure, here you go. From my pov, the device has not answered this question.\n\n[debug_136864 (1).log](https://github.com/user-attachments/files/18607350/debug_136864.1.log)\nSo it seems that by asking for the TXT and SRV records in addition to the A and AAAA records it causes the query to fail\nWe don't actually need the SRV and TXT record requests so I've added a new class in zeroconf 0.142.0 to be able to make the request without them\n\nhttps://github.com/home-assistant/core/pull/136940\n\n\nOnce thats in we can bump the `aiohttp-asyncmdnsresolver` to 0.0.2 which uses the new built-in zeroconf resolver classes https://github.com/aio-libs/aiohttp-asyncmdnsresolver/releases/tag/v0.0.2", "created_at": "2025-01-30T19:01:12Z"}
{"repo": "home-assistant/core", "pull_number": 136927, "instance_id": "home-assistant__core-136927", "issue_numbers": ["133965"], "base_commit": "bab616fa61a8a94d6144776a32e0c6d444f702a7", "patch": "diff --git a/homeassistant/components/xbox/__init__.py b/homeassistant/components/xbox/__init__.py\nindex 5282a34903a3b9..ab0d510a7095a8 100644\n--- a/homeassistant/components/xbox/__init__.py\n+++ b/homeassistant/components/xbox/__init__.py\n@@ -6,6 +6,7 @@\n \n from xbox.webapi.api.client import XboxLiveClient\n from xbox.webapi.api.provider.smartglass.models import SmartglassConsoleList\n+from xbox.webapi.common.signed_session import SignedSession\n \n from homeassistant.config_entries import ConfigEntry\n from homeassistant.const import Platform\n@@ -36,7 +37,8 @@ async def async_setup_entry(hass: HomeAssistant, entry: ConfigEntry) -> bool:\n         )\n     )\n     session = config_entry_oauth2_flow.OAuth2Session(hass, entry, implementation)\n-    auth = api.AsyncConfigEntryAuth(session)\n+    signed_session = await hass.async_add_executor_job(SignedSession)\n+    auth = api.AsyncConfigEntryAuth(signed_session, session)\n \n     client = XboxLiveClient(auth)\n     consoles: SmartglassConsoleList = await client.smartglass.get_console_list()\ndiff --git a/homeassistant/components/xbox/api.py b/homeassistant/components/xbox/api.py\nindex d4c47e4cc394db..9fa7c14b5c9b02 100644\n--- a/homeassistant/components/xbox/api.py\n+++ b/homeassistant/components/xbox/api.py\n@@ -11,10 +11,12 @@\n class AsyncConfigEntryAuth(AuthenticationManager):\n     \"\"\"Provide xbox authentication tied to an OAuth2 based config entry.\"\"\"\n \n-    def __init__(self, oauth_session: OAuth2Session) -> None:\n+    def __init__(\n+        self, signed_session: SignedSession, oauth_session: OAuth2Session\n+    ) -> None:\n         \"\"\"Initialize xbox auth.\"\"\"\n         # Leaving out client credentials as they are handled by Home Assistant\n-        super().__init__(SignedSession(), \"\", \"\", \"\")\n+        super().__init__(signed_session, \"\", \"\", \"\")\n         self._oauth_session = oauth_session\n         self.oauth = self._get_oauth_token()\n \n", "test_patch": "", "problem_statement": "Detected blocking call inside the event loop\n### The problem\n\n\r\nhello\r\n\r\nreceived this log upon updating to 2025.1.0b2\r\n\r\nthanks\r\n\r\n```\r\nLogger: homeassistant.util.loop\r\nSource: util/loop.py:136\r\nFirst occurred: 9:14:05 AM (1 occurrences)\r\nLast logged: 9:14:05 AM\r\n\r\nDetected blocking call to load_verify_locations with args (<ssl.SSLContext object at 0x7f0de387ca70>,) inside the event loop by integration 'xbox' at homeassistant/components/xbox/api.py, line 17: super().__init__(SignedSession(), \"\", \"\", \"\") (offender: /usr/local/lib/python3.13/site-packages/httpx/_config.py, line 149: context.load_verify_locations(cafile=cafile)), please create a bug report at https://github.com/home-assistant/core/issues?q=is%3Aopen+is%3Aissue+label%3A%22integration%3A+xbox%22 For developers, please see https://developers.home-assistant.io/docs/asyncio_blocking_operations/#load_verify_locations Traceback (most recent call last): File \"<frozen runpy>\", line 198, in _run_module_as_main File \"<frozen runpy>\", line 88, in _run_code File \"/usr/src/homeassistant/homeassistant/__main__.py\", line 227, in <module> sys.exit(main()) File \"/usr/src/homeassistant/homeassistant/__main__.py\", line 213, in main exit_code = runner.run(runtime_conf) File \"/usr/src/homeassistant/homeassistant/runner.py\", line 154, in run return loop.run_until_complete(setup_and_run_hass(runtime_config)) File \"/usr/local/lib/python3.13/asyncio/base_events.py\", line 707, in run_until_complete self.run_forever() File \"/usr/local/lib/python3.13/asyncio/base_events.py\", line 678, in run_forever self._run_once() File \"/usr/local/lib/python3.13/asyncio/base_events.py\", line 2033, in _run_once handle._run() File \"/usr/local/lib/python3.13/asyncio/events.py\", line 89, in _run self._context.run(self._callback, *self._args) File \"/usr/src/homeassistant/homeassistant/config_entries.py\", line 788, in async_setup_locked await self.async_setup(hass, integration=integration) File \"/usr/src/homeassistant/homeassistant/config_entries.py\", line 551, in async_setup await self.__async_setup_with_context(hass, integration) File \"/usr/src/homeassistant/homeassistant/config_entries.py\", line 640, in __async_setup_with_context result = await component.async_setup_entry(hass, self) File \"/usr/src/homeassistant/homeassistant/components/xbox/__init__.py\", line 39, in async_setup_entry auth = api.AsyncConfigEntryAuth(session) File \"/usr/src/homeassistant/homeassistant/components/xbox/api.py\", line 17, in __init__ super().__init__(SignedSession(), \"\", \"\", \"\")\r\n```\n\n### What version of Home Assistant Core has the issue?\n\n2025.0.0b2\n\n### What was the last working version of Home Assistant Core?\n\nnot sure\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\n_No response_\n\n### Link to integration documentation on our website\n\n_No response_\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n_No response_\n\n### Anything in the logs that might be useful for us?\n\n_No response_\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @hunterjm, mind taking a look at this issue as it has been labeled with an integration (`xbox`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1713) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `xbox` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign xbox` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[xbox documentation](https://www.home-assistant.io/integrations/xbox)\n[xbox source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/xbox)\n<sub><sup>(message by IssueLinks)</sup></sub>\n@hunterjm I raised a PR for the underlying library that will allow us to pass in an SSLContext. This won't directly fix the issue, we need to change:\r\n`super().__init__(SignedSession(), \"\", \"\", \"\")`\r\nto\r\n`super().__init__(SignedSession(ssl_context=get_default_context()), \"\", \"\", \"\")`\r\n\r\nAs well, which I have a PR ready to go for once a new version of the library is cut.\nHmm, ideally we use our own httpx client rather than theirs. But they expect a signed session and have that extended rather than wrapped\nAgreed, but like you said, not the way the library is written. If you check the AuthenticationManager, it seems to have been an intentional change:\r\n```\r\n        if not isinstance(client_session, (SignedSession, httpx.AsyncClient)):\r\n            raise DeprecationWarning(\r\n                \"\"\"Xbox WebAPI changed to use SignedSession (wrapped httpx.AsyncClient).\r\n                Please check the documentation\"\"\"\r\n            )\r\n```\r\n\r\nSo my thought was, short of drastic changes to the library (that I don't even know if the author will accept -- this seems to be used by a lot more than just HA), this was a simple fix that at least eliminates the blocking IO and eliminates creating an extra SSL context.\nMy PR to the upstream library hasn't been reviewed yet so I don't think this is going to make it into the 2025.1 milestone\nI'm also experiencing this. I've manually updated the file [xbox/webapi/common/signed_session.py](https://github.com/OpenXbox/xbox-webapi-python/pull/113/commits/29e35636dbc9887e89379e7a97eb2327f22938c6#diff-617c53c785e4f32214a683ffc711227717de8895803b00b6770d12e0ae28cb99) on my installation to include this commit, however this didn't solve the warning message in the logs.\nYou can\u2019t just overrwrite the file. Every time you run HA it\u2019s going to overwrite your manual change with the original\nThe changes I've made appear to have persisted a HA OS reboot. but I understand this is not the proper way to do these things. \nOk. As I mentioned though, that PR won\u2019t fix the issue anyway. It adds the ability to fix it in HA but an HA change is needed. I can\u2019t do that till the library pr is merged\nI think it would work if we create the SignedSession in the executor I think.\r\n\r\nBut ideally we pass in our own httpx client to the library\r\n\r\n\nWe may have to go the executor route if we want this fixed, the library author still hasn't responded to my PR.", "created_at": "2025-01-30T15:09:24Z"}
{"repo": "home-assistant/core", "pull_number": 136919, "instance_id": "home-assistant__core-136919", "issue_numbers": ["135737"], "base_commit": "5dd147e83b3f02e7da75c33513760967b51850b9", "patch": "diff --git a/homeassistant/components/youless/sensor.py b/homeassistant/components/youless/sensor.py\nindex 3afb215ed5f5a2..db8244c0b0662c 100644\n--- a/homeassistant/components/youless/sensor.py\n+++ b/homeassistant/components/youless/sensor.py\n@@ -36,7 +36,7 @@ class YouLessSensorEntityDescription(SensorEntityDescription):\n     \"\"\"Describes a YouLess sensor entity.\"\"\"\n \n     device_group: str\n-    value_func: Callable[[YoulessAPI], float | None]\n+    value_func: Callable[[YoulessAPI], float | None | str]\n \n \n SENSOR_TYPES: tuple[YouLessSensorEntityDescription, ...] = (\n@@ -212,6 +212,38 @@ class YouLessSensorEntityDescription(SensorEntityDescription):\n             lambda device: device.phase3.current.value if device.phase1 else None\n         ),\n     ),\n+    YouLessSensorEntityDescription(\n+        key=\"tariff\",\n+        device_group=\"power\",\n+        translation_key=\"active_tariff\",\n+        device_class=SensorDeviceClass.ENUM,\n+        options=[\"1\", \"2\"],\n+        value_func=(\n+            lambda device: str(device.current_tariff) if device.current_tariff else None\n+        ),\n+    ),\n+    YouLessSensorEntityDescription(\n+        key=\"average_peak\",\n+        device_group=\"power\",\n+        translation_key=\"average_peak\",\n+        device_class=SensorDeviceClass.POWER,\n+        state_class=SensorStateClass.MEASUREMENT,\n+        native_unit_of_measurement=UnitOfPower.WATT,\n+        value_func=(\n+            lambda device: device.average_power.value if device.average_power else None\n+        ),\n+    ),\n+    YouLessSensorEntityDescription(\n+        key=\"month_peak\",\n+        device_group=\"power\",\n+        translation_key=\"month_peak\",\n+        device_class=SensorDeviceClass.POWER,\n+        state_class=SensorStateClass.MEASUREMENT,\n+        native_unit_of_measurement=UnitOfPower.WATT,\n+        value_func=(\n+            lambda device: device.peak_power.value if device.peak_power else None\n+        ),\n+    ),\n     YouLessSensorEntityDescription(\n         key=\"delivery_low\",\n         device_group=\"delivery\",\ndiff --git a/homeassistant/components/youless/strings.json b/homeassistant/components/youless/strings.json\nindex 8a3f6cb5d8b4f3..c735e2b2ff2e55 100644\n--- a/homeassistant/components/youless/strings.json\n+++ b/homeassistant/components/youless/strings.json\n@@ -52,6 +52,9 @@\n       \"active_current_phase_a\": {\n         \"name\": \"Current phase {phase}\"\n       },\n+      \"active_tariff\": {\n+        \"name\": \"Tariff\"\n+      },\n       \"total_energy_import_tariff_kwh\": {\n         \"name\": \"Energy import tariff {tariff}\"\n       },\n@@ -66,6 +69,12 @@\n       },\n       \"active_s0_w\": {\n         \"name\": \"Current usage\"\n+      },\n+      \"average_peak\": {\n+        \"name\": \"Average peak\"\n+      },\n+      \"month_peak\": {\n+        \"name\": \"Month peak\"\n       }\n     }\n   }\n", "test_patch": "diff --git a/tests/components/youless/__init__.py b/tests/components/youless/__init__.py\nindex 8770a7e2dc8fe0..03db24cb7f76e0 100644\n--- a/tests/components/youless/__init__.py\n+++ b/tests/components/youless/__init__.py\n@@ -25,6 +25,11 @@ async def init_component(hass: HomeAssistant) -> MockConfigEntry:\n             json=load_json_array_fixture(\"enologic.json\", youless.DOMAIN),\n             headers={\"Content-Type\": \"application/json\"},\n         )\n+        mock.get(\n+            \"http://1.1.1.1/f\",\n+            json=load_json_object_fixture(\"phase.json\", youless.DOMAIN),\n+            headers={\"Content-Type\": \"application/json\"},\n+        )\n \n         entry = MockConfigEntry(\n             domain=youless.DOMAIN,\ndiff --git a/tests/components/youless/fixtures/device.json b/tests/components/youless/fixtures/device.json\nindex 7d089851923bca..82d07dba739a04 100644\n--- a/tests/components/youless/fixtures/device.json\n+++ b/tests/components/youless/fixtures/device.json\n@@ -1,5 +1,5 @@\n {\n   \"model\": \"LS120\",\n-  \"fw\": \"1.4.2-EL\",\n+  \"fw\": \"1.5.1-EL\",\n   \"mac\": \"de2:2d2:3d23\"\n }\ndiff --git a/tests/components/youless/fixtures/phase.json b/tests/components/youless/fixtures/phase.json\nnew file mode 100644\nindex 00000000000000..8a5aa3215ef8f6\n--- /dev/null\n+++ b/tests/components/youless/fixtures/phase.json\n@@ -0,0 +1,15 @@\n+{\n+  \"tr\": 1,\n+  \"i1\": 0.123,\n+  \"v1\": 240,\n+  \"l1\": 462,\n+  \"v2\": 240,\n+  \"l2\": 230,\n+  \"i2\": 0.123,\n+  \"v3\": 240,\n+  \"l3\": 230,\n+  \"i3\": 0.123,\n+  \"pp\": 1200,\n+  \"pts\": 2501301621,\n+  \"pa\": 400\n+}\ndiff --git a/tests/components/youless/snapshots/test_sensor.ambr b/tests/components/youless/snapshots/test_sensor.ambr\nindex 0647d854d2a806..9e79b5b9b5ec7f 100644\n--- a/tests/components/youless/snapshots/test_sensor.ambr\n+++ b/tests/components/youless/snapshots/test_sensor.ambr\n@@ -152,6 +152,57 @@\n     'state': '1624.264',\n   })\n # ---\n+# name: test_sensors[sensor.power_meter_average_peak-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.power_meter_average_peak',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+    }),\n+    'original_device_class': <SensorDeviceClass.POWER: 'power'>,\n+    'original_icon': None,\n+    'original_name': 'Average peak',\n+    'platform': 'youless',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'average_peak',\n+    'unique_id': 'youless_localhost_average_peak',\n+    'unit_of_measurement': <UnitOfPower.WATT: 'W'>,\n+  })\n+# ---\n+# name: test_sensors[sensor.power_meter_average_peak-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'power',\n+      'friendly_name': 'Power meter Average peak',\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+      'unit_of_measurement': <UnitOfPower.WATT: 'W'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.power_meter_average_peak',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '400',\n+  })\n+# ---\n # name: test_sensors[sensor.power_meter_current_phase_1-entry]\n   EntityRegistryEntrySnapshot({\n     'aliases': set({\n@@ -200,7 +251,7 @@\n     'last_changed': <ANY>,\n     'last_reported': <ANY>,\n     'last_updated': <ANY>,\n-    'state': 'unknown',\n+    'state': '0.123',\n   })\n # ---\n # name: test_sensors[sensor.power_meter_current_phase_2-entry]\n@@ -251,7 +302,7 @@\n     'last_changed': <ANY>,\n     'last_reported': <ANY>,\n     'last_updated': <ANY>,\n-    'state': 'unknown',\n+    'state': '0.123',\n   })\n # ---\n # name: test_sensors[sensor.power_meter_current_phase_3-entry]\n@@ -302,7 +353,7 @@\n     'last_changed': <ANY>,\n     'last_reported': <ANY>,\n     'last_updated': <ANY>,\n-    'state': 'unknown',\n+    'state': '0.123',\n   })\n # ---\n # name: test_sensors[sensor.power_meter_current_power_usage-entry]\n@@ -458,6 +509,57 @@\n     'state': '4490.631',\n   })\n # ---\n+# name: test_sensors[sensor.power_meter_month_peak-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.power_meter_month_peak',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+    }),\n+    'original_device_class': <SensorDeviceClass.POWER: 'power'>,\n+    'original_icon': None,\n+    'original_name': 'Month peak',\n+    'platform': 'youless',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'month_peak',\n+    'unique_id': 'youless_localhost_month_peak',\n+    'unit_of_measurement': <UnitOfPower.WATT: 'W'>,\n+  })\n+# ---\n+# name: test_sensors[sensor.power_meter_month_peak-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'power',\n+      'friendly_name': 'Power meter Month peak',\n+      'state_class': <SensorStateClass.MEASUREMENT: 'measurement'>,\n+      'unit_of_measurement': <UnitOfPower.WATT: 'W'>,\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.power_meter_month_peak',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '1200',\n+  })\n+# ---\n # name: test_sensors[sensor.power_meter_power_phase_1-entry]\n   EntityRegistryEntrySnapshot({\n     'aliases': set({\n@@ -506,7 +608,7 @@\n     'last_changed': <ANY>,\n     'last_reported': <ANY>,\n     'last_updated': <ANY>,\n-    'state': 'unknown',\n+    'state': '462',\n   })\n # ---\n # name: test_sensors[sensor.power_meter_power_phase_2-entry]\n@@ -557,7 +659,7 @@\n     'last_changed': <ANY>,\n     'last_reported': <ANY>,\n     'last_updated': <ANY>,\n-    'state': 'unknown',\n+    'state': '230',\n   })\n # ---\n # name: test_sensors[sensor.power_meter_power_phase_3-entry]\n@@ -608,7 +710,63 @@\n     'last_changed': <ANY>,\n     'last_reported': <ANY>,\n     'last_updated': <ANY>,\n-    'state': 'unknown',\n+    'state': '230',\n+  })\n+# ---\n+# name: test_sensors[sensor.power_meter_tariff-entry]\n+  EntityRegistryEntrySnapshot({\n+    'aliases': set({\n+    }),\n+    'area_id': None,\n+    'capabilities': dict({\n+      'options': list([\n+        '1',\n+        '2',\n+      ]),\n+    }),\n+    'config_entry_id': <ANY>,\n+    'device_class': None,\n+    'device_id': <ANY>,\n+    'disabled_by': None,\n+    'domain': 'sensor',\n+    'entity_category': None,\n+    'entity_id': 'sensor.power_meter_tariff',\n+    'has_entity_name': True,\n+    'hidden_by': None,\n+    'icon': None,\n+    'id': <ANY>,\n+    'labels': set({\n+    }),\n+    'name': None,\n+    'options': dict({\n+    }),\n+    'original_device_class': <SensorDeviceClass.ENUM: 'enum'>,\n+    'original_icon': None,\n+    'original_name': 'Tariff',\n+    'platform': 'youless',\n+    'previous_unique_id': None,\n+    'supported_features': 0,\n+    'translation_key': 'active_tariff',\n+    'unique_id': 'youless_localhost_tariff',\n+    'unit_of_measurement': None,\n+  })\n+# ---\n+# name: test_sensors[sensor.power_meter_tariff-state]\n+  StateSnapshot({\n+    'attributes': ReadOnlyDict({\n+      'device_class': 'enum',\n+      'friendly_name': 'Power meter Tariff',\n+      'options': list([\n+        '1',\n+        '2',\n+      ]),\n+    }),\n+    'context': <ANY>,\n+    'entity_id': 'sensor.power_meter_tariff',\n+    'last_changed': <ANY>,\n+    'last_reported': <ANY>,\n+    'last_updated': <ANY>,\n+    'state': '1',\n   })\n # ---\n # name: test_sensors[sensor.power_meter_total_energy_import-entry]\n@@ -710,7 +868,7 @@\n     'last_changed': <ANY>,\n     'last_reported': <ANY>,\n     'last_updated': <ANY>,\n-    'state': 'unknown',\n+    'state': '240',\n   })\n # ---\n # name: test_sensors[sensor.power_meter_voltage_phase_2-entry]\n@@ -761,7 +919,7 @@\n     'last_changed': <ANY>,\n     'last_reported': <ANY>,\n     'last_updated': <ANY>,\n-    'state': 'unknown',\n+    'state': '240',\n   })\n # ---\n # name: test_sensors[sensor.power_meter_voltage_phase_3-entry]\n@@ -812,7 +970,7 @@\n     'last_changed': <ANY>,\n     'last_reported': <ANY>,\n     'last_updated': <ANY>,\n-    'state': 'unknown',\n+    'state': '240',\n   })\n # ---\n # name: test_sensors[sensor.s0_meter_current_usage-entry]\ndiff --git a/tests/components/youless/test_init.py b/tests/components/youless/test_init.py\nindex 29db8c66af0b57..9f0956cea359a6 100644\n--- a/tests/components/youless/test_init.py\n+++ b/tests/components/youless/test_init.py\n@@ -15,4 +15,4 @@ async def test_async_setup_entry(hass: HomeAssistant) -> None:\n \n     assert await setup.async_setup_component(hass, youless.DOMAIN, {})\n     assert entry.state is ConfigEntryState.LOADED\n-    assert len(hass.states.async_entity_ids()) == 19\n+    assert len(hass.states.async_entity_ids()) == 22\n", "problem_statement": "Youless integration - missing Belgian info Tarif & Month peak\n### The problem\n\nHi, \nIn order to do load balancing with my consumed electricity and EV charging, I installed as a first step the Youless dongle and integrated in HA. All works well, but I am missing the following 2 parameters which are essential in Belgium. These are the \"Tarif\" and the \"Month Peak\". \nI see the values in the Youless app, but can't get it into HA. \nCould anyone help to visualize please? \n\n\n### What version of Home Assistant Core has the issue?\n\ncore-2025.1.2\n\n### What was the last working version of Home Assistant Core?\n\ncore-2025.1.2\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nYouless\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/youless\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n```yaml\n\n```\n\n### Anything in the logs that might be useful for us?\n\n```txt\n\n```\n\n### Additional information\n\n\n![Image](https://github.com/user-attachments/assets/06a69b13-2094-4a10-a263-9f73d65a3a7f)\n", "hints_text": "\nHey there @gjong, mind taking a look at this issue as it has been labeled with an integration (`youless`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1752) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `youless` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign youless` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[youless documentation](https://www.home-assistant.io/integrations/youless)\n[youless source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/youless)\n<sub><sup>(message by IssueLinks)</sup></sub>\nI will need to have a deeper look into the integration. The Tarif should be exposed in the library underneath. The Month peak I have no clue what that is, so that must have been added recently in the firmware. I will need to dig up the latest documentation and check for you.\n@MikeLeem could you share an example JSON from the YouLess device phase end point. You can access this by loading:\n\n    http://<youless_ip>/f\n\nThe documentation is a bit vague about how the response values would look.\n\nhttps://github.com/gjong\u2002\u2002\nHello,\nPlease find the printscreen of the measurement points.\nI believe the required sensors are (from what I can see):\n\n  *\n\"tr\" which is the Tarif. Status can be 1 or 2 in value.\n  *\n\"pp\" which is the Month peak. This value is expressed in unit Watt\n\n[cid:09958ac4-9520-404a-8288-080143ce93da]\n\nThanks!\n\nSorry.. Now with the correct picture: \n\n\n<img width=\"149\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/2e248c0c-54b3-412c-b3c7-8179b018083a\" />\n\n________________________________\nFrom: Gerben Jongerius ***@***.***>\nSent: Thursday, January 16, 2025 12:23\nTo: home-assistant/core ***@***.***>\nCc: MikeLeem ***@***.***>; Mention ***@***.***>\nSubject: Re: [home-assistant/core] Youless integration - missing Belgian info Tarif & Month peak (Issue #135737)\n\n\n@MikeLeem<https://github.com/MikeLeem> could you share an example JSON from the YouLess device phase end point. You can access this by loading:\n\nhttp://<youless_ip>/f\n\n\nThe documentation is a bit vague about how the response values would look.\n\n\u2014\nReply to this email directly, view it on GitHub<https://github.com/home-assistant/core/issues/135737#issuecomment-2595261361>, or unsubscribe<https://github.com/notifications/unsubscribe-auth/BORLL5FMDG47JOTCS7J7DB32K6JCPAVCNFSM6AAAAABVIHNKDKVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMZDKOJVGI3DCMZWGE>.\nYou are receiving this because you were mentioned.\n", "created_at": "2025-01-30T12:20:14Z"}
{"repo": "home-assistant/core", "pull_number": 136911, "instance_id": "home-assistant__core-136911", "issue_numbers": ["136863"], "base_commit": "5dd147e83b3f02e7da75c33513760967b51850b9", "patch": "diff --git a/homeassistant/components/opower/coordinator.py b/homeassistant/components/opower/coordinator.py\nindex f6f3524d630875..6957ae4984c73a 100644\n--- a/homeassistant/components/opower/coordinator.py\n+++ b/homeassistant/components/opower/coordinator.py\n@@ -5,18 +5,16 @@\n from types import MappingProxyType\n from typing import Any, cast\n \n-import aiohttp\n from opower import (\n     Account,\n     AggregateType,\n-    CannotConnect,\n     CostRead,\n     Forecast,\n-    InvalidAuth,\n     MeterType,\n     Opower,\n     ReadResolution,\n )\n+from opower.exceptions import ApiException, CannotConnect, InvalidAuth\n \n from homeassistant.components.recorder import get_instance\n from homeassistant.components.recorder.models import StatisticData, StatisticMetaData\n@@ -89,7 +87,7 @@ async def _async_update_data(\n             raise UpdateFailed(f\"Error during login: {err}\") from err\n         try:\n             forecasts: list[Forecast] = await self.api.async_get_forecast()\n-        except aiohttp.ClientError as err:\n+        except ApiException as err:\n             _LOGGER.error(\"Error getting forecasts: %s\", err)\n             raise\n         _LOGGER.debug(\"Updating sensor data with: %s\", forecasts)\n@@ -102,7 +100,7 @@ async def _insert_statistics(self) -> None:\n         \"\"\"Insert Opower statistics.\"\"\"\n         try:\n             accounts = await self.api.async_get_accounts()\n-        except aiohttp.ClientError as err:\n+        except ApiException as err:\n             _LOGGER.error(\"Error getting accounts: %s\", err)\n             raise\n         for account in accounts:\n@@ -271,7 +269,7 @@ def _update_with_finer_cost_reads(\n             cost_reads = await self.api.async_get_cost_reads(\n                 account, AggregateType.BILL, start, end\n             )\n-        except aiohttp.ClientError as err:\n+        except ApiException as err:\n             _LOGGER.error(\"Error getting monthly cost reads: %s\", err)\n             raise\n         _LOGGER.debug(\"Got %s monthly cost reads\", len(cost_reads))\n@@ -290,7 +288,7 @@ def _update_with_finer_cost_reads(\n             daily_cost_reads = await self.api.async_get_cost_reads(\n                 account, AggregateType.DAY, start, end\n             )\n-        except aiohttp.ClientError as err:\n+        except ApiException as err:\n             _LOGGER.error(\"Error getting daily cost reads: %s\", err)\n             raise\n         _LOGGER.debug(\"Got %s daily cost reads\", len(daily_cost_reads))\n@@ -308,7 +306,7 @@ def _update_with_finer_cost_reads(\n             hourly_cost_reads = await self.api.async_get_cost_reads(\n                 account, AggregateType.HOUR, start, end\n             )\n-        except aiohttp.ClientError as err:\n+        except ApiException as err:\n             _LOGGER.error(\"Error getting hourly cost reads: %s\", err)\n             raise\n         _LOGGER.debug(\"Got %s hourly cost reads\", len(hourly_cost_reads))\ndiff --git a/homeassistant/components/opower/manifest.json b/homeassistant/components/opower/manifest.json\nindex 7227f7171ac0a6..d168cba5752847 100644\n--- a/homeassistant/components/opower/manifest.json\n+++ b/homeassistant/components/opower/manifest.json\n@@ -7,5 +7,5 @@\n   \"documentation\": \"https://www.home-assistant.io/integrations/opower\",\n   \"iot_class\": \"cloud_polling\",\n   \"loggers\": [\"opower\"],\n-  \"requirements\": [\"opower==0.8.8\"]\n+  \"requirements\": [\"opower==0.8.9\"]\n }\ndiff --git a/homeassistant/components/opower/sensor.py b/homeassistant/components/opower/sensor.py\nindex 7f8eb22d1e645c..f9d0fe6233270f 100644\n--- a/homeassistant/components/opower/sensor.py\n+++ b/homeassistant/components/opower/sensor.py\n@@ -97,7 +97,7 @@ class OpowerEntityDescription(SensorEntityDescription):\n         device_class=SensorDeviceClass.DATE,\n         entity_category=EntityCategory.DIAGNOSTIC,\n         entity_registry_enabled_default=False,\n-        value_fn=lambda data: data.start_date,\n+        value_fn=lambda data: str(data.start_date),\n     ),\n     OpowerEntityDescription(\n         key=\"elec_end_date\",\n@@ -105,7 +105,7 @@ class OpowerEntityDescription(SensorEntityDescription):\n         device_class=SensorDeviceClass.DATE,\n         entity_category=EntityCategory.DIAGNOSTIC,\n         entity_registry_enabled_default=False,\n-        value_fn=lambda data: data.end_date,\n+        value_fn=lambda data: str(data.end_date),\n     ),\n )\n GAS_SENSORS: tuple[OpowerEntityDescription, ...] = (\n@@ -169,7 +169,7 @@ class OpowerEntityDescription(SensorEntityDescription):\n         device_class=SensorDeviceClass.DATE,\n         entity_category=EntityCategory.DIAGNOSTIC,\n         entity_registry_enabled_default=False,\n-        value_fn=lambda data: data.start_date,\n+        value_fn=lambda data: str(data.start_date),\n     ),\n     OpowerEntityDescription(\n         key=\"gas_end_date\",\n@@ -177,7 +177,7 @@ class OpowerEntityDescription(SensorEntityDescription):\n         device_class=SensorDeviceClass.DATE,\n         entity_category=EntityCategory.DIAGNOSTIC,\n         entity_registry_enabled_default=False,\n-        value_fn=lambda data: data.end_date,\n+        value_fn=lambda data: str(data.end_date),\n     ),\n )\n \ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 16079cca64dab0..2025cbbd0ac9c4 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -1592,7 +1592,7 @@ openwrt-luci-rpc==1.1.17\n openwrt-ubus-rpc==0.0.2\n \n # homeassistant.components.opower\n-opower==0.8.8\n+opower==0.8.9\n \n # homeassistant.components.oralb\n oralb-ble==0.17.6\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex a5bd58dff58c64..9575401c62cea3 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -1328,7 +1328,7 @@ openhomedevice==2.2.0\n openwebifpy==4.3.1\n \n # homeassistant.components.opower\n-opower==0.8.8\n+opower==0.8.9\n \n # homeassistant.components.oralb\n oralb-ble==0.17.6\n", "problem_statement": "No AMI UtilityAccounts found\n### The problem\n\nhello!\n\nUpon updating to 2025.2.0b0, i noticed this log that appears. It also appears when i reload the integation.\n\nThe provider is Enmax.\n\nthanks\n\n```\nLogger: /usr/local/lib/python3.13/site-packages/opower/opower.py\nSource: components/opower/coordinator.py:91\nFirst occurred: 11:04:58 AM (1 occurrences)\nLast logged: 11:04:58 AM\n\nError server response: {\"error\":{\"details\":\"No AMI UtilityAccounts found for specified customer.\",\"serviceErrorCode\":\"NO_AMI_ACCOUNTS\"}}\n```\n\n### What version of Home Assistant Core has the issue?\n\n2025.2.0b0\n\n### What was the last working version of Home Assistant Core?\n\n2025.1.x\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nOpower Enmax\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/opower/\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n```yaml\n\n```\n\n### Anything in the logs that might be useful for us?\n\n```txt\n\n```\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @tronikos, mind taking a look at this issue as it has been labeled with an integration (`opower`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1106) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `opower` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign opower` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[opower documentation](https://www.home-assistant.io/integrations/opower)\n[opower source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/opower)\n<sub><sup>(message by IssueLinks)</sup></sub>\nCan you enable debug logs and attach them here or privately share them with me on discord?", "created_at": "2025-01-30T10:48:06Z"}
{"repo": "home-assistant/core", "pull_number": 136910, "instance_id": "home-assistant__core-136910", "issue_numbers": ["136897"], "base_commit": "9eb383f3148c559995631bc4ae44269f67d9f3cd", "patch": "diff --git a/homeassistant/components/onedrive/backup.py b/homeassistant/components/onedrive/backup.py\nindex a5a5c01979779f..94d60bc6398125 100644\n--- a/homeassistant/components/onedrive/backup.py\n+++ b/homeassistant/components/onedrive/backup.py\n@@ -190,7 +190,13 @@ async def async_delete_backup(\n         **kwargs: Any,\n     ) -> None:\n         \"\"\"Delete a backup file.\"\"\"\n-        await self._get_backup_file_item(backup_id).delete()\n+\n+        try:\n+            await self._get_backup_file_item(backup_id).delete()\n+        except APIError as err:\n+            if err.response_status_code == 404:\n+                return\n+            raise\n \n     @handle_backup_errors\n     async def async_list_backups(self, **kwargs: Any) -> list[AgentBackup]:\n", "test_patch": "diff --git a/tests/components/onedrive/test_backup.py b/tests/components/onedrive/test_backup.py\nindex a3d1129377fc88..3492202d3feb08 100644\n--- a/tests/components/onedrive/test_backup.py\n+++ b/tests/components/onedrive/test_backup.py\n@@ -156,6 +156,28 @@ async def test_agents_delete(\n     mock_drive_items.delete.assert_called_once()\n \n \n+async def test_agents_delete_not_found_does_not_throw(\n+    hass: HomeAssistant,\n+    hass_ws_client: WebSocketGenerator,\n+    mock_drive_items: MagicMock,\n+) -> None:\n+    \"\"\"Test agent delete backup.\"\"\"\n+    mock_drive_items.delete = AsyncMock(side_effect=APIError(response_status_code=404))\n+    client = await hass_ws_client(hass)\n+\n+    await client.send_json_auto_id(\n+        {\n+            \"type\": \"backup/delete\",\n+            \"backup_id\": BACKUP_METADATA[\"backup_id\"],\n+        }\n+    )\n+    response = await client.receive_json()\n+\n+    assert response[\"success\"]\n+    assert response[\"result\"] == {\"agent_errors\": {}}\n+    mock_drive_items.delete.assert_called_once()\n+\n+\n async def test_agents_upload(\n     hass_client: ClientSessionGenerator,\n     caplog: pytest.LogCaptureFixture,\n@@ -257,7 +279,7 @@ async def test_agents_download(\n     (\"side_effect\", \"error\"),\n     [\n         (\n-            APIError(response_status_code=404, message=\"File not found.\"),\n+            APIError(response_status_code=500),\n             \"Backup operation failed\",\n         ),\n         (TimeoutError(), \"Backup operation timed out\"),\n", "problem_statement": "Backup Error 2025.2.0b1\n### The problem\n\nBackup throws this error when backing up.  Two backups have been made and the retain setting is 6 \n```\n2025-01-30 02:19:57.150 ERROR (MainThread) [homeassistant.components.onedrive.backup] Error during backup in async_delete_backup: Status 404, message None\n2025-01-30 02:19:57.242 ERROR (MainThread) [homeassistant.components.backup] Error deleting old copies: {'a694ecad': {'onedrive.D378A3F5743D8717': BackupAgentError('Backup operation failed')}}\n```\nI'm backing up to local, local network share, Google Drive, and One Drive\n\n\n### What version of Home Assistant Core has the issue?\n\n2025.2.0b1\n\n### What was the last working version of Home Assistant Core?\n\n2025.1.1\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nBackup\n\n### Link to integration documentation on our website\n\n_No response_\n\n### Diagnostics information\n\n_No response_\n\n### Example YAML snippet\n\n```yaml\n\n```\n\n### Anything in the logs that might be useful for us?\n\n```txt\n\n```\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @home-assistant/core, mind taking a look at this issue as it has been labeled with an integration (`backup`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L183) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `backup` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign backup` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[backup documentation](https://www.home-assistant.io/integrations/backup)\n[backup source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/backup)\n<sub><sup>(message by IssueLinks)</sup></sub>\n\nHey there @zweckj, mind taking a look at this issue as it has been labeled with an integration (`onedrive`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1076) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `onedrive` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign onedrive` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[onedrive documentation](https://www.home-assistant.io/integrations/onedrive)\n[onedrive source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/onedrive)\n<sub><sup>(message by IssueLinks)</sup></sub>\nIt looks like it couldn't find the backup `a694ecad` in the OneDrive.\nDo you by any chance know if that's a backup that should have been uploaded to OneDrive? Can you also check your OneDrive if there is a file in the backup folder called `a694ecad.tar`?\n![Image](https://github.com/user-attachments/assets/9dbe8bc9-4c1d-4853-a2b5-a7c92dda2a93)\n\nDoesn't seem like it\n\n(Image from the beta channel)", "created_at": "2025-01-30T10:36:31Z"}
{"repo": "home-assistant/core", "pull_number": 136888, "instance_id": "home-assistant__core-136888", "issue_numbers": ["136869"], "base_commit": "64b056fbe998cf7231906c26f4daab02bb4124a5", "patch": "diff --git a/homeassistant/components/nest/manifest.json b/homeassistant/components/nest/manifest.json\nindex f7e78b2d538e15..cd961276082909 100644\n--- a/homeassistant/components/nest/manifest.json\n+++ b/homeassistant/components/nest/manifest.json\n@@ -19,5 +19,5 @@\n   \"documentation\": \"https://www.home-assistant.io/integrations/nest\",\n   \"iot_class\": \"cloud_push\",\n   \"loggers\": [\"google_nest_sdm\"],\n-  \"requirements\": [\"google-nest-sdm==7.1.0\"]\n+  \"requirements\": [\"google-nest-sdm==7.1.1\"]\n }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 16079cca64dab0..90a8709395fae1 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -1036,7 +1036,7 @@ google-cloud-texttospeech==2.17.2\n google-generativeai==0.8.2\n \n # homeassistant.components.nest\n-google-nest-sdm==7.1.0\n+google-nest-sdm==7.1.1\n \n # homeassistant.components.google_photos\n google-photos-library-api==0.12.1\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex a5bd58dff58c64..c7a0959bbb81fd 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -886,7 +886,7 @@ google-cloud-texttospeech==2.17.2\n google-generativeai==0.8.2\n \n # homeassistant.components.nest\n-google-nest-sdm==7.1.0\n+google-nest-sdm==7.1.1\n \n # homeassistant.components.google_photos\n google-photos-library-api==0.12.1\n", "problem_statement": "Significant CPU usage from Nest\n### The problem\n\nhello!\n\nUpon updating to 2025.2.0b0, i noticed my CPU usage has significantly increased on my Nuc12 running HAOS 14.2\n\n![Image](https://github.com/user-attachments/assets/d96c23a7-6647-4409-91f9-e68d86aa9ba4)\n\nCallgrinds indicate its coming from the Nest integration.\n\n![Image](https://github.com/user-attachments/assets/01d54102-6992-4703-9ab7-ddbc303b2373)\n\n```\nfl=/usr/local/lib/python3.13/site-packages/grpc/aio/_call.py\nfn=_consume_request_iterator\n443 1477298196\ncfl=/usr/local/lib/python3.13/site-packages/google_nest_sdm/subscriber_client.py\ncfn=pull_request_generator\ncalls=1347207 100\n443 17602072572\ncfl=/usr/local/lib/python3.13/site-packages/grpc/aio/_call.py\ncfn=_write\ncalls=2694414 487\n443 14591881753\n```\n\nCurrently, I have 4 devices on the Nest integration, 3 Hub Max's and 1 Second Gen Thermostat.\n\nCallgrinds attached (please remove .txt from file extension)\n\nmaybe related to this issue https://github.com/home-assistant/core/issues/108065\n\n### What version of Home Assistant Core has the issue?\n\n2025.2.0b0\n\n### What was the last working version of Home Assistant Core?\n\n2025.1.x\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nNest\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/nest/\n\n### Diagnostics information\n\n[removed]\n\n### Example YAML snippet\n\n```yaml\n\n```\n\n### Anything in the logs that might be useful for us?\n\n```txt\n\n```\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @allenporter, mind taking a look at this issue as it has been labeled with an integration (`nest`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L996) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `nest` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign nest` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[nest documentation](https://www.home-assistant.io/integrations/nest)\n[nest source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/nest)\n<sub><sup>(message by IssueLinks)</sup></sub>\nconfirming that if i disable the nest integration, my CPU levels drop back down to normal ~2%\njumping in here.  updated to beta 2 and my cpu went through the roof.  also have the google nest integration.  2 thermostats and a nest doorbell.  went back to 2025.1.4\nThanks! we have enough data for now to investigate.\nFor visibility, i rewrote the nest pub/sub subscription in this release. The previous version used threads and i think was getting stuck. The new version is fully asyncio, though clearly has another issue. https://github.com/allenporter/python-google-nest-sdm/pull/1146 is the change upstream.\nI am able to reproduce the issue, i see home assistant using 100% of one of my cpus.", "created_at": "2025-01-30T05:50:04Z"}
{"repo": "home-assistant/core", "pull_number": 136884, "instance_id": "home-assistant__core-136884", "issue_numbers": ["135471"], "base_commit": "f93b1cc950415b13daddb3281e65740cf9ef9911", "patch": "diff --git a/homeassistant/components/lifx/util.py b/homeassistant/components/lifx/util.py\nindex 3d37f1c3bc50ff..8286622e6f3678 100644\n--- a/homeassistant/components/lifx/util.py\n+++ b/homeassistant/components/lifx/util.py\n@@ -113,7 +113,7 @@ def find_hsbk(hass: HomeAssistant, **kwargs: Any) -> list[float | int | None] |\n         saturation = int(saturation / 100 * 65535)\n         kelvin = 3500\n \n-    if _ATTR_COLOR_TEMP in kwargs:\n+    if ATTR_COLOR_TEMP_KELVIN not in kwargs and _ATTR_COLOR_TEMP in kwargs:\n         # added in 2025.1, can be removed in 2026.1\n         _LOGGER.warning(\n             \"The 'color_temp' parameter is deprecated. Please use 'color_temp_kelvin' for\"\n", "test_patch": "", "problem_statement": "Lifx Screne issue after color_temp deprecation\n### The problem\n\nSeeing `Action lifx.off not found.` when applying a scene with lifx lights after the `color_temp` deprecation. Not seeing the error when turning the lights or light group on and off through the front end, only when activating the scene.\r\n\r\nI can reproduce this error reliably by calling the scene activation.\r\n\r\nI have recreated the scene and noticed the `color_temp` key gets recreated in the new scene so not sure if this is an issue with the front end scene creator similar to the previous issue (https://github.com/home-assistant/core/issues/134771) where the front end car had the deprecated `color_temp`\r\n\r\nI do have two lifx lights that are not powered on right now that are unrelated to this issue and the scene was working prior to core-2025.1.2 but I am not sure if the issue began with 2025.1.1  or 2025.1.2\r\n\r\nThanks\n\n### What version of Home Assistant Core has the issue?\n\ncore-2025.1.2\n\n### What was the last working version of Home Assistant Core?\n\n_No response_\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nScene or Lifx\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/docs/scene/\n\n### Diagnostics information\n\n[home-assistant_lifx_2025-01-12T18-57-09.106Z.log](https://github.com/user-attachments/files/18390695/home-assistant_lifx_2025-01-12T18-57-09.106Z.log)\r\n\n\n### Example YAML snippet\n\n```yaml\nid: \"1736707190534\"\r\nname: Bedroom Normal\r\nentities:\r\n  light.bedroom_lights:\r\n    min_color_temp_kelvin: 1500\r\n    max_color_temp_kelvin: 9000\r\n    min_mireds: 111\r\n    max_mireds: 666\r\n    effect_list:\r\n      - colorloop\r\n      - effect_colorloop\r\n      - effect_pulse\r\n      - effect_stop\r\n      - \"off\"\r\n    supported_color_modes:\r\n      - color_temp\r\n      - hs\r\n      - xy\r\n    effect: \"off\"\r\n    color_mode: color_temp\r\n    brightness: 171\r\n    color_temp_kelvin: 3585\r\n    color_temp: 278\r\n    hs_color:\r\n      - 27.092\r\n      - 42.958\r\n    rgb_color:\r\n      - 255\r\n      - 195\r\n      - 145\r\n    xy_color:\r\n      - 0.448\r\n      - 0.373\r\n    entity_id:\r\n      - light.bedroom_back_left_light\r\n      - light.bedroom_back_right_light\r\n      - light.bedroom_front_left_light\r\n      - light.bedroom_front_right_light\r\n      - light.bed_lights\r\n      - light.bedroom_globe_light\r\n    icon: mdi:lightbulb-group\r\n    friendly_name: Bedroom Lights\r\n    supported_features: 44\r\n    state: \"on\"\r\nmetadata:\r\n  light.bedroom_lights:\r\n    entity_only: true\n```\n\n\n### Anything in the logs that might be useful for us?\n\n```txt\n2025-01-12 10:54:33.497 ERROR (MainThread) [homeassistant.helpers.script.websocket_api_script] websocket_api script: Error executing script. Service not found for call_service at pos 1: Action lifx.off not found\r\n2025-01-12 10:54:33.498 ERROR (MainThread) [homeassistant.components.websocket_api.http.connection] [140213667636288] Action lifx.off not found\n```\n\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @djelibeybi, mind taking a look at this issue as it has been labeled with an integration (`lifx`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L842) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `lifx` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign lifx` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[lifx documentation](https://www.home-assistant.io/integrations/lifx)\n[lifx source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/lifx)\n<sub><sup>(message by IssueLinks)</sup></sub>\nDoes the problem occur with the scene you recreated? You mentioned that, but it's not clear to me if that scene works or not. \r\n\r\nIf the problem doesn't occur, then I'll probably reassign this across to the scene integration for them to do some work adjusting older YAML but if it still happens, I guess I'll have to learn how scenes work. :) \nSorry for the confusion, the issue does still happen with the recreated scene. Thanks!\nI'll try and find some time to take a look soon.\nThere is no action named `lifx.off` so that error is expected given this configuration.\n\nCan you please try changing `effect: off` to `effect: effect_stop` as `lifx.effect_stop` exists and should work to stop any running firmware or software (i.e. Home Assistant controlled) effects.\nI tested changing `effect: off` to `effect: effect_stop` in my scene (sorry if this change was supposed to be made somewhere else) and when applying the scene I see the normal `Activated Scene` message instead of the `Action lifx.off not found` error. but the lifx lights in the group the scene references do not turn on, a group of hue lights did turn on.  Maybe that was expected behavior for the test.\n\nIf I make a change in the Scene Live Edit the yaml reverts back to ` effect: \"off\"`\n\n\nI would not have expected them to turn on, so that's somewhat expected. I don't know why the scene generator/editor is trying to use `effect: off` as that doesn't exist in the LIFX integration.\nIf you remove `effect: off` completely, the LIFX bulbs should turn on as expected.", "created_at": "2025-01-30T01:17:43Z"}
{"repo": "home-assistant/core", "pull_number": 136793, "instance_id": "home-assistant__core-136793", "issue_numbers": ["136340"], "base_commit": "64cda8cdb8a08fa3ab1f767cc8dcdc48d7201152", "patch": "diff --git a/homeassistant/components/totalconnect/alarm_control_panel.py b/homeassistant/components/totalconnect/alarm_control_panel.py\nindex 48ba78acc9298c..021d1c7b88668f 100644\n--- a/homeassistant/components/totalconnect/alarm_control_panel.py\n+++ b/homeassistant/components/totalconnect/alarm_control_panel.py\n@@ -73,7 +73,7 @@ def __init__(\n     ) -> None:\n         \"\"\"Initialize the TotalConnect status.\"\"\"\n         super().__init__(coordinator, location)\n-        self._partition_id = partition_id\n+        self._partition_id = int(partition_id)\n         self._partition = self._location.partitions[partition_id]\n \n         \"\"\"\n@@ -81,7 +81,7 @@ def __init__(\n         for most users with new support for partitions.\n         Add _# for partition 2 and beyond.\n         \"\"\"\n-        if partition_id == 1:\n+        if int(partition_id) == 1:\n             self._attr_name = None\n             self._attr_unique_id = str(location.location_id)\n         else:\ndiff --git a/homeassistant/components/totalconnect/manifest.json b/homeassistant/components/totalconnect/manifest.json\nindex 33306a7adbac24..6aff1ea392b3f0 100644\n--- a/homeassistant/components/totalconnect/manifest.json\n+++ b/homeassistant/components/totalconnect/manifest.json\n@@ -6,5 +6,5 @@\n   \"documentation\": \"https://www.home-assistant.io/integrations/totalconnect\",\n   \"iot_class\": \"cloud_polling\",\n   \"loggers\": [\"total_connect_client\"],\n-  \"requirements\": [\"total-connect-client==2024.12\"]\n+  \"requirements\": [\"total-connect-client==2025.1.4\"]\n }\ndiff --git a/requirements_all.txt b/requirements_all.txt\nindex 24a550e05de28b..34842f77c182e9 100644\n--- a/requirements_all.txt\n+++ b/requirements_all.txt\n@@ -2895,7 +2895,7 @@ tololib==1.1.0\n toonapi==0.3.0\n \n # homeassistant.components.totalconnect\n-total-connect-client==2024.12\n+total-connect-client==2025.1.4\n \n # homeassistant.components.tplink_lte\n tp-connected==0.0.4\n", "test_patch": "diff --git a/requirements_test_all.txt b/requirements_test_all.txt\nindex fa1dd4bed7fd0a..23eb005cf021fe 100644\n--- a/requirements_test_all.txt\n+++ b/requirements_test_all.txt\n@@ -2323,7 +2323,7 @@ tololib==1.1.0\n toonapi==0.3.0\n \n # homeassistant.components.totalconnect\n-total-connect-client==2024.12\n+total-connect-client==2025.1.4\n \n # homeassistant.components.tplink_omada\n tplink-omada-client==1.4.3\ndiff --git a/tests/components/totalconnect/common.py b/tests/components/totalconnect/common.py\nindex 828cad71e077c0..34d451ec0b8bcc 100644\n--- a/tests/components/totalconnect/common.py\n+++ b/tests/components/totalconnect/common.py\n@@ -49,20 +49,15 @@\n     \"UserFeatureList\": \"Master=0,User Administration=0,Configuration Administration=0\",\n }\n \n-RESPONSE_AUTHENTICATE = {\n+RESPONSE_SESSION_DETAILS = {\n     \"ResultCode\": ResultCode.SUCCESS.value,\n-    \"SessionID\": 1,\n+    \"ResultData\": \"Success\",\n+    \"SessionID\": \"12345\",\n     \"Locations\": LOCATIONS,\n     \"ModuleFlags\": MODULE_FLAGS,\n     \"UserInfo\": USER,\n }\n \n-RESPONSE_AUTHENTICATE_FAILED = {\n-    \"ResultCode\": ResultCode.BAD_USER_OR_PASSWORD.value,\n-    \"ResultData\": \"test bad authentication\",\n-}\n-\n-\n PARTITION_DISARMED = {\n     \"PartitionID\": \"1\",\n     \"ArmingState\": ArmingState.DISARMED,\n@@ -359,13 +354,13 @@\n OPTIONS_DATA_CODE_REQUIRED = {AUTO_BYPASS: False, CODE_REQUIRED: True}\n \n PARTITION_DETAILS_1 = {\n-    \"PartitionID\": 1,\n+    \"PartitionID\": \"1\",\n     \"ArmingState\": ArmingState.DISARMED.value,\n     \"PartitionName\": \"Test1\",\n }\n \n PARTITION_DETAILS_2 = {\n-    \"PartitionID\": 2,\n+    \"PartitionID\": \"2\",\n     \"ArmingState\": ArmingState.DISARMED.value,\n     \"PartitionName\": \"Test2\",\n }\n@@ -402,6 +397,12 @@\n TOTALCONNECT_REQUEST = (\n     \"homeassistant.components.totalconnect.TotalConnectClient.request\"\n )\n+TOTALCONNECT_GET_CONFIG = (\n+    \"homeassistant.components.totalconnect.TotalConnectClient._get_configuration\"\n+)\n+TOTALCONNECT_REQUEST_TOKEN = (\n+    \"homeassistant.components.totalconnect.TotalConnectClient._request_token\"\n+)\n \n \n async def setup_platform(\n@@ -420,7 +421,7 @@ async def setup_platform(\n     mock_entry.add_to_hass(hass)\n \n     responses = [\n-        RESPONSE_AUTHENTICATE,\n+        RESPONSE_SESSION_DETAILS,\n         RESPONSE_PARTITION_DETAILS,\n         RESPONSE_GET_ZONE_DETAILS_SUCCESS,\n         RESPONSE_DISARMED,\n@@ -433,6 +434,8 @@ async def setup_platform(\n             TOTALCONNECT_REQUEST,\n             side_effect=responses,\n         ) as mock_request,\n+        patch(TOTALCONNECT_GET_CONFIG, side_effect=None),\n+        patch(TOTALCONNECT_REQUEST_TOKEN, side_effect=None),\n     ):\n         assert await async_setup_component(hass, DOMAIN, {})\n         assert mock_request.call_count == 5\n@@ -448,17 +451,21 @@ async def init_integration(hass: HomeAssistant) -> MockConfigEntry:\n     mock_entry.add_to_hass(hass)\n \n     responses = [\n-        RESPONSE_AUTHENTICATE,\n+        RESPONSE_SESSION_DETAILS,\n         RESPONSE_PARTITION_DETAILS,\n         RESPONSE_GET_ZONE_DETAILS_SUCCESS,\n         RESPONSE_DISARMED,\n         RESPONSE_DISARMED,\n     ]\n \n-    with patch(\n-        TOTALCONNECT_REQUEST,\n-        side_effect=responses,\n-    ) as mock_request:\n+    with (\n+        patch(\n+            TOTALCONNECT_REQUEST,\n+            side_effect=responses,\n+        ) as mock_request,\n+        patch(TOTALCONNECT_GET_CONFIG, side_effect=None),\n+        patch(TOTALCONNECT_REQUEST_TOKEN, side_effect=None),\n+    ):\n         await hass.config_entries.async_setup(mock_entry.entry_id)\n         assert mock_request.call_count == 5\n     await hass.async_block_till_done()\ndiff --git a/tests/components/totalconnect/test_config_flow.py b/tests/components/totalconnect/test_config_flow.py\nindex 86419bff817f4f..f5020394bce065 100644\n--- a/tests/components/totalconnect/test_config_flow.py\n+++ b/tests/components/totalconnect/test_config_flow.py\n@@ -18,13 +18,15 @@\n from .common import (\n     CONFIG_DATA,\n     CONFIG_DATA_NO_USERCODES,\n-    RESPONSE_AUTHENTICATE,\n     RESPONSE_DISARMED,\n     RESPONSE_GET_ZONE_DETAILS_SUCCESS,\n     RESPONSE_PARTITION_DETAILS,\n+    RESPONSE_SESSION_DETAILS,\n     RESPONSE_SUCCESS,\n     RESPONSE_USER_CODE_INVALID,\n+    TOTALCONNECT_GET_CONFIG,\n     TOTALCONNECT_REQUEST,\n+    TOTALCONNECT_REQUEST_TOKEN,\n     USERNAME,\n )\n \n@@ -48,7 +50,7 @@ async def test_user_show_locations(hass: HomeAssistant) -> None:\n     \"\"\"Test user locations form.\"\"\"\n     # user/pass provided, so check if valid then ask for usercodes on locations form\n     responses = [\n-        RESPONSE_AUTHENTICATE,\n+        RESPONSE_SESSION_DETAILS,\n         RESPONSE_PARTITION_DETAILS,\n         RESPONSE_GET_ZONE_DETAILS_SUCCESS,\n         RESPONSE_DISARMED,\n@@ -61,6 +63,8 @@ async def test_user_show_locations(hass: HomeAssistant) -> None:\n             TOTALCONNECT_REQUEST,\n             side_effect=responses,\n         ) as mock_request,\n+        patch(TOTALCONNECT_GET_CONFIG, side_effect=None),\n+        patch(TOTALCONNECT_REQUEST_TOKEN, side_effect=None),\n         patch(\n             \"homeassistant.components.totalconnect.async_setup_entry\", return_value=True\n         ),\n@@ -180,7 +184,7 @@ async def test_reauth(hass: HomeAssistant) -> None:\n async def test_no_locations(hass: HomeAssistant) -> None:\n     \"\"\"Test with no user locations.\"\"\"\n     responses = [\n-        RESPONSE_AUTHENTICATE,\n+        RESPONSE_SESSION_DETAILS,\n         RESPONSE_PARTITION_DETAILS,\n         RESPONSE_GET_ZONE_DETAILS_SUCCESS,\n         RESPONSE_DISARMED,\n@@ -191,6 +195,8 @@ async def test_no_locations(hass: HomeAssistant) -> None:\n             TOTALCONNECT_REQUEST,\n             side_effect=responses,\n         ) as mock_request,\n+        patch(TOTALCONNECT_GET_CONFIG, side_effect=None),\n+        patch(TOTALCONNECT_REQUEST_TOKEN, side_effect=None),\n         patch(\n             \"homeassistant.components.totalconnect.async_setup_entry\", return_value=True\n         ),\n@@ -221,7 +227,7 @@ async def test_options_flow(hass: HomeAssistant) -> None:\n     config_entry.add_to_hass(hass)\n \n     responses = [\n-        RESPONSE_AUTHENTICATE,\n+        RESPONSE_SESSION_DETAILS,\n         RESPONSE_PARTITION_DETAILS,\n         RESPONSE_GET_ZONE_DETAILS_SUCCESS,\n         RESPONSE_DISARMED,\n@@ -229,7 +235,11 @@ async def test_options_flow(hass: HomeAssistant) -> None:\n         RESPONSE_DISARMED,\n     ]\n \n-    with patch(TOTALCONNECT_REQUEST, side_effect=responses):\n+    with (\n+        patch(TOTALCONNECT_REQUEST, side_effect=responses),\n+        patch(TOTALCONNECT_GET_CONFIG, side_effect=None),\n+        patch(TOTALCONNECT_REQUEST_TOKEN, side_effect=None),\n+    ):\n         assert await hass.config_entries.async_setup(config_entry.entry_id)\n         await hass.async_block_till_done()\n \n", "problem_statement": "Error setting up entry Total Connect\n### The problem\n\nThe Total Connect integration is no longer working as of today. No system updates were made since it worked last. It stopped working overnight. I tried re-start and re-boot to no avail. Service (TotalConnect - Resideo - https://status.resideo.com/ ) itself appears to be up but integration fails. I am able to use their mobile app to arm/disarm system fine but not via HA.\n\nLogger: homeassistant.config_entries\nSource: config_entries.py:640\nFirst occurred: 6:17:11 AM (2 occurrences)\nLast logged: 7:46:46 AM\n\nError setting up entry Total Connect for totalconnect\nTraceback (most recent call last):\n  File \"/usr/src/homeassistant/homeassistant/config_entries.py\", line 640, in __async_setup_with_context\n    result = await component.async_setup_entry(hass, self)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/src/homeassistant/homeassistant/components/totalconnect/__init__.py\", line 36, in async_setup_entry\n    client = await hass.async_add_executor_job(\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        TotalConnectClient, username, password, usercodes, bypass\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/usr/local/lib/python3.13/concurrent/futures/thread.py\", line 59, in run\n    result = self.fn(*self.args, **self.kwargs)\n  File \"/usr/local/lib/python3.13/site-packages/total_connect_client/client.py\", line 96, in __init__\n    self.authenticate()\n    ~~~~~~~~~~~~~~~~~^^\n  File \"/usr/local/lib/python3.13/site-packages/total_connect_client/client.py\", line 296, in authenticate\n    response = self.request(\n        operation_name,\n        (self.username, self.password, self.API_APP_ID, self.API_APP_VERSION),\n    )\n  File \"/usr/local/lib/python3.13/site-packages/total_connect_client/client.py\", line 235, in request\n    self._raise_for_retry(response)\n    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^\n  File \"/usr/local/lib/python3.13/site-packages/total_connect_client/client.py\", line 157, in _raise_for_retry\n    rc = _ResultCode.from_response(response)\n  File \"/usr/local/lib/python3.13/site-packages/total_connect_client/const.py\", line 154, in from_response\n    raise ServiceUnavailable(f\"Server returned empty response, check server status at {STATUS_URL}\") from None\ntotal_connect_client.exceptions.ServiceUnavailable: Server returned empty response, check server status at https://status.resideo.com/\n\n### What version of Home Assistant Core has the issue?\n\ncore-2025.1.3\n\n### What was the last working version of Home Assistant Core?\n\ncore-2025.1.3\n\n### What type of installation are you running?\n\nHome Assistant OS\n\n### Integration causing the issue\n\nTotalConnect\n\n### Link to integration documentation on our website\n\nhttps://www.home-assistant.io/integrations/totalconnect/\n\n### Diagnostics information\n\nLogger: homeassistant.config_entries\nSource: config_entries.py:640\nFirst occurred: 6:17:11 AM (2 occurrences)\nLast logged: 7:46:46 AM\n\nError setting up entry Total Connect for totalconnect\nTraceback (most recent call last):\n  File \"/usr/src/homeassistant/homeassistant/config_entries.py\", line 640, in __async_setup_with_context\n    result = await component.async_setup_entry(hass, self)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/usr/src/homeassistant/homeassistant/components/totalconnect/__init__.py\", line 36, in async_setup_entry\n    client = await hass.async_add_executor_job(\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n        TotalConnectClient, username, password, usercodes, bypass\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    )\n    ^\n  File \"/usr/local/lib/python3.13/concurrent/futures/thread.py\", line 59, in run\n    result = self.fn(*self.args, **self.kwargs)\n  File \"/usr/local/lib/python3.13/site-packages/total_connect_client/client.py\", line 96, in __init__\n    self.authenticate()\n    ~~~~~~~~~~~~~~~~~^^\n  File \"/usr/local/lib/python3.13/site-packages/total_connect_client/client.py\", line 296, in authenticate\n    response = self.request(\n        operation_name,\n        (self.username, self.password, self.API_APP_ID, self.API_APP_VERSION),\n    )\n  File \"/usr/local/lib/python3.13/site-packages/total_connect_client/client.py\", line 235, in request\n    self._raise_for_retry(response)\n    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^\n  File \"/usr/local/lib/python3.13/site-packages/total_connect_client/client.py\", line 157, in _raise_for_retry\n    rc = _ResultCode.from_response(response)\n  File \"/usr/local/lib/python3.13/site-packages/total_connect_client/const.py\", line 154, in from_response\n    raise ServiceUnavailable(f\"Server returned empty response, check server status at {STATUS_URL}\") from None\ntotal_connect_client.exceptions.ServiceUnavailable: Server returned empty response, check server status at https://status.resideo.com/\n\n### Example YAML snippet\n\n```yaml\n\n```\n\n### Anything in the logs that might be useful for us?\n\n```txt\n\n```\n\n### Additional information\n\n_No response_\n", "hints_text": "\nHey there @austinmroczek, mind taking a look at this issue as it has been labeled with an integration (`totalconnect`) you are listed as a [code owner](https://github.com/home-assistant/core/blob/dev/CODEOWNERS#L1554) for? Thanks!\n\n<details>\n<summary>Code owner commands</summary>\n\n\nCode owners of `totalconnect` can trigger bot actions by commenting:\n\n- `@home-assistant close` Closes the issue.\n- `@home-assistant rename Awesome new title` Renames the issue.\n- `@home-assistant reopen` Reopen the issue.\n- `@home-assistant unassign totalconnect` Removes the current integration label and assignees on the issue, add the integration domain after the command.\n- `@home-assistant add-label needs-more-information` Add a label (needs-more-information, problem in dependency, problem in custom component) to the issue.\n- `@home-assistant remove-label needs-more-information` Remove a label (needs-more-information, problem in dependency, problem in custom component) on the issue.\n\n</details>\n\n\n<sub><sup>(message by CodeOwnersMention)</sup></sub>\n\n---\n\n[totalconnect documentation](https://www.home-assistant.io/integrations/totalconnect)\n[totalconnect source](https://github.com/home-assistant/core/tree/dev/homeassistant/components/totalconnect)\n<sub><sup>(message by IssueLinks)</sup></sub>\nSame issue, same error logs here.\nSame issue on my end\nSame, started about 8 hours ago while on HA 1.2. Updated to 1.3 and same thing.\n\n`Core\n2025.1.3\nSupervisor\n2024.12.3\nOperating System\n14.1\nFrontend\n20250109.0`\nSame issue, stopped overnight, however I can confirm it was working for 2 days on HA 2025.1.3 with no issues. \nThe error may indicate some sort of API change or issue at Resideo.\n\n`total_connect_client.exceptions.ServiceUnavailable: Server returned empty response`\n\nTheir status page doesn't seem to be reporting any related issues as of yet.\nhttps://status.resideo.com/\nHI,\n\nI got the same issue.\nSame\nSame\n\nI have the exact same issue.\nSame issue here as well\nSame\nUP ! Same here\nYep, same.  The day after I get this integration running for the first time.  \nSame the Resideo app on my phone does say it was recently updated and is requiring me to re sign in again.  So maybe something changed?\nWill investigate as soon as possible.  This seems like similar website/API problems in the past\nService went down for me today. And up to 7:31 AM CST it was working correctly.  Now I get: this every time I try to reload the integration\n\n```\n File \"/usr/local/lib/python3.13/site-packages/total_connect_client/const.py\", line 154, in from_response\n    raise ServiceUnavailable(f\"Server returned empty response, check server status at {STATUS_URL}\") from None\ntotal_connect_client.exceptions.ServiceUnavailable: Server returned empty response, check server status at https://status.resideo.com/\n```\n\nIt smells like API outage because the status at resideo is all green. And the TC app is still working (somewhat).\nsame here\nSame....\nSame for me. \nI agree it looks like an API outage, but Amazon Alexa is still working, and I would think that also uses the API service.\n> I agree it looks like an API outage, but Amazon Alexa is still working, and I would think that also uses the API service.\n\nIFTTT is still working with no interruptions as well.  \nIf Alexa and IFTTT work it has to be something with HA,  Thoughts?\nConsidering it worked initially on v2025.1.3, and it went down for all of us at about the same time, and considering it works fine with Alexa, could it be that Resideo is blocking API calls from unknown (non-AWS/Alexa) IP addresses?   If they use the same API?  Hopefully they didn\u2019t do what MyQ did and cut us off.  BTW, I just upgraded to v2025.1.4, and no change.  TotalConnect is still down.  I hope this is fixable.  I have a lot of automations that are based on the state of the security system.  \nIt's an issue with the SOAP API. When making a request to the AuthenticateUserLogin API, it responds with a 200 but the response is missing the SOAP body that should include the SessionID\n\nhttps://rs.alarmnet.com/tc21api/tc2.asmx?op=AuthenticateUserLogin\n\nThis is what the response should look like:\n\n```\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<soap:Envelope xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:soap=\"http://schemas.xmlsoap.org/soap/envelope/\">\n  <soap:Body>\n    <AuthenticateUserLoginResponse xmlns=\"https://services.alarmnet.com/TC2/\">\n      <AuthenticateUserLoginResult>\n        <SessionID>string</SessionID>\n      </AuthenticateUserLoginResult>\n    </AuthenticateUserLoginResponse>\n  </soap:Body>\n</soap:Envelope>\n```\n\nThis is the response I see instead:\n\n```\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<soap12:Envelope xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:soap12=\"http://www.w3.org/2003/05/soap-envelope\">\n\t<soap:Body>\n\t\t<AuthenticateUserLoginResponse xmlns=\"https://services.alarmnet.com/TC2/\" />\n\t</soap:Body>\n</soap:Envelope>\n```\nWould a new alarm monitoring service fix it? anyone have any suggestions?\nI am the integration owner for the `totalconnect` integration in Home Assistant, and I maintain the underlying [total_connect_client](https://github.com/craigjmidwinter/total-connect-client) used to talk with the [TotalConnect 2.0 API](https://rs.alarmnet.com/TC21api/tc2.asmx).\n \nAs @thor0215 noted above, and I verified, the server is providing empty responses to all queries at the moment. This is a server problem, and has nothing to do with upgrading Home Assistant to 2025.1.x.\n\nWhen a user logs in, the API requires an `ApplicationID` be provided.  It is possible they have decided to block our ID. However, I would not jump to that conclusion yet.  I think it's more likely there is some weird server error that is not denying their main TotalConnect website/app, and they just haven't seen the problem yet. In the past we've seen the server status page show green, yet this integration was not working.\n\nResideo/Honeywell's business model is to sell alarms to third party installers (your alarm company).  They don't want to communicate with or support users directly.  All of their documentation essentially says 'contact your installer for help'. Folks could try to talk with Resideo/Honeywell.  One address I have found for them is `developerinfo@resideo.com` but in the past they have not responded to me.  They have a [contact page](https://www.hotfix.rde.resideo.com/us/en/corporate/contact-us/), and various social media handles [HoneywellHome Twitter/X](https://twitter.com/Honeywell_Home),  [Resideo Twitter/X](https://twitter.com/resideo), [HoneywellHome Facebook](https://www.facebook.com/honeywellhome), [Resideo Facebook](https://www.facebook.com/Resideo/) which is another way to try.  There is also a Homeowner support # [1-800-633-3991](tel:18006333991)\n\nI tried their online support chat earlier and got this:\n\n\"All of the security panels/systems along the TC2.0 app are not supported by this channel. These are only sold, installed and supported, by professional security providers/installers. For technical information, account management or general documentation, you can use our tool: https://www.resideo.com/us/en/find-a-pro/ To find a local security provider/installer that carries/services and supports this products.\"\n\nComplaining to your alarm company is another option. Changing alarm monitoring service will not fix this - though threatening to do so might motivate your current company to talk with Resideo.\n\nIt's a relatively minor thing, but it would also help to enable Analytics on your Home Assistant to help boost our numbers.  Right now we only show 265 active users on the [analytics page](https://analytics.home-assistant.io/integrations/).\nFollowing - literally just got around to automating our retail establishment's lights and heat based on alarm change. Can do a different way, but like having it linked. Thanks for working through this.\n> It's a relatively minor thing, but it would also help to enable Analytics on your Home Assistant to help boost our numbers. Right now we only show 265 active users on the [analytics page](https://analytics.home-assistant.io/integrations/).\n\nDone.  It looks like we need to have at least *Usage* analytics to report which integrations we are using.\n\nI instinctually disable/don't allow analytics when I set up systems.  But [reading up on HA's analytics](https://www.home-assistant.io/integrations/analytics/), I'm impressed by how open it is about the data it collects.  \nI routinely open up analytics.  I've had useful integrations disappear when there's too few users.\nThank you for the update @austinmroczek .  Wouldn't a server-side issue on the API also impact Alexa?  I appreciate all your efforts on this, but it has the same feel as when we were locked out of MyQ and Life360.  So disappointing that companies do this to their customers.  I spent so much time creating complex automations based on the state of the security system, as I'm sure many others did. I'll keep my fingers crossed that it gets resolved. \nI wish I had more concrete answers.  There is no insight into how the server works.  It's a logical assumption that if Alexa works, so should this.  However, in the past there were times when the TotalConnect app (iOS) worked but this did not, which is why I'm still holding out hope.  Past outages have been up to a couple of days, and since today is Friday, maybe it extends over the weekend.  If we still can't do anything by Monday my hope will quickly fade.\n\nI'm trying to work up some alternatives for folks.  Possibilities are:\n- IFTTT can communicate with TotalConnect and Home Assistant (via Webhooks). However this requires an IFTTT \"pro\" plan that is $2.92/month which is the same price I'm paying for TotalConnect right now.  Have not tried this yet due to the cost.\n- The newer Pro series panels support HomeKit.  I never bothered because I had the functionality I wanted.  I'll be testing this soon.  Assuming it works, this will probably leave most older, but still functional, alarm panels behind.\n\n[edited IFTTT pro plan price per tbclark3 below]\nHmmm... where are you getting Total Connect for $12.50? I'm paying $17 and thought that was a discount price.\n\nIt appears to me that IFTTT Pro should be adequate since it allows for webhooks, and it's $2.92/month.\n\nThanks for your conscientious support and your help!\n@austinmroczek How much work would it be to setup a new App Id using an account not associated with you and see if something changes?  This should be verifiable entirely using just the tests in the [total_connect_client](https://github.com/craigjmidwinter/total-connect-client) code, no? \n\nI'm been too busy at work since finding this thread and try anything.  Where is the developer portal to my own App Id for alarmnet/totalconnect2 to experiment with?  I've found a few different portals for honeywell, honeywellhome, resideo, etc.  But none of them let me set up anything except OAuth creds. \nIf it helps any, I coded a custom integration in Homebridge. It took me about a month since I don't code often. It was loosely based on someone else's code. And it worked like perfection until TC2.0 came out with an update, and then my logs showed Cloudflare protections that I couldn't seem to bypass. I then logged into totalconnect2.com, and I had to reset my password due to \"violation of terms\" So I gave up on it.\n> Hmmm... where are you getting Total Connect for $12.50?\n\nSorry I was remembering the price from a few years ago.  Just checked and I'm now at $15.95/month from Alarm Relay.\n\n> It appears to me that IFTTT Pro should be adequate since it allows for webhooks, and it's $2.92/month.\n\nSorry I must have been reading the Pro+ price. \n\n> How much work would it be to setup a new App Id\n\nThe ApplicationID we are using was copied from another system (I think SmartThings, maybe OpenHab) 6-8 years ago.  The API documentation just says to give your ID during a login request, but doesn't say anything about how to create or get an ID assigned.  \n\nIt's easy to change the ID in the total_connect_client code.  I actually did that earlier this morning, just added 1, but it didn't help. Other than random guessing, I don't know how we get a new ID.\n\nThere are Application ID's available via Google search.  This one came from a Honeywell discussion group and supposedly worked 2 years ago:\n91db1612-73fd-4500-91b2-e63b069b185c\n\n\nThanks but that ID doesn't work.\n\nPer the [API](https://rs.alarmnet.com/TC21api/tc2.asmx?op=LoginAndGetSessionDetails) it's supposed to be an integer.  I tried it anyways but got\n\n```txt\nServer was unable to read request. ---> There is an error in XML document (2, 320). ---> Input string was not in a correct format.\n```\n\nWe are currently using 14588\n> I wish I had more concrete answers. There is no insight into how the server works. It's a logical assumption that if Alexa works, so should this. However, in the past there were times when the TotalConnect app (iOS) worked but this did not, which is why I'm still holding out hope. Past outages have been up to a couple of days, and since today is Friday, maybe it extends over the weekend. If we still can't do anything by Monday my hope will quickly fade.\n> \n> I'm trying to work up some alternatives for folks. Possibilities are:\n> \n> * IFTTT can communicate with TotalConnect and Home Assistant (via Webhooks). However this requires an IFTTT \"pro\" plan that is $12.50/month which is the same price I'm paying for TotalConnect right now.  Have not tried this yet due to the cost.\n> * The newer Pro series panels support HomeKit.  I never bothered because I had the functionality I wanted.  I'll be testing this soon.  Assuming it works, this will probably leave most older, but still functional, alarm panels behind.\n\nI enabled the HomeKit support on my Pro series panel and works well, although doesn't do much for me since limited to only the HomeKit world (most automations are built in Home Assistant). \n> > I wish I had more concrete answers. There is no insight into how the server works. It's a logical assumption that if Alexa works, so should this. However, in the past there were times when the TotalConnect app (iOS) worked but this did not, which is why I'm still holding out hope. Past outages have been up to a couple of days, and since today is Friday, maybe it extends over the weekend. If we still can't do anything by Monday my hope will quickly fade.\n> > \n> > I'm trying to work up some alternatives for folks. Possibilities are:\n> > \n> > * IFTTT can communicate with TotalConnect and Home Assistant (via Webhooks). However this requires an IFTTT \"pro\" plan that is $12.50/month which is the same price I'm paying for TotalConnect right now.  Have not tried this yet due to the cost.\n> > * The newer Pro series panels support HomeKit.  I never bothered because I had the functionality I wanted.  I'll be testing this soon.  Assuming it works, this will probably leave most older, but still functional, alarm panels behind.\n> \n> I enabled the HomeKit support on my Pro series panel and works well, although doesn't do much for me since limited to only the HomeKit world (most automations are built in Home Assistant). \n\nYou could use the homekit controller integration to pass through the pro series panel to HA. \nOh no, reading this thread doesn't give me a lot of hope for the future :( \n> * The newer Pro series panels support HomeKit.\n\nNot to take things too off topic, but if you have multiple panels in your home could you get away with replacing one of them with a Pro series model for HA support or would you need to replace all of them?\n\nEdit: It appears the Pro series panels aren't compatible with Vista systems which I imagine would make upgrading panels prohibitive for a lot of folks.\nFWIW I got an IFTTT Pro trial going easily for arm/disarm and easily and the response time was less than 10 seconds. Hadn't logged in since before the pandemic. I expect it is not as fully featured as the integration, which I hope continues to be the solution. However, based on the responses above it sounds like the manufacturer couldn't care less about our use case so if your integrations are important you may want to test a backup approach in case the rug gets pulled out from everyone permanently.\n> > * The newer Pro series panels support HomeKit.\n> \n> Not to take things too off topic, but if you have multiple panels in your home could you get away with replacing one of them with a Pro series model for HA support or would you need to replace all of them?\n> \n> Edit: It appears the Pro series panels aren't compatible with Vista systems which I imagine would make upgrading panels prohibitive for a lot of folks.\n\nAs a Honeywell/Resideo integrator The ProA7 panels are a stand alone product and do not support the vista panels. However they do support a Pro Takeover module that allows the Vista aka 5800 series wireless devices to interface with the Pro Panel. So your motions, door contacts and glass breaks can be supported into it. The bad news is that the pro panel will not work with the vista keypads so you can\u2019t reuse them. \n\n\n\n> > * The newer Pro series panels support HomeKit.\n> \n> Not to take things too off topic, but if you have multiple panels in your home could you get away with replacing one of them with a Pro series model for HA support or would you need to replace all of them?\n> \n> Edit: It appears the Pro series panels aren't compatible with Vista systems which I imagine would make upgrading panels prohibitive for a lot of folks.\n\n\nAs a Honeywell/Resideo integrator, the new H3 panel might be the better option for upgrading systems that have Vista\u2019s in place. The ProA7 panels are a stand alone product and do not support the vista panels. However they do support a Pro Takeover module that allows the Vista aka 5800 series wireless devices to interface with the Pro Panel. So your motions, door contacts and glass breaks can be supported into it. The bad news is that the pro panel will not work with the vista keypads so you can\u2019t reuse them. \n\n> * The newer Pro series panels support HomeKit.  I never bothered because I had the functionality I wanted.  I'll be testing this soon.  Assuming it works, this will probably leave most older, but still functional, alarm panels behind.\n\nI'm using the Pro Panel with HomeKit directly and it works great. The single reason why I have a Home Assistant setup is for the Total Connect integration - and only because I wanted to automate \"Arm Stay Instant\" (no entry delay) because HomeKit has no way to do this - you can only toggle instant arming via the panel - it's not even available via the app or the website.\n\nSo hopefully this isn't the end. Thank You @austinmroczek for all your work on this.\n> > * The newer Pro series panels support HomeKit.  I never bothered because I had the functionality I wanted.  I'll be testing this soon.  Assuming it works, this will probably leave most older, but still functional, alarm panels behind.\n> \n> I'm using the Pro Panel with HomeKit directly and it works great. The single reason why I have a Home Assistant setup is for the Total Connect integration - and only because I wanted to automate \"Arm Stay Instant\" (no entry delay) because HomeKit has no way to do this - you can only toggle instant arming via the panel - it's not even available via the app or the website.\n> \n> So hopefully this isn't the end. Thank You [@austinmroczek](https://github.com/austinmroczek) for all your work on this.\n\nYou can arm stay instant in the app by going to the keypad, and typing your code followed by the number 7. However, I know this is dumb and they should be ashamed that it's not easier to arm this mode with the press of a button.\n@austinmroczek Not sure if this helps, but tracing the web interface, this is roughly how the authentication works. If I had more time I might be able to figure out how to grab the appid and locale using jsonpath. This script will get the session id which I hope can then be used for the other SOAP calls\n\n```\nfrom Crypto.PublicKey import RSA\nfrom Crypto.Cipher import  PKCS1_v1_5\nfrom jsonpath_ng import jsonpath, parse\nimport base64\nimport requests\nimport jwt\n\n\ndef encrypt_message(message, public_key_pem):\n    \"\"\"Encrypts a message using a public key from a PEM file.\"\"\"\n\n    # Load the public key from the PEM file\n    public_key = RSA.importKey(public_key_pem)\n\n    # Create a cipher object using PKCS1_OAEP padding\n    cipher = PKCS1_v1_5.new(public_key)\n\n    # Encrypt the message\n    encrypted_message = cipher.encrypt(message.encode())\n\n    # Encode the encrypted message in base64 for safe transmission\n    encoded_message = base64.b64encode(encrypted_message).decode()\n\n    return encoded_message\n\nif __name__ == \"__main__\":\n\n    response = requests.get('https://totalconnect2.com/application.config.json')\n\n    if response.ok:\n        config_json = response.json()\n        public_key = config_json[\"AppConfig\"][0][\"tc2APIKey\"]\n        client_id = config_json[\"AppConfig\"][0][\"tc2ClientId\"]\n        #jsonpath_expr = parse('$..langCulture[?(@.LanguageCulture==\"en\")]')\n        locale = 'en-US'\n        #jsonpath_expr = parse(\"$..brandInfo[?(@.BrandName=='totalconnect')].AppID\")\n        appid = 16808\n        \n\n    public_key_pem = '-----BEGIN PUBLIC KEY-----\\n' + public_key + '\\n-----END PUBLIC KEY-----'\n\n    username = \"username\"\n    encrypted_username = encrypt_message(username, public_key_pem)\n\n    password = \"password\"\n    encrypted_password = encrypt_message(password, public_key_pem)\n\n    data = {\n        'username': encrypted_username,\n        'password': encrypted_password,\n        'grant_type': 'password',\n        'client_id': client_id,\n        'locale': locale,\n    }\n\n\n    response = requests.post(\n        url='https://rs.alarmnet.com/TC2API.Auth/token',\n        data=data\n    )\n\n    if response.ok:\n        response_json = response.json()\n        if 'access_token' in response_json:\n            jwt_token = jwt.decode(response_json['access_token'], algorithms=\"HS256\", options={\"verify_signature\": False})\n            ids = jwt_token[\"ids\"]\n            session_id = ids.split(';',1)[0]\n\n\n    print(session_id)\n\n    data = f'<soap:Envelope xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:soap=\"http://schemas.xmlsoap.org/soap/envelope/\"><soap:Body><GetSessionDetails xmlns=\"https://services.alarmnet.com/TC2/\"><SessionID>{session_id}</SessionID><ApplicationID>{appid}</ApplicationID><ApplicationVersion>3.40.1.34</ApplicationVersion></GetSessionDetails></soap:Body></soap:Envelope>'\n    \n    response = requests.post(\n        url='https://rs.alarmnet.com/TC21API/TC2.asmx',\n        data=data,\n        headers={\n            'Content-Type': 'text/xml; charset=utf-8',\n            'SOAPAction': 'https://services.alarmnet.com/TC2/GetSessionDetails',\n        }\n    )\n\n    if response.ok:\n        print(response.text)\n```\nI'm also having this issue, hopefully it can get resolved.\naustinmroczek\u00a0thank you for your contribution!\n\nI tried to contact\u00a0my alarm monitoring provider and their \"tech\" has no idea what I'm\u00a0talking about.\nPer someone's suggestion\u00a0I think it would be very helpful if we start complaining\u00a0to our providers.\n\nDoes anybody have some good explanation that I can say / send to my provider about what\u00a0Resideo needs to do in order to restore\u00a0Home Assistant access\u00a0?\nI suppose if enough monitoring companies report that they are losing customers due to a loss of HA connectivity to TC2.0, Honeywell Resido may fix the issue.\n\nI would think that Nabu Casa would take action and advise us if loss of connectivity is due to a fee dispute or something else.\n\nNabu Casa seeks fee-free services on our behalf, but have been unsuccessful with MyQ and others, which devalues HA and TC2.0 for us automation enthusiasts.\n\nPersonally, a loss of TC2.0 connectivity leaves a big hole in my HA.\nI also contacted my alarm monitoring company and they stated they had no knowledge or previous reports of any issues. They promised to reach out to Honeywell's support team and let me know what they find out.\nSame issue, unable to connect.\nNothing new to contribute, but I am having the same issue and will report this to my monitoring company in hopes that Residio resolves this for us\nAlmost sounds like a single well written email that we can all send to our providers would make sense in this type of scenario. Most of our providers will not have any clue what we are even talking about, so something that explains the issue with technical support that can be sent in writing would be the way to go. I don't have the technical understanding of the issue to explain it, but happy to help anyway I can. This integration has been the primary reason I have been using home assistant!\n\nPersonally when my installers came in they had no idea how I was doing what I was doing when I showed them I already had Total Connect in HomeKit before it was supported. In fact, the last \"tech\" I had out for an unrelated issue didn't even know about the homekit integration (my original panel failed and had to be replaced).\nGreat idea!\n> This script will get the session id which I hope can then be used for the other SOAP calls\n\nWhat we really need is to listen for the ApplicationId in the LoginAnd.... call going from the web/app to the server.  There are four similar calls, not sure which one the web or app use.  There are also Authenticate... calls that are a possibility.  See https://rs.alarmnet.com/TC21api/tc2.asmx \n\n\nI had contacted resideo in 2020 for an issue related to TC Android mobile app and have their email addresses (not generic one). If someone is writing a detailed technical email, I can share their email ids. Not posting here to avoid spamming their mailboxes.\nAt this point, the biggest thing we need is open communication with Resideo/Honeywell, specifically whoever manages TotalConnect 2.0. Even if the answers they give aren't what we want (i.e. they are purposely blocking us), it would be better than guessing what's happening on the server end.\n\nIf folks are willing to try to contact Resideo, or their alarm company, please ask them to reach out to me. My discord is austinm6748 and email is austin@mroczek.org \n\nI sent the following to my alarm company. \n\n> I have monthly AlarmNet / TotalConnect service with account #########.  One of the reasons I use your service is because I could use TotalConnect to tie my alarm into my home automation system called Home Assistant (https://www.home-assistant.io/).  However, there seems to be a problem with the TotalConnect servers that is preventing use with Home Assistant.  See https://github.com/home-assistant/core/issues/136340\n> \n> I contacted Resideo / TotalConnect but all they would tell me is:\n> \n> \"All of the security panels/systems along the TC2.0 app are not supported by this channel. These are only sold, installed and supported, by professional security providers/installers. For technical information, account management or general documentation, you can use our tool: https://www.resideo.com/us/en/find-a-pro/ To find a local security provider/installer that carries/services and supports this products.\u201d\n> \n> Thank you\n\n\n> If someone is writing a detailed technical email, I can share their email ids.\n\nMy discord is austinm6748 and email is [austin@mroczek.org](mailto:austin@mroczek.org)\nI also e-mailed my provider.  Definitely couldn't hurt.\nI don't think the installers know anything about it.  I once had HA report a tamper issue with one of my smoke detectors, when TC2 and their own system showed everything was fine.  Service rep came out, and sure enough, the cover had not been properly put back on during the last maintenance.  He was stunned that 3rd party software picked that up when nothing else did.  I showed him HA, and he had never heard of it before.  \nToday I went into the TC2 app, and under the \"About\" setting, there's a \"provide feedback\" option that's asks for your email address and what comments you have.   I've received responses through this before.  I asked if they made any recent changes to restrict their API to limit 3rd party applications.  I referenced Home Assistant and said several hundred home automation enthusiasts were locked out and trying to figure out what happened.  I also asked that if they did change their API policy, they should communicate that.  We'll see what happens.  I'll report back if I get a response.  \nGood tip!  I sent this thru the TC2.0 Feedback link:\n\"Are there any recent changes to restrict the TC2.0 API to limit 3rd party applications?  I have been using Home Assistant with TC2.0 for a long time now, and I, along with several hundred home automation enthusiasts, are locked out and trying to figure out what happened.\n\nIf a change was made to TC2.0 to prevent Home Assistant from connecting to the TC2.0 API, please communicate this.\"\nI also sent feedback thru TC2.0 app and emailed to my dealer AlarmGrid. Will post if any reply shows-up. Its time to build something similar to \"ratgdo for MyQ garage door openers\". I have an app called L5100 Connect which connects to my Lynx panel directly over the same wifi network and perform all activities and display sensors' status without going thru cloud.\nSame issue. I e-mailed Resideo and Alarm Grid and provided the output directly from my simple Python program using the Total_connect_client library.\n\nclient = TotalConnectClient(username, password)\nTraceback (most recent call last):\n  File \"<python-input-5>\", line 1, in <module>\n    client = TotalConnectClient(username, password)\n  File \"/usr/local/lib/python3.13/site-packages/total_connect_client/client.py\", line 100, in __init__\n    self.authenticate()\n    ~~~~~~~~~~~~~~~~~^^\n  File \"/usr/local/lib/python3.13/site-packages/total_connect_client/client.py\", line 309, in authenticate\n    response = self.request(\n        operation_name,\n        (self.username, self.password, self.API_APP_ID, self.API_APP_VERSION),\n    )\n  File \"/usr/local/lib/python3.13/site-packages/total_connect_client/client.py\", line 246, in request\n    self._raise_for_retry(response)\n    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^\n  File \"/usr/local/lib/python3.13/site-packages/total_connect_client/client.py\", line 159, in _raise_for_retry\n    rc = _ResultCode.from_response(response)\n  File \"/usr/local/lib/python3.13/site-packages/total_connect_client/const.py\", line 164, in from_response\n    raise ServiceUnavailable(\n        f\"Server returned empty response, check server status at {STATUS_URL}\"\n    ) from None\ntotal_connect_client.exceptions.ServiceUnavailable: Server returned empty response, check server status at https://status.resideo.com/\n\n@brownbloodspider thanks for the contacts.  I have sent a detailed email describing the problem and asking how we can help restore service. I hope we'll get feedback soon.  \n\nI will be disconnected most of Sunday and Monday.  I will not be able to post an update until very late Monday night. \n> Its time to build something similar to \"ratgdo for MyQ garage door openers\".\n\nI agree in principle, but alarm panels are significantly more complicated and it would be a large effort. If we can't get this server problem resolved, I'll certainly be thinking about this option.\n\n\n      \r\n  \r\n\r\n Wouldn't konnected be the alternative? I've been looking at it but don't know if the integration kit would work\r\n  \r\n  \r\n  \r\n  \r\n  \r\n  \r\n  \r\n\r\n  \r\n  \r\n>   \r\n> On Jan 25, 2025 at 4:25 PM,  <Austin Mroczek ***@***.***)>  wrote:\r\n>   \r\n>   \r\n>   \r\n>\r\n>\r\n>\r\n>   \r\n> >   \r\n> >\r\n> > Its time to build something similar to \"ratgdo for MyQ garage door openers\".\r\n> >\r\n> >   \r\n>   \r\n>\r\n> I agree in principle, but alarm panels are significantly more complicated and it would be a large effort. If we can't get this server problem resolved, I'll certainly be thinking about this option.\r\n>\r\n>   \r\n>\r\n> \u2014\r\n>  Reply to this email directly,   view it on GitHub (https://github.com/home-assistant/core/issues/136340#issuecomment-2614118888), or   unsubscribe (https://github.com/notifications/unsubscribe-auth/AFNKUWSOMVLOJ7XOGRVB5PT2MQFN3AVCNFSM6AAAAABVXNHF7WVHI2DSMVQWIX3LMV43OSLTON2WKQ3PNVWWK3TUHMZDMMJUGEYTQOBYHA).\r\n>  You are receiving this because you commented.Message ID:  ***@***.***>\r\n>\r\n>   \r\n>   \r\n  \r\n  \r\n     \n> Wouldn't konnected be the alternative?\n\nIt may be a good starting point, but it seems to only be for wired alarm systems. Many of the panels used here have primarily wireless sensors. \n> > Wouldn't konnected be the alternative?\n> \n> It may be a good starting point, but it seems to only be for wired alarm systems. Many of the panels used here have primarily wireless sensors. \n\nYeah that's true, I've got both wired and wireless sensors, it would probably work for arming/disarming but not for monitoring zones right?\nHave the same issue. I also submitted Feedback in the TC app. \n\nI have three partitions in my setup and prior to this issue any status updates on arm/disarm etc would not update in HA for partitions 2 and 3 until I reloaded the TC Integration in HA to get the latest status on the partitions. I should probably open a new issue, but I thought I would share the issue here as well.\n\nThanks for all your efforts @austinmroczek. It's appreciated. \n> Wouldn't konnected be the alternative? I've been looking at it but don't know if the integration kit would work\n> [\u2026](#)\n\nI had no idea this existed! This might be exactly what I've been wanting so thank you for bringing this up.\n> > This script will get the session id which I hope can then be used for the other SOAP calls\n> \n> What we really need is to listen for the ApplicationId in the LoginAnd.... call going from the web/app to the server. There are four similar calls, not sure which one the web or app use. There are also Authenticate... calls that are a possibility. See https://rs.alarmnet.com/TC21api/tc2.asmx\n\n@austinmroczek, tracing through the HTTP requests made by the web app I don't see any `LoginAnd...` SOAP calls anymore. Looks like there's a new separate non-SOAP endpoint (https://rs.alarmnet.com/TC2API.Auth/token) that returns a JWT with a SessionID (as detailed in https://github.com/home-assistant/core/issues/136340#issuecomment-2613746391) and then that is passed back in with each SOAP API call.\n\nWould it be sufficient to drop @thor0215's code into the `authenticate` call in `total_connect_client.client` here and just set the token here: https://github.com/craigjmidwinter/total-connect-client/blob/master/total_connect_client/client.py#L320 ? I'll try it out a bit later\n> I also sent feedback thru TC2.0 app and emailed to my dealer AlarmGrid. Will post if any reply shows-up. Its time to build something similar to \"ratgdo for MyQ garage door openers\". I have an app called L5100 Connect which connects to my Lynx panel directly over the same wifi network and perform all activities and display sensors' status without going thru cloud.\n\n@sambeetm please share the info on the app w/o going to the cloud ?\n@austinmroczek I have a PR that I think fixes the issue: https://github.com/craigjmidwinter/total-connect-client/pull/243\nHas there been any update on this?\n> Has there been any update on this?\n\nhttps://github.com/craigjmidwinter/total-connect-client/pull/243\nhttps://github.com/craigjmidwinter/total-connect-client/issues/245\nhttps://github.com/craigjmidwinter/total-connect-client/pull/246\nNot that it matters, but for what it is worth, this is the response I got from AlarmGrid:\n\n> Hello Daniel,\n> \n> Resideo has been made aware of this issue and have reported it to engineering. They are currently investigating and working towards resolving this issue.\n> \n> We will provide an update once we have more information to share.\n> \n> Thank you!\nOnce this is pushed, will we need to reboot the integration or will it push to us automatically?\nHere's the status as of Monday night.\n\n**Summary:** Resideo seems to be turning off pieces of the old SOAP API (which we currently use) in favor a new API. We have to adapt all of our code accordingly.  We have a working fix that I hope to have in Home Assistant in the coming days.  However, depending on how quickly other pieces of the old API are turned off, other issues may pop up as we race to change all of the code to the new API.\n\n**Details:**\n- Someone in the TotalConnect team at Resideo responded to my email, but they pushed the issue to others and are awaiting their response. Hopefully we'll hear from them soon.\n- Thanks to the efforts of @thor0215 and @db3000 and help from some others, we discovered that the new API provided by Resideo allows us to log in and operate alarms.  \n- A basic fix is in place in total_connect_client version 2025.1.3 which is available on [pypi](https://pypi.org/project/total-connect-client/).  While the code is working, we don't have thorough or long term testing, so this \"hot fix\" likely has some hidden problems.  I can see panel status and arm and disarm the system from my development environment of Home Assistant.\n- I'm still working to get the new code pulled into Home Assistant so a simple update will fix the problem.  The new code requires some updates to our automatic testing regime which is taking me a bit longer than I wanted.  I hope to have an update pushed into Home Assistant soon, maybe Tuesday.  \n- Once an update is pulled into Home Assistant (either a version 2025.1.5 or 2025.2) users would just need to update and restart, and then it should work.\n- Brave souls could manually install the new version of total_connect_client in their Home Assistant.  If you know how to do that, it would be great to have some beta testers trying to find any issues. I'm purposely not explaining that here, because it will definitely break your warranty.\n- We hypothesize this whole issue is because Resideo is deprecating pieces of the old SOAP API in favor of the new API. Hopefully communication with Resideo will confirm this, or tell us what is actually going on.\n- Assuming our hypothesis is correct, Resideo may be in the process of deprecating other pieces we have not yet discovered, so other things may be broken or break in the near future.\n- We will move as quickly as we can to transition to fully transition to the new API. We will have to balance going fast against taking the time for thorough testing.\n\nI plan to post another update Tuesday night.\n\n", "created_at": "2025-01-29T00:55:57Z"}
